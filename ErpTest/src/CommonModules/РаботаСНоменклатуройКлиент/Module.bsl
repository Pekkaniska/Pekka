////////////////////////////////////////////////////////////////////////////////
// Подсистема "Работа с номенклатурой".
// ОбщийМодуль.РаботаСНоменклатуройКлиент.
////////////////////////////////////////////////////////////////////////////////

#Область ПрограммныйИнтерфейс

// Процедура, вызываемая перед закрытием формы номенклатуры, для установки значений технических реквизитов.
//
// Параметры:
//  Форма				 - УправляемаяФорма - форма номенклатуры.
//  Отказ				 - Булево - признак отказа.
//  ЗавершениеРаботы	 - Булево - признак завершения работы.
//  ТекстПредупреждения	 - Строка - текст предупреждения.
//  СтандартнаяОбработка - Булево - признак стандартной обработки закрытия.
//
Процедура ПередЗакрытиемФормыНоменклатуры(Форма, 
			Отказ, 
			ЗавершениеРаботы, 
			ТекстПредупреждения, 
			СтандартнаяОбработка) Экспорт
			
	Если Не Форма.РаботаСНоменклатурой_СервисДоступен Тогда
		Возврат;
	КонецЕсли;		
			
	Если Не Форма.РаботаСНоменклатурой_ЭтоЗаписьОбъекта Тогда
		Возврат;
	КонецЕсли;
	
	Если Не РаботаСНоменклатуройСлужебныйКлиентСервер.БудутЗагружатьсяХарактеристики(Форма) Тогда
		Возврат;
	КонецЕсли;	
	
	Отказ = Истина;
	
	СтандартнаяОбработка = Ложь;
	
	Форма.РаботаСНоменклатурой_ЗакрытьФормуПослеСозданияОбъектов = Истина;
	
КонецПроцедуры

// Процедура вызывается после записи номенклатуры. Запускает длительную операцию для загрузки характеристик номенклатуры.
//
// Параметры:
//  Форма	 - УправляемаяФорма - форма номенклатуры.
//
Процедура ПослеЗаписиФормаНоменклатурыПродолжение(Форма) Экспорт
	
	ПараметрыСоздания = РаботаСНоменклатуройСлужебныйКлиентСервер.ПараметрыЗагрузкиХарактеристик();
	
	ПараметрыСоздания.Номенклатура                = Форма.РаботаСНоменклатурой_СсылкаНаОбъект;
	ПараметрыСоздания.ИдентификаторыХарактеристик = Форма.РаботаСНоменклатурой_ИдентификаторыХарактеристик.ВыгрузитьЗначения();
	ПараметрыСоздания.ЗагружатьВсеХарактеристики  = Форма.РаботаСНоменклатурой_РежимЗагрузкиХарактеристик = "Все";
	
	Оповещение = Новый ОписаниеОповещения("ЗагрузитьХарактеристикиЗавершение", ЭтотОбъект, Новый Структура("Форма", Форма));
	
	ЗагрузитьХарактеристики(Оповещение, ПараметрыСоздания, Форма);
	
КонецПроцедуры

// Открытие формы подбора по штрихкодам.
//
// Параметры:
//  ПараметрыФормы		 - Структура -          параметры формы. см. ПараметрыФормыПодбораНоменклатурыПоШтрихкодам.
//  Владелец			 - УправляемаяФорма -   владелец формы.
//  ОповещениеОЗакрытии	 - ОписаниеОповещения - описание оповещения о закрытии.
//
Процедура ОткрытьФормуПодбораНоменклатурыПоШтрихкодам(ПараметрыФормы, 
			Владелец = Неопределено, ОповещениеОЗакрытии = Неопределено) Экспорт
	
	ОценкаПроизводительностиКлиент.НачатьЗамерВремени(Истина,
		"ОбщийМодуль.РаботаСНоменклатуройКлиент.ПоискНоменклатурыПоШтрихкоду");
		
	ОткрытьФорму("Обработка.РаботаСНоменклатурой.Форма.ПоискНоменклатурыПоШтрихкоду", 
		ПараметрыФормы, Владелец, Новый УникальныйИдентификатор, , , ОповещениеОЗакрытии);
		
КонецПроцедуры

// Функция - Параметры формы подбора номенклатуры по штрихкодам
// 
// Возвращаемое значение:
//  Структура - 
//   Ключи:
//    * НеизвестныеШтрихкоды                - Массив - штрихкоды для отработки (Строка).
//    * ДействияСНеизвестнымиШтрихкодами    - Строка - описание действие, которое необходимо выполнить с неизвестными штрихкодами.
//                                                     Возможные значения: "ЗарегистрироватьПеренестиВДокумент", "ТолькоЗарегистрировать".
//
Функция ПараметрыФормыПодбораНоменклатурыПоШтрихкодам() Экспорт
	
	Результат = Новый Структура;
	
	Результат.Вставить("НеизвестныеШтрихкоды",             Новый Массив);
	Результат.Вставить("ДействияСНеизвестнымиШтрихкодами", "ЗарегистрироватьПеренестиВДокумент");
	
	Возврат Результат;
	
КонецФункции

// После записи формы номенклатуры.
//
// Параметры:
//  Форма	 - УправляемаяФорма - форма номенклатуры.
//
Процедура ПослеЗаписиФормаНоменклатуры(Форма) Экспорт
	
	Если Не Форма.РаботаСНоменклатурой_СервисДоступен Тогда
		Возврат;
	КонецЕсли;
	
	Если ЗначениеЗаполнено(Форма.РаботаСНоменклатурой_АдресДанныхЗаполнения) Тогда
		ЗаполнитьПараметрыЗакрытия(Форма);
	КонецЕсли;
	
	Если Не РаботаСНоменклатуройСлужебныйКлиентСервер.БудутЗагружатьсяХарактеристики(Форма) Тогда
		Возврат;
	КонецЕсли;
	
	Форма.РаботаСНоменклатурой_ЭтоЗаписьОбъекта = Истина;
	
	Форма.ПодключитьОбработчикОжидания("Подключаемый_ПослеЗаписиРаботаСНоменклатурой", 0.1, Истина);
		
КонецПроцедуры

// Описание оповещений подсистемы при различных действиях.
// 
// Возвращаемое значение:
//  Структура - структура с именами оповещений.
//
Функция ОписаниеОповещенийПодсистемы() Экспорт
	
	Результат = Новый Структура;

	Результат.Вставить("ЗагрузкаНоменклатуры",   "РаботаСНоменклатурой_ЗагрузкаНоменклатуры"); 
	Результат.Вставить("ЗагрузкаКатегорий",      "РаботаСНоменклатурой_ЗагрузкаКатегорий");
	Результат.Вставить("ЗагрузкаХарактеристики", "");
	
	Возврат Результат;
	
КонецФункции

// Поиск номенклатуры в сервисе 1С:Номенклатура по штрихкоду.
//  В случае успеха открывается карточка номенклатуры, из которой можно загрузить номенклатуру
//  в информационную базу.
//
// Параметры:
//  ШтрихКод			 - Строка	 - строка штрихкода.
//  Форма				 - УправляемаяФорма - форма владелец.
//  ОповещениеОЗакрытии	 - ОписаниеОповещения - оповещение о закрытии окна. 
//                         При закрытии формы карточки номенклатуры возвращается структура с ключом: 
//                         СозданнаяНоменклатура - массив ссылок на созданную номенклатуру.
//
Процедура НайтиНоменклатуруПоШтрихкодуВСервисе(ШтрихКод, 
			Форма = Неопределено, ОповещениеОЗакрытии = Неопределено) Экспорт
	
	Если Не ДоступнаФункциональностьПодсистемы() Тогда
		Возврат;
	КонецЕсли;
	
	ИспользоватьПоискПоШтрихкоду 
		= РаботаСНоменклатуройСлужебныйВызовСервера.НастройкиПодсистемы().ИспользоватьПоискПоШтрихкодуВСервисе;
		
	Если НЕ ИспользоватьПоискПоШтрихкоду Тогда
		Возврат;
	КонецЕсли;
	
	ИдентификаторыНоменклатуры 
		= РаботаСНоменклатуройСлужебныйВызовСервера.ПолучитьДанныеПоНоменклатуреПоШтрихкоду(ШтрихКод);
	
	Если Не ЗначениеЗаполнено(ИдентификаторыНоменклатуры) Тогда
		ПоказатьОповещениеПользователя(
			НСтр("ru = 'Номенклатура не найдена'"),,
			СтрШаблон(НСтр("ru = 'По штрихкоду %1 номенклатура не найдена.'"), ШтрихКод),,
			СтатусОповещенияПользователя.Информация);
		Возврат;
	КонецЕсли;
	
	ОткрытьФормуКарточкиНоменклатуры(ИдентификаторыНоменклатуры, Форма, ОповещениеОЗакрытии, ШтрихКод);
		
КонецПроцедуры

// Очистка данных объекта сервиса 1С:Номенклатура на форме.
//
// Параметры:
//  Форма - УправляемаяФорма - форма владелец.
//
Процедура НажатиеОчиститьКатегорию(Форма) Экспорт
	
	Форма.РаботаСНоменклатурой_ОбъектСервисаИзменен = Истина;
	
	Форма.ТекущийЭлемент = Форма.Элементы.ПредставлениеКатегорииСервиса;
	
	РаботаСНоменклатуройСлужебныйКлиентСервер.СброситьДанныеОбъектаСервиса(
		Форма,
		Форма.Элементы.ПредставлениеКатегорииСервиса,
		РаботаСНоменклатуройСлужебныйКлиентСервер.ПредставлениеПустойКатегории());
	
КонецПроцедуры

// Очистка данных объекта сервиса 1С:Номенклатура на форме.
//
// Параметры:
//  Форма - УправляемаяФорма - форма владелец.
//
Процедура НажатиеОчиститьНоменклатуру(Форма) Экспорт
	
	Форма.РаботаСНоменклатурой_ОбъектСервисаИзменен = Истина;
	
	Форма.ТекущийЭлемент = Форма.Элементы.ПредставлениеНоменклатурыСервиса;
	
	РаботаСНоменклатуройСлужебныйКлиентСервер.СброситьДанныеОбъектаСервиса(
		Форма,
		Форма.Элементы.ПредставлениеНоменклатурыСервиса,
		РаботаСНоменклатуройСлужебныйКлиентСервер.ПредставлениеПустойНоменклатуры());
		
КонецПроцедуры

// Открытие окна выбора объекта сервиса.
//
// Параметры:
//  Форма				 - УправляемаяФорма	 - форма владелец.
//  Элемент				 - ПолеФормы		 - элемент с представлением объекта сервиса.
//  СтандартнаяОбработка - Булево			 - флаг стандартной обработки.
//  ЗаполнятьПриВыборе	 - Булево			 - Истина, если при выборе объекта сервиса будет заполняться объект базы.
//  ОповещениеОЗакрытии	 - ОписаниеОповещения - оповещение о закрытии окна. 
//
Процедура ВыбратьОбъектСервиса(Форма, 
			Элемент, 
			СтандартнаяОбработка, 
			ЗаполнятьПриВыборе = Ложь, 
			ОповещениеОЗакрытии = Неопределено) Экспорт 
	
	СтандартнаяОбработка = Ложь;
	
	ПараметрыОбработчика = Новый Структура;
	ПараметрыОбработчика.Вставить("Форма",       Форма);
	ПараметрыОбработчика.Вставить("ИмяЭлемента", Элемент.Имя);
	
	Если Форма.РаботаСНоменклатурой_ТипОбъекта = "ВидНоменклатуры" Тогда
		ОткрытьФормуВыбораКатегорий(Форма, ПараметрыОбработчика, ЗаполнятьПриВыборе, ОповещениеОЗакрытии);
						
	ИначеЕсли Форма.РаботаСНоменклатурой_ТипОбъекта = "Номенклатура" Тогда
		ОткрытьФормуВыбораНоменклатуры(Форма, ПараметрыОбработчика, ОповещениеОЗакрытии)
		
	КонецЕсли;
	
КонецПроцедуры

// Обработка нажатия кнопки выбора режима обновления объекта базы.
//
// Параметры:
//  Форма							 - УправляемаяФорма	 - форма владелец.
//  ДанныеИнтерактивногоЗаполнения	 - Строка			 - см. РаботаСНоменклатурой.ПодготовитьДанныеДляИнтерактивногоЗаполнения.
//  ОповещениеОЗакрытии				 - ОписаниеОповещения	 - оповещение о закрытии окна.
//
Процедура НажатиеРежимОбновления(Форма, ДанныеИнтерактивногоЗаполнения, ОповещениеОЗакрытии) Экспорт 
	
	СсылкаНаОбъект = Форма.РаботаСНоменклатурой_СсылкаНаОбъект;
	
	ПараметрыОбработки = Новый Структура();
	
	ПараметрыОбработки.Вставить("Форма",                          Форма);
	ПараметрыОбработки.Вставить("ДанныеИнтерактивногоЗаполнения", ДанныеИнтерактивногоЗаполнения);
	ПараметрыОбработки.Вставить("ОповещениеОЗакрытии",            ОповещениеОЗакрытии);
		
	ОповещениеНажатиеРежимаОбновления = 
		Новый ОписаниеОповещения("ОбработкаОповещенияВыбораРежимаОбновления", ЭтотОбъект, ПараметрыОбработки);
	
	СписокРежимов = Новый СписокЗначений;
	СписокРежимов.Добавить("РучноеОбновление", НСтр("ru = 'Ручное обновление'"),, 
		БиблиотекаКартинок.РучноеОбновлениеРаботаСНоменклатурой);
	СписокРежимов.Добавить("АвтоматическоеОбновление", НСтр("ru = 'Автоматическое обновление'"),, 
		БиблиотекаКартинок.АвтоматическоеОбновлениеРаботаСНоменклатурой);
	
	Если Форма.РаботаСНоменклатурой_РежимПредставленияОбъектаСервиса = "Гиперссылка" Тогда
		
		Если Форма.РаботаСНоменклатурой_ОбновляетсяАвтоматически Тогда
			ВыполнитьОбработкуОповещения(ОповещениеНажатиеРежимаОбновления, СписокРежимов[1]);	
		Иначе
			ВыполнитьОбработкуОповещения(ОповещениеНажатиеРежимаОбновления, СписокРежимов[0]);	
		КонецЕсли;
		
	Иначе		
		Форма.ПоказатьВыборИзМеню(ОповещениеНажатиеРежимаОбновления, СписокРежимов, Форма.Элементы.РежимОбновления);
	КонецЕсли;
	
КонецПроцедуры

// Обработка нажатия встраиваемых гиперссылок.
//
// Параметры:
//  Форма				 - УправляемаяФорма	 - форма объекта.
//  Элемент				 - Элемент			 - элемент формы.
//  СтандартнаяОбработка - Булево			 - флаг стандартной обработки.
//  ОповещениеОЗакрытии	 - ОписаниеОповещения - оповещение о закрытии окна. 
//
Процедура НажатиеГиперссылки(Форма, Элемент, СтандартнаяОбработка, ОповещениеОЗакрытии) Экспорт
	
	Если Элемент.Имя = "РежимОбновления" Тогда
		
		СтандартнаяОбработка = Ложь;
		
		РежимыОбновления = Новый СписокЗначений;
		
		РежимыОбновления.Добавить("вручную", НСтр("ru = 'Обновлять вручную'"), 
			НЕ Форма.РаботаСНоменклатурой_ОбновляетсяАвтоматически);
		РежимыОбновления.Добавить("автоматически", НСтр("ru = 'Обновлять автоматически'"), 
			Форма.РаботаСНоменклатурой_ОбновляетсяАвтоматически);
				
		Форма.ПоказатьВыборИзМеню(Новый ОписаниеОповещения("ВыборРежимаОбновления", 
			ЭтотОбъект, Новый Структура("Форма", Форма)), РежимыОбновления);
		
	ИначеЕсли Элемент.Имя = "РаботаСНоменклатурой_ОчиститьОбъектСервиса" Тогда	
		Если Форма.РаботаСНоменклатурой_ТипОбъекта = "Номенклатура" Тогда
			НажатиеОчиститьНоменклатуру(Форма);
		ИначеЕсли Форма.РаботаСНоменклатурой_ТипОбъекта = "ВидНоменклатуры" Тогда
			НажатиеОчиститьКатегорию(Форма);
		КонецЕсли;
	ИначеЕсли Элемент.Имя = "РаботаСНоменклатурой_Характеристики" Тогда	
		
		Оповещение = Новый ОписаниеОповещения("ПослеСопоставленияХарактеристик", 
			ЭтотОбъект, Новый Структура("Форма", Форма));		
		
		ПараметрыФормы = ПараметрыФормыСопоставленияХарактеристик();
		
		ПараметрыФормы.ИдентификаторНоменклатуры       = Форма.РаботаСНоменклатурой_ИдентификаторОбъектаСервиса;
		ПараметрыФормы.Номенклатура                    = Форма.РаботаСНоменклатурой_СсылкаНаОбъект;
		ПараметрыФормы.НаименованиеНоменклатурыСервиса = Форма.РаботаСНоменклатурой_ПредставлениеОбъектаСервиса;
		
		ОткрытьФормуСопоставленияХарактеристик(ПараметрыФормы, Форма, Оповещение);
		
	Иначе
		Если Не ЗначениеЗаполнено(Форма.РаботаСНоменклатурой_ИдентификаторОбъектаСервиса) Тогда
			ВыбратьОбъектСервиса(Форма, Элемент, СтандартнаяОбработка, Ложь, ОповещениеОЗакрытии);
		Иначе
			ОткрытьКарточкуОбъектаСервиса(Форма, Элемент, СтандартнаяОбработка);	
		КонецЕсли;	
	КонецЕсли;
		
КонецПроцедуры

// Открытие формы подбора номенклатуры из сервиса.
//
// Параметры:
//  Форма				 - УправляемаяФорма	- владелец формы.
//  Параметры			 - Структура - параметры формы.
//  ОповещениеОЗакрытии	 - ОписаниеОповещения - оповещение о закрытии формы.
//
Процедура ПодобратьНоменклатуруИзСервиса(Форма = Неопределено, 
			Параметры = Неопределено, ОповещениеОЗакрытии = Неопределено) Экспорт
	
	ОценкаПроизводительностиКлиент.НачатьЗамерВремени(Истина,
		"ОбщийМодуль.РаботаСНоменклатуройКлиент.ПодобратьНоменклатуруИзСервиса");
	
	ОткрытьФормуЗагрузкиНоменклатуры(Параметры, Форма, ОповещениеОЗакрытии);
	
КонецПроцедуры

// Открытие формы подбора категорий из сервиса.
//
// Параметры:
//  Владелец - УправляемаяФорма - владелец формы.
//
Процедура ПодобратьКатегорииИзСервиса(Владелец = Неопределено) Экспорт
	
	ОценкаПроизводительностиКлиент.НачатьЗамерВремени(Истина,
		"ОбщийМодуль.РаботаСНоменклатуройКлиент.ПодобратьКатегорииИзСервиса");
	
	ОткрытьФорму("Обработка.РаботаСНоменклатурой.Форма.ЗагрузкаКатегорий", , Владелец);
	
КонецПроцедуры

// Обработка события ПриИзменении элемента формы, для формирования строки поиска номенклатуры в сервисе.
// Поиск осуществляется для формирования контекстной подсказки в момент заполнения объекта.
//
// Параметры:
//  Форма	 - УправляемаяФорма - форма события.
//  Элемент	 - ПолеФормы - изменяемый элемент формы.
//
Процедура ПриИзмененииСобратьСтрокуПоиска(Форма, Элемент) Экспорт 
	
	СобратьСтрокуПоиска(Форма, Элемент);
	
КонецПроцедуры

// Обработка события ИзменениеТекстаРедактирования элемента формы, для формирования строки поиска номенклатуры в сервисе.
// Поиск осуществляется для формирования контекстной подсказки в момент заполнения объекта.
//
// Параметры:
//  Форма	 - УправляемаяФорма - форма события.
//  Текст	 - Строка - редактируемый текст.
//  Элемент	 - ПолеФормы - изменяемый элемент формы.
//  СтандартнаяОбработка - Булево - флаг стандартной обработки.
//
Процедура ИзменениеТекстаСобратьСтрокуПоиска(Форма, Текст, Элемент, СтандартнаяОбработка) Экспорт 
	
	СтандартнаяОбработка = Ложь;
	
	Если СтрДлина(Текст) < 3 
		И ЗначениеЗаполнено(Текст) Тогда
		
		Возврат;
	КонецЕсли;
	
	СобратьСтрокуПоиска(Форма, Элемент);
	
КонецПроцедуры

// Открытие формы представления объекта сервиса.
//
// Параметры:
//  Форма - УправляемаяФорма - форма владелец.
//  Элемент - ПолеФормы - элемент с представлением объекта сервиса.
//  СтандартнаяОбработка - Булево - флаг стандартной обработки.
//
Процедура ОткрытьКарточкуОбъектаСервиса(Форма, Элемент, СтандартнаяОбработка) Экспорт 
	
	СтандартнаяОбработка = Ложь;
		
	Если Форма.РаботаСНоменклатурой_ТипОбъекта = "ВидНоменклатуры" Тогда // Категория
		
		Если НЕ ЗначениеЗаполнено(Форма.РаботаСНоменклатурой_ИдентификаторыОбъектовСервиса) Тогда
			Возврат;
		КонецЕсли;
				
		ОценкаПроизводительностиКлиент.НачатьЗамерВремени(Истина,
				"ОбщийМодуль.РаботаСНоменклатуройКлиент.ОткрытКарточкуОбъектаСервиса.КатегорииСервиса");
				
		ОткрытьФормуКарточкиКатегории(Форма.РаботаСНоменклатурой_ИдентификаторыОбъектовСервиса, 
			Форма.РаботаСНоменклатурой_СсылкаНаОбъект, Форма, Форма.УникальныйИдентификатор);
		
	ИначеЕсли Форма.РаботаСНоменклатурой_ТипОбъекта = "Номенклатура" Тогда // Номенклатура
		
		Если НЕ ЗначениеЗаполнено(Форма.РаботаСНоменклатурой_ИдентификаторОбъектаСервиса) Тогда
			Возврат;
		КонецЕсли;
		
		ОценкаПроизводительностиКлиент.НачатьЗамерВремени(Истина,
				"ОбщийМодуль.РаботаСНоменклатуройКлиент.ОткрытКарточкуОбъектаСервиса.НоменклатураСервиса");
				
		ОткрытьФормуКарточкиНоменклатуры(
			ОбщегоНазначенияКлиентСервер.ЗначениеВМассиве(Форма.РаботаСНоменклатурой_ИдентификаторОбъектаСервиса), Форма);
		
	КонецЕсли;
	
КонецПроцедуры

// Функция определяет доступность подсистемы.
// 
// Возвращаемое значение:
//  Булево - признак доступности подсистемы.
//
Функция ДоступнаФункциональностьПодсистемы() Экспорт
	
	Возврат РаботаСНоменклатуройСлужебныйВызовСервера.ДоступнаФункциональностьПодсистемы();
	
КонецФункции

// Процедура вызывается после выбора 1С:Номенклатуры из прикладных форм, собирает данные с формы объекта информационной базы
//  и передает в форму заполнения.
//
// Параметры:
//  ДанныеВыбора					 - Структура - идентификатор и наименование объекта сервиса.
//  ДополнительныеПараметры			 - Структура - ссылка на заполняемую номенклатуру и его форму.
//  ДанныеИнтерактивногоЗаполнения	 - Строка	 - см. РаботаСНоменклатурой.ПодготовитьДанныеДляИнтерактивногоЗаполнения.
//  ОповещениеОЗакрытии				 - ОписаниеОповещения - описание оповещения о закрытии формы заполнения.
//
Процедура ОбработкаОповещенияЗакрытиеФормыВыбора(ДанныеВыбора, 
			ДополнительныеПараметры, 
			ДанныеИнтерактивногоЗаполнения, 
			ОповещениеОЗакрытии) Экспорт
	
	Если ДанныеВыбора = Неопределено Тогда
		Возврат;
	КонецЕсли;
	
	Если Не ЗначениеЗаполнено(ДанныеВыбора.ВыбранныеОбъекты) Тогда
		Возврат;
	КонецЕсли;	
		
	Форма = ДополнительныеПараметры.Форма;
	
	Если Форма.РаботаСНоменклатурой_ТипОбъекта = "ВидНоменклатуры" Тогда
		ОбработкаВыбораКатегории(ДанныеВыбора, ДополнительныеПараметры, ДанныеИнтерактивногоЗаполнения, ОповещениеОЗакрытии);
		
	ИначеЕсли Форма.РаботаСНоменклатурой_ТипОбъекта = "Номенклатура" Тогда	
		ОбработкаВыбораНоменклатуры(ДанныеВыбора, ДополнительныеПараметры, ДанныеИнтерактивногоЗаполнения, ОповещениеОЗакрытии);
		
	КонецЕсли;
	
КонецПроцедуры

// Открытие формы сопоставление характеристик информационной базы с характеристиками сервиса.
//
// Параметры:
//  НоменклатураСсылка   - Ссылка - ссылка на номенклатуру.
//  Владелец			 - УправляемаяФорма - форма владелец формы сопоставления.
//  ОповещениеОЗакрытии	 - ОписаниеОповещения - оповещение о закрытии формы.
//
Процедура ОткрытьФормуСопоставленияХарактеристикСервиса(НоменклатураСсылка, 
			Владелец = Неопределено, 
			ОповещениеОЗакрытии = Неопределено) Экспорт
	
	ПараметрыФормы = ПараметрыФормыСопоставленияХарактеристик();		
	
	ПараметрыФормы.Номенклатура = НоменклатураСсылка;
			
	ОткрытьФормуСопоставленияХарактеристик(ПараметрыФормы, Владелец, ОповещениеОЗакрытии);
		
КонецПроцедуры

// Представление сопоставленных характеристик.
//
// Параметры:
//  НоменклатураСсылка	 - Ссылка - ссылка на номенклатуру.
//  ШаблонПредставления	 - Строка - шаблон представления гиперссылки. Шаблон должен включать два маркера подстановки: %1, %2.
//                                  На место маркера %1 будет проставлено количество сопоставленных характеристик, 
//                                  на место маркера %2 будет проставлено общее количество характеристик номенклатуры.
//                                  Если шаблон указан не будет, представление имеет вид: Сопоставлено характеристик: %1 из %2.
// 
// Возвращаемое значение:
//  Строка - представление гиперссылки.
//
Функция ПредставлениеСопоставленныхХарактеристик(НоменклатураСсылка, ШаблонПредставления = "") Экспорт
	
	Возврат РаботаСНоменклатуройСлужебныйВызовСервера.ПредставлениеСопоставленныхХарактеристик(
		НоменклатураСсылка, Неопределено, ШаблонПредставления);
		
КонецФункции

#КонецОбласти

#Область СлужебныйПрограммныйИнтерфейс

#Область ОткрытиеФорм

// Открытие формы сопоставление характеристик
//
// Параметры:
//  ПараметрыФормы		 - Структура - см. ПараметрыФормыСопоставленияХарактеристик.
//  Владелец			 - УправляемаяФорма - форма владелец формы сопоставления.
//  ОповещениеОЗакрытии	 - ОписаниеОповещения - оповещение о закрытии формы.
//
Процедура ОткрытьФормуСопоставленияХарактеристик(ПараметрыФормы, 
			Владелец = Неопределено, 
			ОповещениеОЗакрытии = Неопределено) Экспорт
	
	ОценкаПроизводительностиКлиент.НачатьЗамерВремени(Истина,
		"ОбщийМодуль.РаботаСНоменклатуройКлиент.СопоставитьХарактеристики");

	ОткрытьФорму("Обработка.РаботаСНоменклатурой.Форма.СопоставлениеХарактеристик", ПараметрыФормы, Владелец,,,,ОповещениеОЗакрытии);	
		
КонецПроцедуры

// Открытие формы загрузки/выбора номенклатуры.
//
// Параметры:
//  ПараметрыФормы			 - Структура - См. ПараметрыФормыЗагрузкиНоменклатуры.
//  Владелец				 - УправляемаяФорма - владелец формы.
//  ОповещениеОЗакрытии		 - ОписаниеОповещения - оповещение о закрытии формы.
//  РежимОткрытияОкнаФормы	 - РежимОткрытияОкнаФормы - режим открытия окна формы.
//
Процедура ОткрытьФормуЗагрузкиНоменклатуры(ПараметрыФормы, 
			Владелец = Неопределено, 
			ОповещениеОЗакрытии = Неопределено, 
			РежимОткрытияОкнаФормы = Неопределено) Экспорт
	
	ОткрытьФорму("Обработка.РаботаСНоменклатурой.Форма.ЗагрузкаНоменклатуры", 
		ПараметрыФормы, Владелец,,,, ОповещениеОЗакрытии, РежимОткрытияОкнаФормы);
	
КонецПроцедуры

// Открытие формы карточки номенклатуры.
//
// Параметры:
//  Идентификаторы		 - Массив - массив строк - идентификаторов номенклатуры или массив структур с ключами: 
//                                  ИдентификаторНоменклатуры (Строка), ИдентификаторХарактеристики (Строка),
//                                  если требуется открыть конкретные характеристики номенклатуры.
//  Владелец			 - УправляемаяФорма - владелец формы.
//  ОповещениеОЗакрытии	 - ОписаниеОповещения - оповещение о закрытии формы.
//  СтрокаШтрихкода		 - Строка - строка штрихкода. Используется когда форма вызывается после поиска номенклатуры по штрихкоду.
//
Процедура ОткрытьФормуКарточкиНоменклатуры(Знач Идентификаторы, 
			Владелец = Неопределено,
			ОповещениеОЗакрытии = Неопределено,
			СтрокаШтрихкода = "") Экспорт
			
	ПараметрыФормы = Новый Структура;
		
	ПараметрыФормы.Вставить("ИдентификаторыНоменклатуры", Идентификаторы);
	ПараметрыФормы.Вставить("СтрокаШтрихкода",            СтрокаШтрихкода);
	
	ОткрытьФормуКарточкиНоменклатурыСервиса(ПараметрыФормы, Владелец, ОповещениеОЗакрытии);
		
КонецПроцедуры

#КонецОбласти	

#Область ЗагрузкаДанных

// Загрузка номенклатуры и характеристик сервиса.
//
// Параметры:
//  ОповещениеОЗавершении		 - ОписаниеОповещения - оповещение вызываемое после загрузки номенклатуры.
//  Идентификаторы				 - Массив - массив структур с ключами: ИдентификаторНоменклатуры, ИдентификаторХарактеристики. 
//  Форма						 - УправляемаяФорма - форма, из которой вызывается метод.
//  ДополнительныеПараметры		 - Соответствие - дополнительные параметры создания. 
//  ИдентификаторЗадания		 - УникальныйИдентификатор - идентификатор задания.
//  ДекорацияДлительногоОжидания - ДекорацияФормы - элемент формы, для отображения хода выполнения задания.
//
Процедура ЗагрузитьНоменклатуруИХарактеристики(ОповещениеОЗавершении, 
			Идентификаторы,
			Форма, 
			ДополнительныеПараметры = Неопределено,
			ИдентификаторЗадания = Неопределено, 
			ДекорацияДлительногоОжидания = Неопределено) Экспорт
	
	ДлительнаяОперация = РаботаСНоменклатуройСлужебныйВызовСервера.СоздатьНоменклатуруВФоне(
		Идентификаторы, ДополнительныеПараметры, Форма.УникальныйИдентификатор, ИдентификаторЗадания);
	
	ПараметрыОжидания = ДлительныеОперацииКлиент.ПараметрыОжидания(Форма);
	ПараметрыОжидания.ВыводитьПрогрессВыполнения = Ложь;
	ПараметрыОжидания.ВыводитьОкноОжидания = ДекорацияДлительногоОжидания = Неопределено;
	ПараметрыОжидания.ОповещениеПользователя.Показать = Ложь;
	ПараметрыОжидания.ВыводитьСообщения = Истина;
	
	ИдентификаторЗадания = ДлительнаяОперация.ИдентификаторЗадания;
	ОповещениеОЗавершении.ДополнительныеПараметры.Вставить("ИдентификаторЗадания", ИдентификаторЗадания);
	
	Если Не ДекорацияДлительногоОжидания = Неопределено
		И Не ДлительнаяОперация = Неопределено
		И ДлительнаяОперация.Статус = "Выполняется" Тогда
		ДекорацияДлительногоОжидания.Картинка = БиблиотекаКартинок.ДлительнаяОперация16;
	КонецЕсли;
	
	ПараметрыЗавершения = Новый Структура;
	ПараметрыЗавершения.Вставить("ИдентификаторыНоменклатуры", Идентификаторы);
	ПараметрыЗавершения.Вставить("ОповещениеОЗавершении",      ОповещениеОЗавершении);
	ПараметрыЗавершения.Вставить("Форма",                      Форма);
	
	ДлительнаяОперацияЗавершение = Новый ОписаниеОповещения("ЗагрузитьНоменклатуруПродолжение",
		ЭтотОбъект, ПараметрыЗавершения);
	
	ДлительныеОперацииКлиент.ОжидатьЗавершение(ДлительнаяОперация,
		ДлительнаяОперацияЗавершение,
		ПараметрыОжидания);
	
КонецПроцедуры

#КонецОбласти

#Область ПараметрыОткрытияФорм

// Параметры формы сопоставления характеристик.
// 
// Возвращаемое значение:
//  Структура - параметры открытия формы сопоставления характеристик.
//    Ключи:
//      Номенклатура - Ссылка - ссылка на номенклатуру.
//      ИдентификаторНоменклатуры - Строка - идентификатор номенклатуры сервиса (необязательный).
//      НаименованиеНоменклатурыСервиса - Строка - наименование номенклатуры сервиса (необязательный).
//      ЭтоРежимВыбораХарактеристики - Булево - Истина, если форма должна открываться в режиме выбора характеристик.
//                                              В этом режиме форма позволяет только выбрать не сопоставленную характеристику
//                                              По умолчанию Ложь.
//
Функция ПараметрыФормыСопоставленияХарактеристик() Экспорт
	
	ПараметрыФормы = Новый Структура;
	
	ПараметрыФормы.Вставить("Номенклатура",                    Неопределено);
	ПараметрыФормы.Вставить("ИдентификаторНоменклатуры",       "");
	ПараметрыФормы.Вставить("НаименованиеНоменклатурыСервиса", "");
	ПараметрыФормы.Вставить("ЭтоРежимВыбораХарактеристики",    Ложь);
	
	Возврат ПараметрыФормы;
	
КонецФункции

// Параметры открытия формы подбора номенклатуры
// 
// Возвращаемое значение:
//  Структура - параметры открытия.
//    Ключи:
//      СтрокаПоиска - Строка - строка поиска номенклатуры.
//      ИдентификаторКатегории - Строка - идентификатор категории сервиса.
//      ИдентификаторНоменклатуры - Строка - идентификатор номенклатуры сервиса.
//      РежимПривязкиНоменклатуры - Булево - Истина, если идет привязка номенклатуры к номенклатуре сервиса.
//      РежимВыбораНоменклатуры - Булево - Истина, если форма открывается в режиме выбора.
//      СоздаватьНоменклатуруПриВыборе - Булево - Истина, если необходимо создавать номенклатуру при выборе.
//      ПодтверждатьСозданиеНоменклатуры - Булево - Истина, если требуется запросить подтверждение при создании номенклатуры.
//
Функция ПараметрыФормыЗагрузкиНоменклатуры() Экспорт
	
	Параметры = Новый Структура;
	
	Параметры.Вставить("СтрокаПоиска",              "");
	Параметры.Вставить("ИдентификаторКатегории",    Неопределено); // для позиционировании на категории, при переходе из карточки номенклатуры
	Параметры.Вставить("ИдентификаторНоменклатуры", "");           // используется при открытии формы из уже привязанной номенклатуры
	
	// Параметры выбора.
	
	Параметры.Вставить("РежимПривязкиНоменклатуры",        Ложь);
	Параметры.Вставить("РежимВыбораНоменклатуры",          Ложь);
	Параметры.Вставить("СоздаватьНоменклатуруПриВыборе",   Ложь);
	Параметры.Вставить("ПодтверждатьСозданиеНоменклатуры", Ложь);
	
	Возврат Параметры;
	
КонецФункции

#КонецОбласти

#КонецОбласти

#Область СлужебныеПроцедурыИФункции

#Область ОткрытиеФорм

Процедура ОткрытьФормуКарточкиНоменклатурыСервиса(
			ПараметрыФормы, 
			Владелец = Неопределено, 
			ОповещениеОЗакрытии = Неопределено) Экспорт
			
	Если ТипЗнч(ПараметрыФормы.ИдентификаторыНоменклатуры) <> Тип("Массив") 
		ИЛИ Не ЗначениеЗаполнено(ПараметрыФормы.ИдентификаторыНоменклатуры) Тогда
		
		ВызватьИсключение НСтр("ru = 'Ошибка передачи идентификаторов номенклатуры.'");
	КонецЕсли;	
	
	Если ТипЗнч(ПараметрыФормы.ИдентификаторыНоменклатуры[0]) = Тип("Строка") Тогда	
	
		ПреобразованныйМассив = Новый Массив;
		
		Для каждого ЭлементКоллекции Из ПараметрыФормы.ИдентификаторыНоменклатуры Цикл
			ПреобразованныйМассив.Добавить(Новый Структура("ИдентификаторНоменклатуры, ИдентификаторХарактеристики", ЭлементКоллекции, ""));
		КонецЦикла;
		
		ПараметрыФормы.ИдентификаторыНоменклатуры = ПреобразованныйМассив;
				
	КонецЕсли;

	Уникальность = ПараметрыФормы.ИдентификаторыНоменклатуры[0].ИдентификаторНоменклатуры;
	
	ОткрытьФорму("Обработка.РаботаСНоменклатурой.Форма.КарточкаНоменклатуры", 
		ПараметрыФормы, Владелец, Уникальность,,, ОповещениеОЗакрытии);
		
КонецПроцедуры

Процедура ОткрытьФормуКарточкиКатегории(Знач ИдентификаторыКатегорий, ВидНоменклатуры, 
		Владелец = Неопределено, Уникальность = Неопределено, ОповещениеОЗакрытии = Неопределено) Экспорт
	
	Идентификаторы = Новый СписокЗначений;
	
	Если ТипЗнч(ИдентификаторыКатегорий) = Тип("Строка") Тогда
		Идентификаторы.ЗагрузитьЗначения(ОбщегоНазначенияКлиентСервер.ЗначениеВМассиве(ИдентификаторыКатегорий));	
	ИначеЕсли ТипЗнч(ИдентификаторыКатегорий) = Тип("Массив") Тогда	
		Идентификаторы.ЗагрузитьЗначения(ИдентификаторыКатегорий);	
	ИначеЕсли ТипЗнч(ИдентификаторыКатегорий) = Тип("СписокЗначений") Тогда	
		Идентификаторы = ИдентификаторыКатегорий;
	КонецЕсли;
	
	ПараметрыФормы = Новый Структура;
	
	ПараметрыФормы.Вставить("ИдентификаторыКатегорий", Идентификаторы);
	
	Если ВидНоменклатуры <> Неопределено Тогда
		ПараметрыФормы.Вставить("ВидНоменклатуры", ВидНоменклатуры);
	КонецЕсли;
	
	ОткрытьФорму("Обработка.РаботаСНоменклатурой.Форма.КарточкаКатегории", 
		ПараметрыФормы, Владелец, Уникальность,,, ОповещениеОЗакрытии);
	
КонецПроцедуры

Процедура ОткрытьФормуЗаполненияВидаНоменклатуры(ПараметрыФормы, 
			Владелец = Неопределено, ОповещениеОЗакрытии = Неопределено) Экспорт
	
	ИдентификаторыКатегорий = ПараметрыФормы.ИдентификаторыКатегорий;
	
	Идентификаторы = Новый СписокЗначений;
	
	Если ТипЗнч(ИдентификаторыКатегорий) = Тип("Строка") Тогда
		Идентификаторы.ЗагрузитьЗначения(ОбщегоНазначенияКлиентСервер.ЗначениеВМассиве(ИдентификаторыКатегорий));	
	ИначеЕсли ТипЗнч(ИдентификаторыКатегорий) = Тип("Массив") Тогда	
		Идентификаторы.ЗагрузитьЗначения(ИдентификаторыКатегорий);	
	ИначеЕсли ТипЗнч(ИдентификаторыКатегорий) = Тип("СписокЗначений") Тогда	
		Идентификаторы = ИдентификаторыКатегорий;		
	КонецЕсли;
	
	ПараметрыФормы.Вставить("ИдентификаторыКатегорий", Идентификаторы);
	
	ОткрытьФорму("Обработка.РаботаСНоменклатурой.Форма.ЗаполнениеВидаНоменклатуры", 
		ПараметрыФормы, Владелец,,,, ОповещениеОЗакрытии);
	
КонецПроцедуры

Процедура ОткрытьФормуПодбораХарактеристик(ИдентификаторНоменклатуры, 
			АдресДанныхНоменклатуры, 
			Знач ИдентификаторыХарактеристик, 
			ЭтоРежимПросмотра = Ложь, 
			Владелец = Неопределено, 
			ОповещениеОЗакрытии = Неопределено) Экспорт
	
	ОценкаПроизводительностиКлиент.НачатьЗамерВремени(Истина,
		"ОбщийМодуль.РаботаСНоменклатуройКлиент.ПодобратьХарактеристики");
	
	ПараметрыФормы = Новый Структура;
	
	Если ЗначениеЗаполнено(ИдентификаторыХарактеристик) Тогда
		
		Если ЭтоАдресВременногоХранилища(ИдентификаторыХарактеристик) Тогда
			ИдентификаторыХарактеристик = ПолучитьИзВременногоХранилища(ИдентификаторыХарактеристик);
		КонецЕсли;
		
		Если ТипЗнч(ИдентификаторыХарактеристик) = Тип("Массив") Тогда
			Идентификаторы = Новый СписокЗначений;
			Идентификаторы.ЗагрузитьЗначения(ИдентификаторыХарактеристик);
			ПараметрыФормы.Вставить("ИдентификаторыХарактеристик", Идентификаторы);
		Иначе
			ПараметрыФормы.Вставить("ИдентификаторыХарактеристик", ИдентификаторыХарактеристик);
		КонецЕсли;
		
	КонецЕсли;
	
	ПараметрыФормы.Вставить("ИдентификаторНоменклатуры", ИдентификаторНоменклатуры);
	ПараметрыФормы.Вставить("АдресДанныхНоменклатуры",   АдресДанныхНоменклатуры);
	ПараметрыФормы.Вставить("ЭтоРежимПросмотра",         ЭтоРежимПросмотра);
	
	ОткрытьФорму("Обработка.РаботаСНоменклатурой.Форма.ПодборХарактеристик", ПараметрыФормы, Владелец,,,,ОповещениеОЗакрытии);
	
КонецПроцедуры

Процедура ОткрытьФормуВыбораКатегорий(Форма, ПараметрыОбработчика, ЗаполнятьПриВыборе, ОповещениеОЗакрытии)
	
	ОценкаПроизводительностиКлиент.НачатьЗамерВремени(Истина,
		"ОбщийМодуль.РаботаСНоменклатуройКлиент.ПодобратьКатегорииИзСервиса");
	
	ОбщегоНазначенияКлиентСервер.ДополнитьСтруктуру(ОповещениеОЗакрытии.ДополнительныеПараметры, ПараметрыОбработчика);
		
	ПараметрыФормы = Новый Структура;	
		
	ПараметрыФормы.Вставить("РежимВыбораКатегорий",             Истина);
	ПараметрыФормы.Вставить("ИдентификаторыВыбранныхКатегорий", Форма.РаботаСНоменклатурой_ИдентификаторыОбъектовСервиса);
	ПараметрыФормы.Вставить("ЗаполнятьПриВыборе",               ЗаполнятьПриВыборе);
	
	ОткрытьФорму("Обработка.РаботаСНоменклатурой.Форма.ЗагрузкаКатегорий"
		, ПараметрыФормы, Форма, Форма.УникальныйИдентификатор,,, ОповещениеОЗакрытии, РежимОткрытияОкнаФормы.БлокироватьОкноВладельца);
	
КонецПроцедуры

Процедура ОткрытьФормуВыбораНоменклатуры(Форма, ПараметрыОбработчика, ОповещениеОЗакрытии)
	
	ОценкаПроизводительностиКлиент.НачатьЗамерВремени(Истина,
		"ОбщийМодуль.РаботаСНоменклатуройКлиент.ПодобратьНоменклатуруИзСервиса");
	
	Если Не ЗначениеЗаполнено(Форма.РаботаСНоменклатурой_ИдентификаторОбъектаСервиса) 
		И Не ЗначениеЗаполнено(Форма.РаботаСНоменклатурой_СтрокаПоискаОбъектаСервиса) Тогда
		
		Форма.РаботаСНоменклатурой_СтрокаПоискаОбъектаСервиса = СформироватьСтрокуПоискаПоПолямФормы(Форма);
	КонецЕсли;	
		
	ОбщегоНазначенияКлиентСервер.ДополнитьСтруктуру(ОповещениеОЗакрытии.ДополнительныеПараметры, ПараметрыОбработчика);
			
	ОповещениеПриЗакрытии = ОповещениеОЗакрытии;
	
	Если Не ЗначениеЗаполнено(Форма.РаботаСНоменклатурой_ИдентификаторОбъектаСервиса) 
		И Не ЗначениеЗаполнено(Форма.РаботаСНоменклатурой_СтрокаПоискаОбъектаСервиса) Тогда
		
		Форма.РаботаСНоменклатурой_СтрокаПоискаОбъектаСервиса = СформироватьСтрокуПоискаПоПолямФормы(Форма);
	КонецЕсли;	
	
	СтрокаПоиска = ?(ЗначениеЗаполнено(Форма.РаботаСНоменклатурой_ИдентификаторОбъектаСервиса), 
			Форма.РаботаСНоменклатурой_ПредставлениеОбъектаСервиса, 
			Форма.РаботаСНоменклатурой_СтрокаПоискаОбъектаСервиса);
	
	ПараметрыФормы = ПараметрыФормыЗагрузкиНоменклатуры();
	
	ПараметрыФормы.РежимВыбораНоменклатуры   = Истина;
	ПараметрыФормы.РежимПривязкиНоменклатуры = Истина;
	ПараметрыФормы.ИдентификаторНоменклатуры = Форма.РаботаСНоменклатурой_ИдентификаторОбъектаСервиса;
	ПараметрыФормы.СтрокаПоиска              = СтрокаПоиска;
					
	ОткрытьФормуЗагрузкиНоменклатуры(ПараметрыФормы, Форма, ОповещениеОЗакрытии, РежимОткрытияОкнаФормы.БлокироватьОкноВладельца)	
		
КонецПроцедуры

Процедура ОткрытьФормуНастройкиЗагрузкиНоменклатуры(РезультатСоздания, ДополнительныеПараметры)
	
	ПараметрыФормы = Новый Структура;
	ПараметрыФормы.Вставить("НоменклатураДляАнализа", РезультатСоздания.НоменклатураДляАнализа);
	
	Если РезультатСоздания.КоличествоКатегорийДляНастройки = 1 
		И РезультатСоздания.КоличествоНоменклатурыДляНастройки = 1 Тогда
		
		ОценкаПроизводительностиКлиент.НачатьЗамерВремени(Истина,
			"ОбщийМодуль.РаботаСНоменклатуройКлиент.НастройкаЗагрузкиНоменклатурыОдиночная");
		
		ОткрытьФорму("Обработка.РаботаСНоменклатурой.Форма.НастройкаЗагрузкиНоменклатурыОдиночная", 
			ПараметрыФормы, ЭтотОбъект,,,, ДополнительныеПараметры.ОповещениеОЗавершении);
	Иначе
		
		ОценкаПроизводительностиКлиент.НачатьЗамерВремени(Истина,
			"ОбщийМодуль.РаботаСНоменклатуройКлиент.НастройкаЗагрузкиНоменклатурыМножественная");
				
		ОткрытьФорму("Обработка.РаботаСНоменклатурой.Форма.НастройкаЗагрузкиНоменклатурыМножественная", 
			ПараметрыФормы, ЭтотОбъект,,,, ДополнительныеПараметры.ОповещениеОЗавершении);	
	КонецЕсли;
	
КонецПроцедуры

#КонецОбласти

#Область ПараметрыОткрытияФорм

Функция ПараметрыФормыКарточкиНоменклатурыСервиса() Экспорт
	
	Результат = Новый Структура;
	
	Результат.Вставить("ЭтоРежимПросмотра",          Ложь);
	Результат.Вставить("ИдентификаторыНоменклатуры", Новый Массив);
	Результат.Вставить("СтрокаШтрихкода",            "");
	
	Возврат Результат;
	
КонецФункции

Функция ПараметрыФормыЗаполненияВидаНоменклатуры() Экспорт
	
	ПараметрыФормы = Новый Структура;
	
	ПараметрыФормы.Вставить("ИдентификаторыКатегорий",         Новый СписокЗначений);
	ПараметрыФормы.Вставить("ВидНоменклатуры",                 Неопределено);
	ПараметрыФормы.Вставить("ЭтоРежимСопоставленияРеквизитов", Ложь);
	ПараметрыФормы.Вставить("ЭтоВнешняяПривязка",              Ложь);
	ПараметрыФормы.Вставить("ЭтоПривязка",                     Ложь);
	ПараметрыФормы.Вставить("ВызовИзПомощникаОбновления",      Ложь);
	ПараметрыФормы.Вставить("ДанныеИнтерактивногоЗаполнения",  Неопределено);
	ПараметрыФормы.Вставить("РежимЗагрузкиХарактеристик",      "");
	
	Возврат ПараметрыФормы;
	
КонецФункции

#КонецОбласти

#Область ОбработчикиСобытийФорм

Процедура ВыборРежимаОбновления(РежимОбновления, ДополнительныеПараметры) Экспорт
	
	Форма = ДополнительныеПараметры.Форма;
	
	Если РежимОбновления = Неопределено Тогда
		Возврат;
	КонецЕсли;
	
	Форма.РаботаСНоменклатурой_ОбъектСервисаИзменен = Истина;
	
	Если РежимОбновления.Значение = "вручную" Тогда
		Форма.РаботаСНоменклатурой_ОбновляетсяАвтоматически = Ложь;
	ИначеЕсли РежимОбновления.Значение = "автоматически" Тогда
		Форма.РаботаСНоменклатурой_ОбновляетсяАвтоматически = Истина;
	КонецЕсли;
	
	Форма.Элементы.РежимОбновления.Заголовок = 
		РаботаСНоменклатуройСлужебныйКлиентСервер.ЗаголовокГиперссылкиРежимаОбновления(Форма.РаботаСНоменклатурой_ОбновляетсяАвтоматически);
	
КонецПроцедуры

Процедура ОткрытьФормуЗаполненияНоменклатуры(Владелец, ПараметрыФормы, ОповещениеОЗакрытии)
	
	ОткрытьФорму("Обработка.РаботаСНоменклатурой.Форма.ЗаполнениеНоменклатуры", ПараметрыФормы, Владелец, , , , ОповещениеОЗакрытии);

КонецПроцедуры
	
Процедура ОбработкаРасшифровкиПредставленияКатегории(Элемент, 
			Расшифровка, СтандартнаяОбработка, ДополнительныеПараметры) Экспорт
	
	Если Элемент.ТекущаяОбласть.Имя = "Шапка_ВидыНоменклатуры" Тогда
		
		СтандартнаяОбработка = Ложь;
		
		Если Не ЗначениеЗаполнено(Расшифровка) Тогда
			Возврат;
		КонецЕсли;
		
		Если ТипЗнч(Расшифровка) = Тип("Массив") Тогда
			
			РаботаСНоменклатуройКлиентПереопределяемый.ОткрытьФормуСпискаВидаНоменклатуры(Расшифровка, ЭтотОбъект);
			
		ИначеЕсли ТипЗнч(Расшифровка) <> Тип("Массив") Тогда	
			
			ИмяФормыВидаНоменклатуры = РаботаСНоменклатуройСлужебныйВызовСервера.ИмяФормыЭлементаВидаНоменклатуры();
			
			Если НЕ ЗначениеЗаполнено(ИмяФормыВидаНоменклатуры) Тогда
				Возврат;
			КонецЕсли;
			
			ОткрытьФорму(ИмяФормыВидаНоменклатуры, Новый Структура("Ключ", Расшифровка), ЭтотОбъект);		
			
		КонецЕсли;
	КонецЕсли;
	
КонецПроцедуры

#КонецОбласти

#Область ОбработчикиОповещенияФормПрикладныхОбъектов

Процедура ОбработкаОповещенияВыбораРежимаОбновления(РезультатВыбора, ДополнительныеПараметры) Экспорт
	
	Если РезультатВыбора = Неопределено Тогда
		Возврат;
	КонецЕсли;
	
	////////////////////////////////////////////////////////////////////////////////
	
	Форма               =  ДополнительныеПараметры.Форма;
	СсылкаНаОбъект      = Форма.РаботаСНоменклатурой_СсылкаНаОбъект;
	ОповещениеОЗакрытии = ДополнительныеПараметры.ОповещениеОЗакрытии;
	
	Если РезультатВыбора.Значение = "РучноеОбновление" Тогда
		
		Если Форма.РаботаСНоменклатурой_ТипОбъекта = "ВидНоменклатуры" Тогда // Категория
				
			ПараметрыФормы = ПараметрыФормыЗаполненияВидаНоменклатуры();
			
			ПараметрыФормы.ИдентификаторыКатегорий        = Форма.РаботаСНоменклатурой_ИдентификаторыОбъектовСервиса;
			ПараметрыФормы.ВидНоменклатуры                = СсылкаНаОбъект;
			ПараметрыФормы.ДанныеИнтерактивногоЗаполнения = ДополнительныеПараметры.ДанныеИнтерактивногоЗаполнения;
			ПараметрыФормы.РежимЗагрузкиХарактеристик =     Форма.РаботаСНоменклатурой_РежимЗагрузкиХарактеристик;
			
			ОткрытьФормуЗаполненияВидаНоменклатуры(ПараметрыФормы, Форма, ОповещениеОЗакрытии);
				
		ИначеЕсли Форма.РаботаСНоменклатурой_ТипОбъекта = "Номенклатура" Тогда // Номенклатура
						
			ПараметрыФормы = Новый Структура;
			
			ПараметрыФормы.Вставить("ИдентификаторНоменклатуры",            Форма.РаботаСНоменклатурой_ИдентификаторОбъектаСервиса);
			ПараметрыФормы.Вставить("НоменклатураНаименование",             Форма.РаботаСНоменклатурой_ПредставлениеОбъектаСервиса);
			ПараметрыФормы.Вставить("Номенклатура",                         СсылкаНаОбъект);
			ПараметрыФормы.Вставить("ДанныеИнтерактивногоЗаполнения",       ДополнительныеПараметры.ДанныеИнтерактивногоЗаполнения);
			ПараметрыФормы.Вставить("ИдентификаторыВыбранныхХарактеристик", Форма.РаботаСНоменклатурой_ИдентификаторыХарактеристик);
			ПараметрыФормы.Вставить("ИдентификаторХарактеристики",          Форма.РаботаСНоменклатурой_ИдентификаторХарактеристики);
									
			ОткрытьФормуЗаполненияНоменклатуры(Форма, ПараметрыФормы, ОповещениеОЗакрытии);

		КонецЕсли;
				
	ИначеЕсли РезультатВыбора.Значение = "АвтоматическоеОбновление" Тогда
		
		Если Форма.РаботаСНоменклатурой_ТипОбъекта = "ВидНоменклатуры" Тогда
			ПоказатьВопросПриВключенииАвтообновленияВидаНоменклатуры(СсылкаНаОбъект, 
				Форма.РаботаСНоменклатурой_ИдентификаторыОбъектовСервиса.ВыгрузитьЗначения(), Форма);
		ИначеЕсли Форма.РаботаСНоменклатурой_ТипОбъекта = "Номенклатура" Тогда	
			ПоказатьВопросПриВключенииАвтообновленияНоменклатуры(СсылкаНаОбъект, 
				Форма.РаботаСНоменклатурой_ИдентификаторОбъектаСервиса, Форма);
		КонецЕсли;
		
	КонецЕсли;
		
КонецПроцедуры

Процедура ИзменениеТекстаРедактированияОбъектаСервисаЗавершение(Знач Результат, ДополнительныеПараметры) Экспорт
	
	Форма = ДополнительныеПараметры.Форма;
	Если Форма.РаботаСНоменклатурой_ИдентификаторЗадания <> ДополнительныеПараметры.ИдентификаторЗадания Тогда 
		Возврат;
	КонецЕсли;
	
	Форма.РаботаСНоменклатурой_ИдентификаторЗадания = Неопределено;
	
	ИмяЭлемента = ДополнительныеПараметры.ИмяЭлемента;
	Форма.Элементы.РаботаСНоменклатуройДекорацияДлительнойОперации.Картинка = БиблиотекаКартинок.Пустая;
	
	Если Результат = Неопределено Тогда // отменено пользователем.
		Возврат;
	ИначеЕсли ЭтоАдресВременногоХранилища(Результат.АдресРезультата) Тогда 
		КоличествоНайденныхКарточек = ПолучитьИзВременногоХранилища(Результат.АдресРезультата);
		Если КоличествоНайденныхКарточек = Неопределено Тогда 
			Возврат;
		КонецЕсли;
	КонецЕсли;
	
	Если КоличествоНайденныхКарточек > 0 Тогда
		Если Форма.РаботаСНоменклатурой_РежимПредставленияОбъектаСервиса = "ПолеВвода" Тогда
			Форма.Элементы[ИмяЭлемента].ПодсказкаВвода 
				= ТекстКоличествоНайденныхЭлементов(
					ИмяЭлемента, КоличествоНайденныхКарточек, Форма.РаботаСНоменклатурой_РежимПредставленияОбъектаСервиса);
		Иначе
			Форма.РаботаСНоменклатурой_ПредставлениеОбъектаСервиса 
				= ТекстКоличествоНайденныхЭлементов(
					ИмяЭлемента, КоличествоНайденныхКарточек, Форма.РаботаСНоменклатурой_РежимПредставленияОбъектаСервиса);
		КонецЕсли;		
	Иначе					
		Если Форма.РаботаСНоменклатурой_РежимПредставленияОбъектаСервиса = "Гиперссылка" Тогда
			Форма.РаботаСНоменклатурой_ПредставлениеОбъектаСервиса = СтроковыеФункцииКлиентСервер.
				ФорматированнаяСтрока(НСтр("ru = '<b>Похожих карточек не найдено.  </b><a href = ""Ссылка"">Выбрать</a>'"));
		Иначе
			РаботаСНоменклатуройСлужебныйКлиентСервер.СброситьДанныеОбъектаСервиса(Форма,
				Форма.Элементы[ИмяЭлемента],
				РаботаСНоменклатуройСлужебныйКлиентСервер.ПредставлениеПустойНоменклатуры());	
		КонецЕсли;	
	КонецЕсли;
	
КонецПроцедуры

#КонецОбласти

#Область КонтекстныйПоискНоменклатуры

Функция ТекстКоличествоНайденныхЭлементов(ИмяЭлемента, КоличествоНайденныхКарточек, Назначение)
	
	Если Назначение = "ПолеВвода" Тогда
		Если КоличествоНайденныхКарточек >= 500 Тогда 
			Возврат НСтр("ru = 'Обнаружено подходящих карточек: 500+'");
		Иначе
			Возврат СтрШаблон(НСтр("ru = 'Обнаружено подходящих карточек: %1'"), КоличествоНайденныхКарточек);
		КонецЕсли;
	Иначе
		Если КоличествоНайденныхКарточек >= 50 Тогда 
			Возврат СтроковыеФункцииКлиентСервер.
				ФорматированнаяСтрока(НСтр("ru = '<b>Найдено более 50 карточек. </b><a href = ""Ссылка"">Выбрать</a>'"));
		Иначе
			Возврат СтроковыеФункцииКлиентСервер.
				ФорматированнаяСтрока(СтрШаблон(НСтр("ru = '<b>Найдено %1 похожих карточек.  </b><a href = ""Ссылка"">Выбрать</a>'"), 
				КоличествоНайденныхКарточек));
		КонецЕсли;
	КонецЕсли;
		
КонецФункции

Функция СформироватьСтрокуПоискаПоПолямФормы(Форма)
	
	СтрокаПоиска = "";
	СписокПолей = Форма.РаботаСНоменклатурой_СписокПолейДляПодбораНоменклатуры.ВыгрузитьЗначения();
	////////////////////////////////////////////////////////////////////////////////
	
	СписокПодстрок = Новый Массив;
	
	Для каждого ЭлементКоллекции Из СписокПолей Цикл
		СписокПодстрок.Добавить(Форма.Элементы[ЭлементКоллекции].ТекстРедактирования);
	КонецЦикла;
	
	СтрокаПоиска = СтрСоединить(СписокПодстрок, " ");
	
	Возврат СокрЛП(СтрокаПоиска);
	
КонецФункции

// Формирование строки поиска номенклатуры.
//
// Параметры:
//  Форма	 - УправляемаяФорма - форма события.
//  Элемент	 - ПолеФормы - изменяемый элемент формы.
//
Процедура СобратьСтрокуПоиска(Форма, Элемент)
	
	Если Не Форма.РаботаСНоменклатурой_СервисДоступен Тогда
		Возврат;
	КонецЕсли;
	
	Если Не ПустаяСтрока(Форма.РаботаСНоменклатурой_ИдентификаторОбъектаСервиса) Тогда 
		Возврат;
	КонецЕсли;
	
	Если Форма.РаботаСНоменклатурой_РежимПредставленияОбъектаСервиса = "Гиперссылка" Тогда
		Форма.РаботаСНоменклатурой_ПредставлениеОбъектаСервиса = СтроковыеФункцииКлиентСервер.
			ФорматированнаяСтрока(НСтр("ru = '<b>Идет поиск... </b><a href = ""Ссылка"">Выбрать</a>'"));
	КонецЕсли;
	
	Форма.РаботаСНоменклатурой_СтрокаПоискаОбъектаСервиса = СформироватьСтрокуПоискаПоПолямФормы(Форма);
		
	Если Не ЗначениеЗаполнено(Форма.РаботаСНоменклатурой_СтрокаПоискаОбъектаСервиса) Тогда
		РаботаСНоменклатуройСлужебныйКлиентСервер.СброситьДанныеОбъектаСервиса(Форма,
			Форма.Элементы.ПредставлениеНоменклатурыСервиса,
			РаботаСНоменклатуройСлужебныйКлиентСервер.ПредставлениеПустойНоменклатуры());	
		Возврат;
	КонецЕсли;
	
	СписокПолей = Форма.РаботаСНоменклатурой_СписокПолейДляПодбораНоменклатуры.ВыгрузитьЗначения();
	СписокПолей.Добавить("ПредставлениеНоменклатурыСервиса");
	
	Если Не СписокПолей.Найти(Элемент.Имя) = Неопределено Тогда 
		ДлительнаяОперация = РаботаСНоменклатуройСлужебныйВызовСервера.ПолучитьКоличествоКарточекНоменклатурыПоСтрокеПоискаВФоне(
			Форма.РаботаСНоменклатурой_СтрокаПоискаОбъектаСервиса, Форма.УникальныйИдентификатор, Форма.РаботаСНоменклатурой_ИдентификаторЗадания);
	Иначе
		Возврат;
	КонецЕсли;
	
	ПараметрыОжидания = ДлительныеОперацииКлиент.ПараметрыОжидания(Форма);
	
	ПараметрыОжидания.ВыводитьПрогрессВыполнения      = Ложь;
	ПараметрыОжидания.ВыводитьОкноОжидания            = Ложь;
	ПараметрыОжидания.ОповещениеПользователя.Показать = Ложь;
	ПараметрыОжидания.ВыводитьСообщения               = Ложь;
	
	Если Не ДлительнаяОперация = Неопределено
		И ДлительнаяОперация.Статус = "Выполняется" Тогда
		Форма.Элементы.РаботаСНоменклатуройДекорацияДлительнойОперации.Картинка = БиблиотекаКартинок.ДлительнаяОперация16;
	КонецЕсли;
	
	Форма.РаботаСНоменклатурой_ИдентификаторЗадания = ДлительнаяОперация.ИдентификаторЗадания;
	
	ПараметрыЗавершения = Новый Структура();
	ПараметрыЗавершения.Вставить("ИмяЭлемента",          "ПредставлениеНоменклатурыСервиса");
	ПараметрыЗавершения.Вставить("Форма",                Форма);
	ПараметрыЗавершения.Вставить("ИдентификаторЗадания", Форма.РаботаСНоменклатурой_ИдентификаторЗадания);
	
	ОповещениеОЗавершении = Новый ОписаниеОповещения(
		"ИзменениеТекстаРедактированияОбъектаСервисаЗавершение", 
		ЭтотОбъект, ПараметрыЗавершения);   
	
	ПараметрыЗавершенияДлительнойОперации = Новый Структура();
	ПараметрыЗавершенияДлительнойОперации.Вставить("ОповещениеОЗавершении", ОповещениеОЗавершении);
	ПараметрыЗавершенияДлительнойОперации.Вставить("ВыводитьОшибки", Ложь);
	
	ДлительнаяОперацияЗавершение = Новый ОписаниеОповещения("ДлительнаяОперацияЗавершение",
		ЭтотОбъект, ПараметрыЗавершенияДлительнойОперации);
	
	ДлительныеОперацииКлиент.ОжидатьЗавершение(ДлительнаяОперация,
		ДлительнаяОперацияЗавершение,
		ПараметрыОжидания);
	
КонецПроцедуры

#КонецОбласти

#Область РаботаСКатегориями

Процедура ПолучитьКатегорииНаПутиКЭлементу(ОповещениеОЗавершении, 
	Идентификатор, 
	ПараметрыЗапросаНоменклатуры, 
	Форма, 
	ИдентификаторЗадания = Неопределено, 
	ДекорацияДлительногоОжидания = Неопределено) Экспорт 
	
	ДлительнаяОперация = РаботаСНоменклатуройСлужебныйВызовСервера.ПолучитьКатегорииНаПутиКЭлементуВФоне(
		Идентификатор, ПараметрыЗапросаНоменклатуры, Форма.УникальныйИдентификатор, ИдентификаторЗадания);
	
	ПараметрыОжидания = ДлительныеОперацииКлиент.ПараметрыОжидания(Форма);
	ПараметрыОжидания.ВыводитьПрогрессВыполнения = Ложь;
	ПараметрыОжидания.ВыводитьОкноОжидания = ДекорацияДлительногоОжидания = Неопределено;
	ПараметрыОжидания.ОповещениеПользователя.Показать = Ложь;
	ПараметрыОжидания.ВыводитьСообщения = Истина;
	
	ИдентификаторЗадания = ДлительнаяОперация.ИдентификаторЗадания;
	ОповещениеОЗавершении.ДополнительныеПараметры.Вставить("ИдентификаторЗадания", ИдентификаторЗадания);
	
	Если Не ДекорацияДлительногоОжидания = Неопределено
		И Не ДлительнаяОперация = Неопределено
		И ДлительнаяОперация.Статус = "Выполняется" Тогда
		ДекорацияДлительногоОжидания.Картинка = БиблиотекаКартинок.ДлительнаяОперация16;
	КонецЕсли;
	
	ПараметрыЗавершения = Новый Структура;
	ПараметрыЗавершения.Вставить("ОповещениеОЗавершении", ОповещениеОЗавершении);
	
	ДлительнаяОперацияЗавершение = Новый ОписаниеОповещения("ДлительнаяОперацияЗавершение",
		ЭтотОбъект, ПараметрыЗавершения);
	
	ДлительныеОперацииКлиент.ОжидатьЗавершение(ДлительнаяОперация,
		ДлительнаяОперацияЗавершение,
		ПараметрыОжидания);

	
КонецПроцедуры
	
Процедура ПолучитьКатегорииНаПутиКЭлементуСКорневымиКатегориями(
			ОповещениеОЗавершении, 
			Идентификатор, 
			ПараметрыЗапросаНоменклатуры, 
			Форма, 
			ИдентификаторЗадания = Неопределено, 
			ДекорацияДлительногоОжидания = Неопределено) Экспорт 
	
	ДлительнаяОперация = РаботаСНоменклатуройСлужебныйВызовСервера.ПолучитьКатегорииНаПутиКЭлементуСКорневымиКатегориямиВФоне(
		Идентификатор, ПараметрыЗапросаНоменклатуры, Форма.УникальныйИдентификатор, ИдентификаторЗадания);
	
	ПараметрыОжидания = ДлительныеОперацииКлиент.ПараметрыОжидания(Форма);
	ПараметрыОжидания.ВыводитьПрогрессВыполнения = Ложь;
	ПараметрыОжидания.ВыводитьОкноОжидания = ДекорацияДлительногоОжидания = Неопределено;
	ПараметрыОжидания.ОповещениеПользователя.Показать = Ложь;
	ПараметрыОжидания.ВыводитьСообщения = Истина;
	
	ИдентификаторЗадания = ДлительнаяОперация.ИдентификаторЗадания;
	ОповещениеОЗавершении.ДополнительныеПараметры.Вставить("ИдентификаторЗадания", ИдентификаторЗадания);
	
	Если Не ДекорацияДлительногоОжидания = Неопределено
		И Не ДлительнаяОперация = Неопределено
		И ДлительнаяОперация.Статус = "Выполняется" Тогда
		ДекорацияДлительногоОжидания.Картинка = БиблиотекаКартинок.ДлительнаяОперация16;
	КонецЕсли;
	
	ПараметрыЗавершения = Новый Структура;
	ПараметрыЗавершения.Вставить("ОповещениеОЗавершении", ОповещениеОЗавершении);
	
	ДлительнаяОперацияЗавершение = Новый ОписаниеОповещения("ДлительнаяОперацияЗавершение",
		ЭтотОбъект, ПараметрыЗавершения);
	
	ДлительныеОперацииКлиент.ОжидатьЗавершение(ДлительнаяОперация,
		ДлительнаяОперацияЗавершение,
		ПараметрыОжидания);

	
КонецПроцедуры

Процедура НайтиКатегорииПоСтрокеПоиска(ОповещениеОЗавершении, ТекстПоиска, 
			Форма, ИдентификаторЗадания = Неопределено, ДекорацияДлительногоОжидания = Неопределено) Экспорт 
	
	ДлительнаяОперация = РаботаСНоменклатуройСлужебныйВызовСервера.НайтиКатегорииПоСтрокеПоискаВФоне(
		ТекстПоиска, Форма.УникальныйИдентификатор, ИдентификаторЗадания);
	
	ПараметрыОжидания = ДлительныеОперацииКлиент.ПараметрыОжидания(Форма);
	ПараметрыОжидания.ВыводитьПрогрессВыполнения = Ложь;
	ПараметрыОжидания.ВыводитьОкноОжидания = ДекорацияДлительногоОжидания = Неопределено;
	ПараметрыОжидания.ОповещениеПользователя.Показать = Ложь;
	ПараметрыОжидания.ВыводитьСообщения = Истина;
	
	ИдентификаторЗадания = ДлительнаяОперация.ИдентификаторЗадания;
	ОповещениеОЗавершении.ДополнительныеПараметры.Вставить("ИдентификаторЗадания", ИдентификаторЗадания);
	
	Если Не ДекорацияДлительногоОжидания = Неопределено
		И Не ДлительнаяОперация = Неопределено
		И ДлительнаяОперация.Статус = "Выполняется" Тогда
		ДекорацияДлительногоОжидания.Картинка = БиблиотекаКартинок.ДлительнаяОперация16;
	КонецЕсли;
	
	ПараметрыЗавершения = Новый Структура;
	ПараметрыЗавершения.Вставить("ОповещениеОЗавершении", ОповещениеОЗавершении);
	
	ДлительнаяОперацияЗавершение = Новый ОписаниеОповещения("ДлительнаяОперацияЗавершение",
		ЭтотОбъект, ПараметрыЗавершения);
	
	ДлительныеОперацииКлиент.ОжидатьЗавершение(ДлительнаяОперация,
		ДлительнаяОперацияЗавершение,
		ПараметрыОжидания);
		
КонецПроцедуры
	
Процедура ПолучитьКорневыеКатегории(ОповещениеОЗавершении, 
	Форма, 
	ПараметрыЗапросаНоменклатуры = Неопределено,
	ИдентификаторЗадания = Неопределено, 
	ДекорацияДлительногоОжидания = Неопределено) Экспорт
	
	ДлительнаяОперация = РаботаСНоменклатуройСлужебныйВызовСервера.ПолучитьКорневыеКатегорииВФоне(
		Форма.УникальныйИдентификатор, ИдентификаторЗадания, ПараметрыЗапросаНоменклатуры);
	
	ПараметрыОжидания = ДлительныеОперацииКлиент.ПараметрыОжидания(Форма);
	ПараметрыОжидания.ВыводитьПрогрессВыполнения = Ложь;
	ПараметрыОжидания.ВыводитьОкноОжидания = Ложь;
	ПараметрыОжидания.ОповещениеПользователя.Показать = Ложь;
	ПараметрыОжидания.ВыводитьСообщения = Истина;
	
	ИдентификаторЗадания = ДлительнаяОперация.ИдентификаторЗадания;
	ОповещениеОЗавершении.ДополнительныеПараметры.Вставить("ИдентификаторЗадания", ИдентификаторЗадания);
	
	Если Не ДекорацияДлительногоОжидания = Неопределено
		И Не ДлительнаяОперация = Неопределено
		И ДлительнаяОперация.Статус = "Выполняется" Тогда
		ДекорацияДлительногоОжидания.Картинка = БиблиотекаКартинок.ДлительнаяОперация16;
	КонецЕсли;
	
	ПараметрыЗавершения = Новый Структура;
	ПараметрыЗавершения.Вставить("ОповещениеОЗавершении", ОповещениеОЗавершении);
	
	ДлительнаяОперацияЗавершение = Новый ОписаниеОповещения("ДлительнаяОперацияЗавершение",
		ЭтотОбъект, ПараметрыЗавершения);
	
	ДлительныеОперацииКлиент.ОжидатьЗавершение(ДлительнаяОперация,
		ДлительнаяОперацияЗавершение,
		ПараметрыОжидания);
КонецПроцедуры

Процедура ПолучитьСокращенноеОписаниеДочернихКатегорий(ОповещениеОЗавершении, Идентификатор, Форма,
		НоменклатураИОтборы = Неопределено, ИдентификаторЗадания = Неопределено,
		ДекорацияДлительногоОжидания = Неопределено) Экспорт
	
	НаборПолей = 2;
	
	ДлительнаяОперация = РаботаСНоменклатуройСлужебныйВызовСервера.ПолучитьДочерниеКатегорииВФоне(Идентификатор,
		НаборПолей, Форма.УникальныйИдентификатор, ИдентификаторЗадания, НоменклатураИОтборы);
	
	ПараметрыОжидания = ДлительныеОперацииКлиент.ПараметрыОжидания(Форма);
	ПараметрыОжидания.ВыводитьПрогрессВыполнения = Ложь;
	ПараметрыОжидания.ВыводитьОкноОжидания = ДекорацияДлительногоОжидания = Неопределено;
	ПараметрыОжидания.ОповещениеПользователя.Показать = Ложь;
	ПараметрыОжидания.ВыводитьСообщения = Истина;
	
	ИдентификаторЗадания = ДлительнаяОперация.ИдентификаторЗадания;
	ОповещениеОЗавершении.ДополнительныеПараметры.Вставить("ИдентификаторЗадания", ИдентификаторЗадания);
	
	Если Не ДекорацияДлительногоОжидания = Неопределено
		И Не ДлительнаяОперация = Неопределено
		И ДлительнаяОперация.Статус = "Выполняется" Тогда
		ДекорацияДлительногоОжидания.Картинка = БиблиотекаКартинок.ДлительнаяОперация16;
	КонецЕсли;
	
	ПараметрыЗавершения = Новый Структура;
	ПараметрыЗавершения.Вставить("ОповещениеОЗавершении", ОповещениеОЗавершении);
	
	ДлительнаяОперацияЗавершение = Новый ОписаниеОповещения("ДлительнаяОперацияЗавершение",
		ЭтотОбъект, ПараметрыЗавершения);
	
	ДлительныеОперацииКлиент.ОжидатьЗавершение(ДлительнаяОперация,
		ДлительнаяОперацияЗавершение,
		ПараметрыОжидания);
		
КонецПроцедуры

Процедура ПолучитьПолноеОписаниеДочернихКатегорий(ОповещениеОЗавершении, Идентификатор, Форма,
		НоменклатураИОтборы = Неопределено, ИдентификаторЗадания = Неопределено,
		ДекорацияДлительногоОжидания = Неопределено) Экспорт
	
	НаборПолей = 3;
	
	ДлительнаяОперация = РаботаСНоменклатуройСлужебныйВызовСервера.ПолучитьДочерниеКатегорииВФоне(Идентификатор,
		НаборПолей, Форма.УникальныйИдентификатор, ИдентификаторЗадания, НоменклатураИОтборы);
	
	ПараметрыОжидания = ДлительныеОперацииКлиент.ПараметрыОжидания(Форма);
	ПараметрыОжидания.ВыводитьПрогрессВыполнения = Ложь;
	ПараметрыОжидания.ВыводитьОкноОжидания = ДекорацияДлительногоОжидания = Неопределено;
	ПараметрыОжидания.ОповещениеПользователя.Показать = Ложь;
	ПараметрыОжидания.ВыводитьСообщения = Истина;
	
	ИдентификаторЗадания = ДлительнаяОперация.ИдентификаторЗадания;
	ОповещениеОЗавершении.ДополнительныеПараметры.Вставить("ИдентификаторЗадания", ИдентификаторЗадания);
	
	Если Не ДекорацияДлительногоОжидания = Неопределено
		И Не ДлительнаяОперация = Неопределено
		И ДлительнаяОперация.Статус = "Выполняется" Тогда
		ДекорацияДлительногоОжидания.Картинка = БиблиотекаКартинок.ДлительнаяОперация16;
	КонецЕсли;
	
	ПараметрыЗавершения = Новый Структура;
	ПараметрыЗавершения.Вставить("ОповещениеОЗавершении", ОповещениеОЗавершении);
	
	ДлительнаяОперацияЗавершение = Новый ОписаниеОповещения("ДлительнаяОперацияЗавершение",
		ЭтотОбъект, ПараметрыЗавершения);
	
	ДлительныеОперацииКлиент.ОжидатьЗавершение(ДлительнаяОперация,
		ДлительнаяОперацияЗавершение,
		ПараметрыОжидания);
		
КонецПроцедуры

Процедура ПолучитьПредставлениеКатегорииПоИдентификатору(ОповещениеОЗавершении, Идентификатор, 
			Форма, ИдентификаторЗадания = Неопределено, ДекорацияДлительногоОжидания = Неопределено) Экспорт
	
	НаборПолей = 1;

	ДлительнаяОперация = РаботаСНоменклатуройСлужебныйВызовСервера.ПолучитьКатегориюПоИдентификаторуВФоне(
		Идентификатор, НаборПолей, Форма.УникальныйИдентификатор, ИдентификаторЗадания);
	
	ПараметрыОжидания = ДлительныеОперацииКлиент.ПараметрыОжидания(Форма);
	ПараметрыОжидания.ВыводитьПрогрессВыполнения = Ложь;
	ПараметрыОжидания.ВыводитьОкноОжидания = ДекорацияДлительногоОжидания = Неопределено;
	ПараметрыОжидания.ОповещениеПользователя.Показать = Ложь;
	ПараметрыОжидания.ВыводитьСообщения = Истина;
	
	ИдентификаторЗадания = ДлительнаяОперация.ИдентификаторЗадания;
	ОповещениеОЗавершении.ДополнительныеПараметры.Вставить("ИдентификаторЗадания", ИдентификаторЗадания);
	
	Если Не ДекорацияДлительногоОжидания = Неопределено
		И Не ДлительнаяОперация = Неопределено
		И ДлительнаяОперация.Статус = "Выполняется" Тогда
		ДекорацияДлительногоОжидания.Картинка = БиблиотекаКартинок.ДлительнаяОперация16;
	КонецЕсли;
	
	ПараметрыЗавершения = Новый Структура;
	ПараметрыЗавершения.Вставить("ОповещениеОЗавершении", ОповещениеОЗавершении);
	
	ДлительнаяОперацияЗавершение = Новый ОписаниеОповещения("ДлительнаяОперацияЗавершение",
		ЭтотОбъект, ПараметрыЗавершения);
	
	ДлительныеОперацииКлиент.ОжидатьЗавершение(ДлительнаяОперация,
		ДлительнаяОперацияЗавершение,
		ПараметрыОжидания);
		
КонецПроцедуры

Процедура ПолучитьОписаниеКатегорииПоИдентификатору(ОповещениеОЗавершении, Идентификатор, Форма, 
			ИдентификаторЗадания = Неопределено, ДекорацияДлительногоОжидания = Неопределено) Экспорт
	
	НаборПолей = 2;

	ДлительнаяОперация = РаботаСНоменклатуройСлужебныйВызовСервера.ПолучитьКатегориюПоИдентификаторуВФоне(
		Идентификатор, НаборПолей, Форма.УникальныйИдентификатор, ИдентификаторЗадания);
	
	ПараметрыОжидания = ДлительныеОперацииКлиент.ПараметрыОжидания(Форма);
	ПараметрыОжидания.ВыводитьПрогрессВыполнения = Ложь;
	ПараметрыОжидания.ВыводитьОкноОжидания = ДекорацияДлительногоОжидания = Неопределено;
	ПараметрыОжидания.ОповещениеПользователя.Показать = Ложь;
	ПараметрыОжидания.ВыводитьСообщения = Истина;
	
	ИдентификаторЗадания = ДлительнаяОперация.ИдентификаторЗадания;
	ОповещениеОЗавершении.ДополнительныеПараметры.Вставить("ИдентификаторЗадания", ИдентификаторЗадания);
	
	Если Не ДекорацияДлительногоОжидания = Неопределено
		И Не ДлительнаяОперация = Неопределено
		И ДлительнаяОперация.Статус = "Выполняется" Тогда
		ДекорацияДлительногоОжидания.Картинка = БиблиотекаКартинок.ДлительнаяОперация16;
	КонецЕсли;
	
	ПараметрыЗавершения = Новый Структура;
	ПараметрыЗавершения.Вставить("ОповещениеОЗавершении", ОповещениеОЗавершении);
	
	ДлительнаяОперацияЗавершение = Новый ОписаниеОповещения("ДлительнаяОперацияЗавершение",
		ЭтотОбъект, ПараметрыЗавершения);
	
	ДлительныеОперацииКлиент.ОжидатьЗавершение(ДлительнаяОперация,
		ДлительнаяОперацияЗавершение,
		ПараметрыОжидания);
		
КонецПроцедуры

Процедура ПолучитьПолноеОписаниеКатегорииПоИдентификатору(ОповещениеОЗавершении, Идентификатор, Форма, 
			ИдентификаторЗадания = Неопределено, ДекорацияДлительногоОжидания = Неопределено) Экспорт
	
	НаборПолей = 3;

	ДлительнаяОперация = РаботаСНоменклатуройСлужебныйВызовСервера.ПолучитьКатегориюПоИдентификаторуВФоне(
		Идентификатор, НаборПолей, Форма.УникальныйИдентификатор, ИдентификаторЗадания);
	
	ПараметрыОжидания = ДлительныеОперацииКлиент.ПараметрыОжидания(Форма);
	ПараметрыОжидания.ВыводитьПрогрессВыполнения = Ложь;
	ПараметрыОжидания.ВыводитьОкноОжидания = ДекорацияДлительногоОжидания = Неопределено;
	ПараметрыОжидания.ОповещениеПользователя.Показать = Ложь;
	ПараметрыОжидания.ВыводитьСообщения = Истина;
	
	ИдентификаторЗадания = ДлительнаяОперация.ИдентификаторЗадания;
	ОповещениеОЗавершении.ДополнительныеПараметры.Вставить("ИдентификаторЗадания", ИдентификаторЗадания);
	
	Если Не ДекорацияДлительногоОжидания = Неопределено
		И Не ДлительнаяОперация = Неопределено
		И ДлительнаяОперация.Статус = "Выполняется" Тогда
		ДекорацияДлительногоОжидания.Картинка = БиблиотекаКартинок.ДлительнаяОперация16;
	КонецЕсли;
	
	ПараметрыЗавершения = Новый Структура;
	ПараметрыЗавершения.Вставить("ОповещениеОЗавершении", ОповещениеОЗавершении);
	
	ДлительнаяОперацияЗавершение = Новый ОписаниеОповещения("ДлительнаяОперацияЗавершение",
		ЭтотОбъект, ПараметрыЗавершения);
	
	ДлительныеОперацииКлиент.ОжидатьЗавершение(ДлительнаяОперация,
		ДлительнаяОперацияЗавершение,
		ПараметрыОжидания);
		
КонецПроцедуры

Процедура ПолучитьДополнительныеРеквизитыКатегорий(ОповещениеОЗавершении, Идентификатор, Форма, 
			ИдентификаторЗадания = Неопределено, ДекорацияДлительногоОжидания = Неопределено) Экспорт
	
	ДлительнаяОперация = РаботаСНоменклатуройСлужебныйВызовСервера.ПолучитьДополнительныеРеквизитыКатегорийВФоне(
		Идентификатор, Форма.УникальныйИдентификатор, ИдентификаторЗадания);
	
	ПараметрыОжидания = ДлительныеОперацииКлиент.ПараметрыОжидания(Форма);
	ПараметрыОжидания.ВыводитьПрогрессВыполнения = Ложь;
	ПараметрыОжидания.ВыводитьОкноОжидания = ДекорацияДлительногоОжидания = Неопределено;
	ПараметрыОжидания.ОповещениеПользователя.Показать = Ложь;
	ПараметрыОжидания.ВыводитьСообщения = Истина;
	
	ИдентификаторЗадания = ДлительнаяОперация.ИдентификаторЗадания;
	ОповещениеОЗавершении.ДополнительныеПараметры.Вставить("ИдентификаторЗадания", ИдентификаторЗадания);
	
	Если Не ДекорацияДлительногоОжидания = Неопределено
		И Не ДлительнаяОперация = Неопределено
		И ДлительнаяОперация.Статус = "Выполняется" Тогда
		ДекорацияДлительногоОжидания.Картинка = БиблиотекаКартинок.ДлительнаяОперация16;
	КонецЕсли;
	
	ПараметрыЗавершения = Новый Структура;
	ПараметрыЗавершения.Вставить("ОповещениеОЗавершении", ОповещениеОЗавершении);
	
	ДлительнаяОперацияЗавершение = Новый ОписаниеОповещения("ДлительнаяОперацияЗавершение",
		ЭтотОбъект, ПараметрыЗавершения);
	
	ДлительныеОперацииКлиент.ОжидатьЗавершение(ДлительнаяОперация,
		ДлительнаяОперацияЗавершение,
		ПараметрыОжидания);
		
КонецПроцедуры

Процедура ПолучитьФильтрыКатегории(ОповещениеОЗавершении, Идентификатор, Форма, 
			ИдентификаторЗадания = Неопределено, ДекорацияДлительногоОжидания = Неопределено) Экспорт
	
	ДлительнаяОперация = РаботаСНоменклатуройСлужебныйВызовСервера.ПолучитьФильтрыКатегорииВФоне(
		Идентификатор, Форма.УникальныйИдентификатор, ИдентификаторЗадания);
	
	ПараметрыОжидания = ДлительныеОперацииКлиент.ПараметрыОжидания(Форма);
	ПараметрыОжидания.ВыводитьПрогрессВыполнения = Ложь;
	ПараметрыОжидания.ВыводитьОкноОжидания = ДекорацияДлительногоОжидания = Неопределено;
	ПараметрыОжидания.ОповещениеПользователя.Показать = Ложь;
	ПараметрыОжидания.ВыводитьСообщения = Истина;
	
	ИдентификаторЗадания = ДлительнаяОперация.ИдентификаторЗадания;
	ОповещениеОЗавершении.ДополнительныеПараметры.Вставить("ИдентификаторЗадания", ИдентификаторЗадания);
	
	Если Не ДекорацияДлительногоОжидания = Неопределено
		И Не ДлительнаяОперация = Неопределено
		И ДлительнаяОперация.Статус = "Выполняется" Тогда
		ДекорацияДлительногоОжидания.Картинка = БиблиотекаКартинок.ДлительнаяОперация16;
	КонецЕсли;
	
	ПараметрыЗавершения = Новый Структура;
	ПараметрыЗавершения.Вставить("ОповещениеОЗавершении", ОповещениеОЗавершении);
	
	ДлительнаяОперацияЗавершение = Новый ОписаниеОповещения("ДлительнаяОперацияЗавершение",
		ЭтотОбъект, ПараметрыЗавершения);
	
	ДлительныеОперацииКлиент.ОжидатьЗавершение(ДлительнаяОперация,
		ДлительнаяОперацияЗавершение,
		ПараметрыОжидания);
		
КонецПроцедуры

Процедура ПолучитьЗначенияДополнительногоРеквизитаКатегории(ОповещениеОЗавершении, ПараметрыПоиска, Форма, 
			ИдентификаторЗадания = Неопределено, ДекорацияДлительногоОжидания = Неопределено) Экспорт 
	
	ДлительнаяОперация = РаботаСНоменклатуройСлужебныйВызовСервера.ПолучитьЗначенияДополнительногоРеквизитаКатегорииВФоне(
		ПараметрыПоиска, Форма.УникальныйИдентификатор, ИдентификаторЗадания);
	
	ПараметрыОжидания = ДлительныеОперацииКлиент.ПараметрыОжидания(Форма);
	ПараметрыОжидания.ВыводитьПрогрессВыполнения = Ложь;
	ПараметрыОжидания.ВыводитьОкноОжидания = ДекорацияДлительногоОжидания = Неопределено;
	ПараметрыОжидания.ОповещениеПользователя.Показать = Ложь;
	ПараметрыОжидания.ВыводитьСообщения = Истина;
	
	ИдентификаторЗадания = ДлительнаяОперация.ИдентификаторЗадания;
	ОповещениеОЗавершении.ДополнительныеПараметры.Вставить("ИдентификаторЗадания", ИдентификаторЗадания);
	
	Если Не ДекорацияДлительногоОжидания = Неопределено
		И Не ДлительнаяОперация = Неопределено
		И ДлительнаяОперация.Статус = "Выполняется" Тогда
		ДекорацияДлительногоОжидания.Картинка = БиблиотекаКартинок.ДлительнаяОперация16;
	КонецЕсли;
	
	ПараметрыЗавершения = Новый Структура;
	ПараметрыЗавершения.Вставить("ОповещениеОЗавершении", ОповещениеОЗавершении);
	
	ДлительнаяОперацияЗавершение = Новый ОписаниеОповещения("ДлительнаяОперацияЗавершение",
		ЭтотОбъект, ПараметрыЗавершения);
	
	ДлительныеОперацииКлиент.ОжидатьЗавершение(ДлительнаяОперация,
		ДлительнаяОперацияЗавершение,
		ПараметрыОжидания);
		
КонецПроцедуры
	
Процедура ПолучитьПроизводителейКатегории(ОповещениеОЗавершении, ПараметрыПоиска, Форма, 
			ИдентификаторЗадания = Неопределено, ДекорацияДлительногоОжидания = Неопределено) Экспорт 
	
	ДлительнаяОперация = РаботаСНоменклатуройСлужебныйВызовСервера.ПолучитьПроизводителейКатегорииВФоне(
		ПараметрыПоиска, Форма.УникальныйИдентификатор, ИдентификаторЗадания);
	
	ПараметрыОжидания = ДлительныеОперацииКлиент.ПараметрыОжидания(Форма);
	ПараметрыОжидания.ВыводитьПрогрессВыполнения = Ложь;
	ПараметрыОжидания.ВыводитьОкноОжидания = ДекорацияДлительногоОжидания = Неопределено;
	ПараметрыОжидания.ОповещениеПользователя.Показать = Ложь;
	ПараметрыОжидания.ВыводитьСообщения = Истина;
	
	ИдентификаторЗадания = ДлительнаяОперация.ИдентификаторЗадания;
	ОповещениеОЗавершении.ДополнительныеПараметры.Вставить("ИдентификаторЗадания", ИдентификаторЗадания);
	
	Если Не ДекорацияДлительногоОжидания = Неопределено
		И Не ДлительнаяОперация = Неопределено
		И ДлительнаяОперация.Статус = "Выполняется" Тогда
		ДекорацияДлительногоОжидания.Картинка = БиблиотекаКартинок.ДлительнаяОперация16;
	КонецЕсли;
	
	ПараметрыЗавершения = Новый Структура;
	ПараметрыЗавершения.Вставить("ОповещениеОЗавершении", ОповещениеОЗавершении);
	
	ДлительнаяОперацияЗавершение = Новый ОписаниеОповещения("ДлительнаяОперацияЗавершение",
		ЭтотОбъект, ПараметрыЗавершения);
	
	ДлительныеОперацииКлиент.ОжидатьЗавершение(ДлительнаяОперация,
		ДлительнаяОперацияЗавершение,
		ПараметрыОжидания);
		
КонецПроцедуры

Процедура СформироватьПредставлениеКарточкиКатегории(ОповещениеОЗавершении, ИдентификаторыКатегорий, Форма, 
			ИдентификаторЗадания = Неопределено, ДекорацияДлительногоОжидания = Неопределено) Экспорт 
	
	ДлительнаяОперация = РаботаСНоменклатуройСлужебныйВызовСервера.СформироватьПредставлениеКарточкиКатегорииВФоне(
		ИдентификаторыКатегорий, Форма.УникальныйИдентификатор, ИдентификаторЗадания);
	
	ПараметрыОжидания = ДлительныеОперацииКлиент.ПараметрыОжидания(Форма);
	ПараметрыОжидания.ВыводитьПрогрессВыполнения = Ложь;
	ПараметрыОжидания.ВыводитьОкноОжидания = ДекорацияДлительногоОжидания = Неопределено;
	ПараметрыОжидания.ОповещениеПользователя.Показать = Ложь;
	ПараметрыОжидания.ВыводитьСообщения = Истина;
	
	ИдентификаторЗадания = ДлительнаяОперация.ИдентификаторЗадания;
	ОповещениеОЗавершении.ДополнительныеПараметры.Вставить("ИдентификаторЗадания", ИдентификаторЗадания);
	
	Если Не ДекорацияДлительногоОжидания = Неопределено
		И Не ДлительнаяОперация = Неопределено
		И ДлительнаяОперация.Статус = "Выполняется" Тогда
		ДекорацияДлительногоОжидания.Картинка = БиблиотекаКартинок.ДлительнаяОперация48;
	КонецЕсли;
	
	ПараметрыЗавершения = Новый Структура;
	ПараметрыЗавершения.Вставить("ОповещениеОЗавершении", ОповещениеОЗавершении);
	
	ДлительнаяОперацияЗавершение = Новый ОписаниеОповещения("ДлительнаяОперацияЗавершение",
		ЭтотОбъект, ПараметрыЗавершения);
	
	ДлительныеОперацииКлиент.ОжидатьЗавершение(ДлительнаяОперация,
		ДлительнаяОперацияЗавершение,
		ПараметрыОжидания);
		
КонецПроцедуры

Процедура ЗагрузитьКатегории(ОповещениеОЗавершении, 
			КатегорииКЗагрузке, 
			Форма, 
			ИдентификаторЗадания = Неопределено, 
			ДекорацияДлительногоОжидания = Неопределено, 
			ДополнительныеПараметры = Неопределено) Экспорт 
	
	ДлительнаяОперация = РаботаСНоменклатуройСлужебныйВызовСервера.ЗагрузитьКатегорииВФоне(
		КатегорииКЗагрузке, Форма.УникальныйИдентификатор, ИдентификаторЗадания, ДополнительныеПараметры);
	
	ПараметрыОжидания = ДлительныеОперацииКлиент.ПараметрыОжидания(Форма);
	ПараметрыОжидания.ВыводитьПрогрессВыполнения = Ложь;
	ПараметрыОжидания.ВыводитьОкноОжидания = ДекорацияДлительногоОжидания = Неопределено;
	ПараметрыОжидания.ОповещениеПользователя.Показать = Ложь;
	ПараметрыОжидания.ВыводитьСообщения = Истина;
	
	ИдентификаторЗадания = ДлительнаяОперация.ИдентификаторЗадания;
	ОповещениеОЗавершении.ДополнительныеПараметры.Вставить("ИдентификаторЗадания", ИдентификаторЗадания);
	
	Если Не ДекорацияДлительногоОжидания = Неопределено
		И Не ДлительнаяОперация = Неопределено
		И ДлительнаяОперация.Статус = "Выполняется" Тогда
		ДекорацияДлительногоОжидания.Картинка = БиблиотекаКартинок.ДлительнаяОперация48;
	КонецЕсли;
	
	ПараметрыЗавершения = Новый Структура;
	ПараметрыЗавершения.Вставить("ОповещениеОЗавершении", ОповещениеОЗавершении);
	
	ДлительнаяОперацияЗавершение = Новый ОписаниеОповещения("ДлительнаяОперацияЗавершение",
		ЭтотОбъект, ПараметрыЗавершения);
	
	ДлительныеОперацииКлиент.ОжидатьЗавершение(ДлительнаяОперация,
		ДлительнаяОперацияЗавершение,
		ПараметрыОжидания);
		
КонецПроцедуры

Процедура ПолучитьДанныеКатегорийСервиса(ОповещениеОЗавершении, ИдентификаторыКатегорий, Форма, 
			ИдентификаторЗадания = Неопределено, ДекорацияДлительногоОжидания = Неопределено) Экспорт
			
	УникальныйИдентификатор 
		= ?(Форма.ВладелецФормы = Неопределено, Форма.УникальныйИдентификатор, Форма.ВладелецФормы.УникальныйИдентификатор);
						
	ДлительнаяОперация = РаботаСНоменклатуройСлужебныйВызовСервера.ПолучитьДанныеКатегорийСервиса(
		ИдентификаторыКатегорий, УникальныйИдентификатор, ИдентификаторЗадания);
	
	ПараметрыОжидания = ДлительныеОперацииКлиент.ПараметрыОжидания(Форма);
	ПараметрыОжидания.ВыводитьПрогрессВыполнения = Ложь;
	ПараметрыОжидания.ВыводитьОкноОжидания = ДекорацияДлительногоОжидания = Неопределено;
	ПараметрыОжидания.ОповещениеПользователя.Показать = Ложь;
	ПараметрыОжидания.ВыводитьСообщения = Истина;
	
	ИдентификаторЗадания = ДлительнаяОперация.ИдентификаторЗадания;
	ОповещениеОЗавершении.ДополнительныеПараметры.Вставить("ИдентификаторЗадания", ИдентификаторЗадания);
	
	Если Не ДекорацияДлительногоОжидания = Неопределено
		И Не ДлительнаяОперация = Неопределено
		И ДлительнаяОперация.Статус = "Выполняется" Тогда
		ДекорацияДлительногоОжидания.Картинка = БиблиотекаКартинок.ДлительнаяОперация16;
	КонецЕсли;
	
	ПараметрыЗавершения = Новый Структура;
	ПараметрыЗавершения.Вставить("ОповещениеОЗавершении", ОповещениеОЗавершении);
	
	ДлительнаяОперацияЗавершение = Новый ОписаниеОповещения("ДлительнаяОперацияЗавершение",
		ЭтотОбъект, ПараметрыЗавершения);
	
	ДлительныеОперацииКлиент.ОжидатьЗавершение(ДлительнаяОперация,
		ДлительнаяОперацияЗавершение,
		ПараметрыОжидания);
		
КонецПроцедуры

// Получить значения дополнительного реквизита, в соответствии с представлением значений базы.
//
// Параметры:
//  ОповещениеОЗавершении		 - ОписаниеОповещения - оповещение для обработки результата.
//  ПараметрыЗапроса - Структура - параметры метода.
//   Ключи:
//    * ИдентификаторКатегории                - Строка - идентификатор категории.
//    * ИдентификаторДополнительногоРеквизита - Строка - идентификатор реквизита.
//    * ИдентификаторКатегории                - Массив (Строка) - строковое представление значений базы.
//  Форма						 - УправляемаяФорма - форма.
//  ИдентификаторЗадания		 - УникальныйИдентификатор - идентификатор задания.
//  ДекорацияДлительногоОжидания - ДекорацияФормы - декорация формы.
//
Процедура ПолучитьЗначенияСоответствующиеЗаданным(ОповещениеОЗавершении, ПараметрыЗапроса, 
			Форма, ИдентификаторЗадания = Неопределено, ДекорацияДлительногоОжидания = Неопределено) Экспорт
	
	ДлительнаяОперация = РаботаСНоменклатуройСлужебныйВызовСервера.ПолучитьЗначенияСоответствующиеЗаданнымВФоне(
		ПараметрыЗапроса, Форма.УникальныйИдентификатор, ИдентификаторЗадания);
	
	ПараметрыОжидания = ДлительныеОперацииКлиент.ПараметрыОжидания(Форма);
	ПараметрыОжидания.ВыводитьПрогрессВыполнения = Ложь;
	ПараметрыОжидания.ВыводитьОкноОжидания = ДекорацияДлительногоОжидания = Неопределено;
	ПараметрыОжидания.ОповещениеПользователя.Показать = Ложь;
	ПараметрыОжидания.ВыводитьСообщения = Истина;
	
	ИдентификаторЗадания = ДлительнаяОперация.ИдентификаторЗадания;
	ОповещениеОЗавершении.ДополнительныеПараметры.Вставить("ИдентификаторЗадания", ИдентификаторЗадания);
	
	Если Не ДекорацияДлительногоОжидания = Неопределено
		И Не ДлительнаяОперация = Неопределено
		И ДлительнаяОперация.Статус = "Выполняется" Тогда
		ДекорацияДлительногоОжидания.Картинка = БиблиотекаКартинок.ДлительнаяОперация16;
	КонецЕсли;
	
	ПараметрыЗавершения = Новый Структура;
	ПараметрыЗавершения.Вставить("ОповещениеОЗавершении", ОповещениеОЗавершении);
	
	ДлительнаяОперацияЗавершение = Новый ОписаниеОповещения("ДлительнаяОперацияЗавершение",
	ЭтотОбъект, ПараметрыЗавершения);
	
	ДлительныеОперацииКлиент.ОжидатьЗавершение(ДлительнаяОперация,
	ДлительнаяОперацияЗавершение,
	ПараметрыОжидания);
	
КонецПроцедуры

#КонецОбласти

#Область РаботаСНоменклатурой

#Область СозданиеНоменклатуры

Процедура СоздатьНоменклатуруИнтерактивно(РезультатВыполнения, ДополнительныеПараметры)
	
	ПараметрыЗавершения = Новый Структура;
	ПараметрыЗавершения.Вставить("ОповещениеОЗавершении", ДополнительныеПараметры.ОповещениеОЗавершении);
	
	СоздатьНоменклатуруИнтерактивноЗавершение = Новый ОписаниеОповещения("СоздатьНоменклатуруИнтерактивноЗавершение",
		ЭтотОбъект, ПараметрыЗавершения);
		
	ПараметрыФормы = Новый Структура;
	
	ПараметрыФормы.Вставить("РаботаСНоменклатурой_АдресДанныхЗаполнения", РезультатВыполнения.АдресДанныхЗаполнения);
		
	РаботаСНоменклатуройКлиентПереопределяемый.СоздатьНоменклатуруИнтерактивно(ПараметрыФормы,
		СоздатьНоменклатуруИнтерактивноЗавершение);
		
КонецПроцедуры

Процедура СоздатьНоменклатуруИнтерактивноЗавершение(Знач НоменклатураСсылка, ДополнительныеПараметры) Экспорт
	
	ДополнительныеПараметры.Свойство("НоменклатураСсылка", НоменклатураСсылка);
	
	Если НЕ ЗначениеЗаполнено(НоменклатураСсылка) Тогда 
		Возврат;
	КонецЕсли;
	
	ИдентификаторНоменклатуры = "";
	
	ДополнительныеПараметры.Свойство("ИдентификаторНоменклатуры", ИдентификаторНоменклатуры);
	
	// Заполнение параметров оповещения.
	
	Шаблон = РаботаСНоменклатуройСлужебныйКлиентСервер.ШаблонДанныхНоменклатуры();
	
	Шаблон.Номенклатура              = НоменклатураСсылка;
	Шаблон.ИдентификаторНоменклатуры = ИдентификаторНоменклатуры;
	
	Результат = Новый Структура();
	Результат.Вставить("ДолжноБытьСоздано", 1);
	Результат.Вставить("НовыеЭлементы", ОбщегоНазначенияКлиентСервер.ЗначениеВМассиве(Шаблон));
	Результат.Вставить("НоменклатураДляАнализа", Неопределено); 
	Результат.Вставить("Создано", ?(ЗначениеЗаполнено(НоменклатураСсылка), 1, 0));

	ВыполнитьОбработкуОповещения(ДополнительныеПараметры.ОповещениеОЗавершении, Результат);
	
КонецПроцедуры

Процедура СоздатьНоменклатуруОбработкаОшибки(ОписаниеОшибки) 
	
	ПараметрыОткрытияФормы = Новый Структура;
	ПараметрыОткрытияФормы.Вставить("Ошибка", ОписаниеОшибки);
	
	ОткрытьФорму("Обработка.РаботаСНоменклатурой.Форма.ОшибкаПокупкиНоменклатуры", ПараметрыОткрытияФормы);
	
КонецПроцедуры

Процедура КупитьКарточкиНоменклатуры(ОповещениеОЗавершении, ИдентификаторыНоменклатуры, 
			Форма, ИдентификаторЗадания = Неопределено, ДекорацияДлительногоОжидания = Неопределено) Экспорт 
	
	ДлительнаяОперация = РаботаСНоменклатуройСлужебныйВызовСервера.КупитьКарточкиНоменклатурыВФоне(
		ИдентификаторыНоменклатуры, Форма.УникальныйИдентификатор, ИдентификаторЗадания);
	
	ПараметрыОжидания = ДлительныеОперацииКлиент.ПараметрыОжидания(Форма);
	ПараметрыОжидания.ВыводитьПрогрессВыполнения = Ложь;
	ПараметрыОжидания.ВыводитьОкноОжидания = ДекорацияДлительногоОжидания = Неопределено;
	ПараметрыОжидания.ОповещениеПользователя.Показать = Ложь;
	ПараметрыОжидания.ВыводитьСообщения = Истина;
	
	ИдентификаторЗадания = ДлительнаяОперация.ИдентификаторЗадания;
	ОповещениеОЗавершении.ДополнительныеПараметры.Вставить("ИдентификаторЗадания", ИдентификаторЗадания);
	
	Если Не ДекорацияДлительногоОжидания = Неопределено
		И Не ДлительнаяОперация = Неопределено
		И ДлительнаяОперация.Статус = "Выполняется" Тогда
		ДекорацияДлительногоОжидания.Картинка = БиблиотекаКартинок.ДлительнаяОперация16;
	КонецЕсли;
	
	ПараметрыЗавершения = Новый Структура;
	ПараметрыЗавершения.Вставить("ОповещениеОЗавершении", ОповещениеОЗавершении);
	
	ДлительнаяОперацияЗавершение = Новый ОписаниеОповещения("ДлительнаяОперацияЗавершение",
		ЭтотОбъект, ПараметрыЗавершения);
	
	ДлительныеОперацииКлиент.ОжидатьЗавершение(ДлительнаяОперация,
		ДлительнаяОперацияЗавершение,
		ПараметрыОжидания);
		
КонецПроцедуры

Процедура ОповеститьПользователяОСоздании(РезультатСоздания, ПризнакОшибки, ПроставитьПризнакЗагрузки, Форма)
	
	РезультатСоздания.Вставить("Форма", Форма);
	
	Если ПризнакОшибки Тогда 
		
		НажатиеОповещенияПользователя = "";
		КартинкаОповещения = БиблиотекаКартинок.Ошибка32;
		ТекстОповещения = НСтр("ru = 'Не удалось создать номенклатуру'");
		
	Иначе
		
		НажатиеОповещенияПользователя = Новый ОписаниеОповещения("НажатиеОповещенияПользователя",
			ЭтотОбъект, РезультатСоздания);
		
		Если РезультатСоздания.Создано = 0 Тогда
			КартинкаОповещения = БиблиотекаКартинок.Предупреждение32;
			ТекстОповещения = НСтр("ru = 'Номенклатура не создана'");
		Иначе
			КартинкаОповещения = БиблиотекаКартинок.Успешно32;
			ТекстОповещения = СтрШаблон(НСтр("ru = 'Создано объектов: %1'"), РезультатСоздания.Создано);
		КонецЕсли;
				
		ПроставитьПризнакЗагрузки = Истина;
				
	КонецЕсли;
	
	ПоказатьОповещениеПользователя(НСтр("ru = 'Загрузка номенклатуры'"),
		НажатиеОповещенияПользователя, ТекстОповещения, КартинкаОповещения,
		СтатусОповещенияПользователя.Информация, Форма.УникальныйИдентификатор);
		
КонецПроцедуры

#КонецОбласти

#Область ПолучениеДанныхПоНоменклатуре

Процедура ПолучитьНоменклатуруПоШтрихкодам(ОповещениеОЗавершении, Штрихкоды, 
			Форма, ИдентификаторЗадания = Неопределено, ДекорацияДлительногоОжидания = Неопределено) Экспорт
	
	ДлительнаяОперация = РаботаСНоменклатуройСлужебныйВызовСервера.ПолучитьНоменклатуруПоШтрихкодамВФоне(
		Штрихкоды, Форма.УникальныйИдентификатор, ИдентификаторЗадания);
	
	ПараметрыОжидания = ДлительныеОперацииКлиент.ПараметрыОжидания(Форма);
	ПараметрыОжидания.ВыводитьПрогрессВыполнения = Ложь;
	ПараметрыОжидания.ВыводитьОкноОжидания = ДекорацияДлительногоОжидания = Неопределено;
	ПараметрыОжидания.ОповещениеПользователя.Показать = Ложь;
	ПараметрыОжидания.ВыводитьСообщения = Истина;
	
	ИдентификаторЗадания = ДлительнаяОперация.ИдентификаторЗадания;
	ОповещениеОЗавершении.ДополнительныеПараметры.Вставить("ИдентификаторЗадания", ИдентификаторЗадания);
	
	Если Не ДекорацияДлительногоОжидания = Неопределено
		И Не ДлительнаяОперация = Неопределено
		И ДлительнаяОперация.Статус = "Выполняется" Тогда
		ДекорацияДлительногоОжидания.Картинка = БиблиотекаКартинок.ДлительнаяОперация16;
	КонецЕсли;
	
	ПараметрыЗавершения = Новый Структура;
	ПараметрыЗавершения.Вставить("ОповещениеОЗавершении", ОповещениеОЗавершении);
	
	ДлительнаяОперацияЗавершение = Новый ОписаниеОповещения("ДлительнаяОперацияЗавершение",
		ЭтотОбъект, ПараметрыЗавершения);
	
	ДлительныеОперацииКлиент.ОжидатьЗавершение(ДлительнаяОперация,
		ДлительнаяОперацияЗавершение,
		ПараметрыОжидания);
		
КонецПроцедуры

Процедура ПолучитьПереченьНоменклатуры(ОповещениеОЗавершении, ПараметрыПоиска, 
			Форма, ИдентификаторЗадания = Неопределено, ДекорацияДлительногоОжидания = Неопределено) Экспорт 
	
	ДлительнаяОперация = РаботаСНоменклатуройСлужебныйВызовСервера.ПолучитьПереченьНоменклатурыВФоне(
		ПараметрыПоиска, Форма.УникальныйИдентификатор, ИдентификаторЗадания);
	
	ПараметрыОжидания = ДлительныеОперацииКлиент.ПараметрыОжидания(Форма);
	ПараметрыОжидания.ВыводитьПрогрессВыполнения = Ложь;
	ПараметрыОжидания.ВыводитьОкноОжидания = ДекорацияДлительногоОжидания = Неопределено;
	ПараметрыОжидания.ОповещениеПользователя.Показать = Ложь;
	ПараметрыОжидания.ВыводитьСообщения = Истина;
	
	ИдентификаторЗадания = ДлительнаяОперация.ИдентификаторЗадания;
	ОповещениеОЗавершении.ДополнительныеПараметры.Вставить("ИдентификаторЗадания", ИдентификаторЗадания);
	
	Если Не ДекорацияДлительногоОжидания = Неопределено
		И Не ДлительнаяОперация = Неопределено
		И ДлительнаяОперация.Статус = "Выполняется" Тогда
		ДекорацияДлительногоОжидания.Картинка = БиблиотекаКартинок.ДлительнаяОперация16;
	КонецЕсли;
	
	ПараметрыЗавершения = Новый Структура;
	ПараметрыЗавершения.Вставить("ОповещениеОЗавершении", ОповещениеОЗавершении);
	
	ДлительнаяОперацияЗавершение = Новый ОписаниеОповещения("ДлительнаяОперацияЗавершение",
		ЭтотОбъект, ПараметрыЗавершения);
	
	ДлительныеОперацииКлиент.ОжидатьЗавершение(ДлительнаяОперация,
		ДлительнаяОперацияЗавершение,
		ПараметрыОжидания);
		
	КонецПроцедуры
	
Процедура СформироватьПредставленияКарточекНоменклатуры(
			ОповещениеОЗавершении, 
			ИдентификаторыНоменклатуры, 
			Форма, 
			ИдентификаторЗадания = Неопределено, 
			ДекорацияДлительногоОжидания = Неопределено, 
			ЭтоРежимПросмотра = Ложь) Экспорт 
	
	ДлительнаяОперация = РаботаСНоменклатуройСлужебныйВызовСервера.СформироватьПредставленияКарточекНоменклатурыВФоне(
		ИдентификаторыНоменклатуры, ЭтоРежимПросмотра, Форма.УникальныйИдентификатор, ИдентификаторЗадания);
	
	ПараметрыОжидания = ДлительныеОперацииКлиент.ПараметрыОжидания(Форма);
	ПараметрыОжидания.ВыводитьПрогрессВыполнения = Ложь;
	ПараметрыОжидания.ВыводитьОкноОжидания = ДекорацияДлительногоОжидания = Неопределено;
	ПараметрыОжидания.ОповещениеПользователя.Показать = Ложь;
	ПараметрыОжидания.ВыводитьСообщения = Истина;
	
	ИдентификаторЗадания = ДлительнаяОперация.ИдентификаторЗадания;
	ОповещениеОЗавершении.ДополнительныеПараметры.Вставить("ИдентификаторЗадания", ИдентификаторЗадания);
	
	Если ДекорацияДлительногоОжидания <> Неопределено
		И ДлительнаяОперация <> Неопределено
		И ДлительнаяОперация.Статус = "Выполняется" Тогда
		
		ДекорацияДлительногоОжидания.Картинка = БиблиотекаКартинок.ДлительнаяОперация48;
	КонецЕсли;
	
	ПараметрыЗавершения = Новый Структура;
	ПараметрыЗавершения.Вставить("ОповещениеОЗавершении", ОповещениеОЗавершении);
	
	ДлительнаяОперацияЗавершение = Новый ОписаниеОповещения("ДлительнаяОперацияЗавершение",
		ЭтотОбъект, ПараметрыЗавершения);
	
	ДлительныеОперацииКлиент.ОжидатьЗавершение(ДлительнаяОперация,
		ДлительнаяОперацияЗавершение,
		ПараметрыОжидания);
		
КонецПроцедуры
	
Процедура ПолучитьДанныеНоменклатурыСервиса(ОповещениеОЗавершении, ИдентификаторыНоменклатуры, 
			Форма, ИдентификаторЗадания = Неопределено, ДекорацияДлительногоОжидания = Неопределено) Экспорт
			
	УникальныйИдентификатор 
		= ?(Форма.ВладелецФормы = Неопределено, Форма.УникальныйИдентификатор, Форма.ВладелецФормы.УникальныйИдентификатор);
			
	ДлительнаяОперация = РаботаСНоменклатуройСлужебныйВызовСервера.ПолучитьДанныеНоменклатурыСервиса(
		ИдентификаторыНоменклатуры, УникальныйИдентификатор, ИдентификаторЗадания);
	
	ПараметрыОжидания = ДлительныеОперацииКлиент.ПараметрыОжидания(Форма);
	ПараметрыОжидания.ВыводитьПрогрессВыполнения = Ложь;
	ПараметрыОжидания.ВыводитьОкноОжидания = ДекорацияДлительногоОжидания = Неопределено;
	ПараметрыОжидания.ОповещениеПользователя.Показать = Ложь;
	ПараметрыОжидания.ВыводитьСообщения = Истина;
	
	ИдентификаторЗадания = ДлительнаяОперация.ИдентификаторЗадания;
	ОповещениеОЗавершении.ДополнительныеПараметры.Вставить("ИдентификаторЗадания", ИдентификаторЗадания);
	
	Если Не ДекорацияДлительногоОжидания = Неопределено
		И Не ДлительнаяОперация = Неопределено
		И ДлительнаяОперация.Статус = "Выполняется" Тогда
		ДекорацияДлительногоОжидания.Картинка = БиблиотекаКартинок.ДлительнаяОперация16;
	КонецЕсли;
	
	ПараметрыЗавершения = Новый Структура;
	ПараметрыЗавершения.Вставить("ОповещениеОЗавершении", ОповещениеОЗавершении);
	
	ДлительнаяОперацияЗавершение = Новый ОписаниеОповещения("ДлительнаяОперацияЗавершение",
		ЭтотОбъект, ПараметрыЗавершения);
	
	ДлительныеОперацииКлиент.ОжидатьЗавершение(ДлительнаяОперация,
		ДлительнаяОперацияЗавершение,
		ПараметрыОжидания);
		
КонецПроцедуры

#КонецОбласти

#КонецОбласти

#Область РаботаСХарактеристиками

Процедура ЗагрузитьХарактеристики(ОповещениеОЗавершении, ПараметрыСоздания, Форма, 
			ИдентификаторЗадания = Неопределено, ДекорацияДлительногоОжидания = Неопределено) Экспорт
	
	ДлительнаяОперация = РаботаСНоменклатуройСлужебныйВызовСервера.ЗагрузитьХарактеристикиДляНоменклатурыВФоне(
		ПараметрыСоздания, Форма.УникальныйИдентификатор, ИдентификаторЗадания);
	
	ПараметрыОжидания = ДлительныеОперацииКлиент.ПараметрыОжидания(Форма);
	ПараметрыОжидания.ВыводитьПрогрессВыполнения = Ложь;
	ПараметрыОжидания.ВыводитьОкноОжидания = ДекорацияДлительногоОжидания = Неопределено;
	ПараметрыОжидания.ОповещениеПользователя.Показать = Ложь;
	ПараметрыОжидания.ВыводитьСообщения = Истина;
	
	ИдентификаторЗадания = ДлительнаяОперация.ИдентификаторЗадания;
	ОповещениеОЗавершении.ДополнительныеПараметры.Вставить("ИдентификаторЗадания", ИдентификаторЗадания);
	
	Если Не ДекорацияДлительногоОжидания = Неопределено
		И Не ДлительнаяОперация = Неопределено
		И ДлительнаяОперация.Статус = "Выполняется" Тогда
		ДекорацияДлительногоОжидания.Картинка = БиблиотекаКартинок.ДлительнаяОперация16;
	КонецЕсли;
	
	ПараметрыЗавершения = Новый Структура;
	ПараметрыЗавершения.Вставить("ОповещениеОЗавершении", ОповещениеОЗавершении);
	ПараметрыЗавершения.Вставить("Форма",                 Форма);
	
	ДлительнаяОперацияЗавершение = Новый ОписаниеОповещения("ДлительнаяОперацияЗавершение",
		ЭтотОбъект, ПараметрыЗавершения);
	
	ДлительныеОперацииКлиент.ОжидатьЗавершение(ДлительнаяОперация,
		ДлительнаяОперацияЗавершение,
		ПараметрыОжидания);
	
КонецПроцедуры

Процедура ПолучитьДанныеХарактеристикСервиса(ОповещениеОЗавершении, ПараметрыЗапросаХарактеристик, 
			Форма, ИдентификаторЗадания = Неопределено, ДекорацияДлительногоОжидания = Неопределено) Экспорт
	
	ДлительнаяОперация = РаботаСНоменклатуройСлужебныйВызовСервера.ПолучитьДанныеХарактеристикВФоне(
		ПараметрыЗапросаХарактеристик, Форма.УникальныйИдентификатор, ИдентификаторЗадания);
	
	ПараметрыОжидания = ДлительныеОперацииКлиент.ПараметрыОжидания(Форма);
	ПараметрыОжидания.ВыводитьПрогрессВыполнения = Ложь;
	ПараметрыОжидания.ВыводитьОкноОжидания = ДекорацияДлительногоОжидания = Неопределено;
	ПараметрыОжидания.ОповещениеПользователя.Показать = Ложь;
	ПараметрыОжидания.ВыводитьСообщения = Истина;
	
	ИдентификаторЗадания = ДлительнаяОперация.ИдентификаторЗадания;
	ОповещениеОЗавершении.ДополнительныеПараметры.Вставить("ИдентификаторЗадания", ИдентификаторЗадания);
	
	Если Не ДекорацияДлительногоОжидания = Неопределено
		И Не ДлительнаяОперация = Неопределено
		И ДлительнаяОперация.Статус = "Выполняется" Тогда
		ДекорацияДлительногоОжидания.Картинка = БиблиотекаКартинок.ДлительнаяОперация16;
	КонецЕсли;
	
	ПараметрыЗавершения = Новый Структура;
	ПараметрыЗавершения.Вставить("ОповещениеОЗавершении", ОповещениеОЗавершении);
	ПараметрыЗавершения.Вставить("Форма",                 Форма);
	
	ДлительнаяОперацияЗавершение = Новый ОписаниеОповещения("ДлительнаяОперацияЗавершение",
		ЭтотОбъект, ПараметрыЗавершения);
	
	ДлительныеОперацииКлиент.ОжидатьЗавершение(ДлительнаяОперация,
		ДлительнаяОперацияЗавершение,
		ПараметрыОжидания);
	
КонецПроцедуры

#КонецОбласти

#Область РаботаСРекламнымиЗаписями

Процедура ЗакэшироватьИзображенияБаннеров(ОповещениеОЗавершении, ИдентификаторыИсточников, 
			Форма, ИдентификаторЗадания = Неопределено) Экспорт 
	
	ДлительнаяОперация = РаботаСНоменклатуройСлужебныйВызовСервера.ЗакэшироватьИзображенияБаннеровФоне(
		ИдентификаторыИсточников, Форма.УникальныйИдентификатор, ИдентификаторЗадания);
	
	ПараметрыОжидания = ДлительныеОперацииКлиент.ПараметрыОжидания(Форма);
	ПараметрыОжидания.ВыводитьПрогрессВыполнения = Ложь;
	ПараметрыОжидания.ВыводитьОкноОжидания = Ложь;
	ПараметрыОжидания.ОповещениеПользователя.Показать = Ложь;
	ПараметрыОжидания.ВыводитьСообщения = Истина;
	
	ПараметрыЗавершения = Новый Структура;
	ПараметрыЗавершения.Вставить("ОповещениеОЗавершении", ОповещениеОЗавершении);
	
	ДлительнаяОперацияЗавершение = Новый ОписаниеОповещения("ДлительнаяОперацияЗавершение",
		ЭтотОбъект, ПараметрыЗавершения);
	
	ДлительныеОперацииКлиент.ОжидатьЗавершение(ДлительнаяОперация,
		ДлительнаяОперацияЗавершение,
		ПараметрыОжидания);

	
КонецПроцедуры

#КонецОбласти

#Область СостояниеСервиса

Процедура ПроверитьСостояниеСервисаЗавершение(Результат, ДополнительныеПараметры) Экспорт
	
	Если Результат = Неопределено Тогда // отменено пользователем.
		Состояние =  РаботаСНоменклатуройСлужебныйКлиентСервер.ОписаниеСостоянияСервиса();
	Иначе
		Состояние = ПолучитьИзВременногоХранилища(Результат.АдресРезультата);
	КонецЕсли;
	
	Если Не ЗначениеЗаполнено(Состояние) Тогда
		Состояние = РаботаСНоменклатуройСлужебныйКлиентСервер.ОписаниеСостоянияСервиса();
	КонецЕсли;
	
	ВыполнитьОбработкуОповещения(ДополнительныеПараметры.ОповещениеОЗавершении, Состояние);
	
КонецПроцедуры

Процедура ПроверитьСостояниеСервиса(ОповещениеОЗавершении, Форма, ИдентификаторЗадания = Неопределено) Экспорт
	
	ДлительнаяОперация = РаботаСНоменклатуройСлужебныйВызовСервера.ПроверитьСостояниеСервисаВФоне(
		Форма.УникальныйИдентификатор, ИдентификаторЗадания);
	
	ПараметрыОжидания = ДлительныеОперацииКлиент.ПараметрыОжидания(Форма);
	ПараметрыОжидания.ВыводитьПрогрессВыполнения = Ложь;
	ПараметрыОжидания.ВыводитьОкноОжидания = Ложь;
	ПараметрыОжидания.ОповещениеПользователя.Показать = Ложь;
	ПараметрыОжидания.ВыводитьСообщения = Истина;
	
	ИдентификаторЗадания = ДлительнаяОперация.ИдентификаторЗадания;
	ОповещениеОЗавершении.ДополнительныеПараметры.Вставить("ИдентификаторЗадания", ИдентификаторЗадания);
	
	ПараметрыЗавершения = Новый Структура;
	ПараметрыЗавершения.Вставить("ОповещениеОЗавершении", ОповещениеОЗавершении);
	
	ПроверитьСостояниеСервисаЗавершение = Новый ОписаниеОповещения("ПроверитьСостояниеСервисаЗавершение",
		ЭтотОбъект, ПараметрыЗавершения);
	
	ПараметрыЗавершения = Новый Структура;
	ПараметрыЗавершения.Вставить("ОповещениеОЗавершении", ПроверитьСостояниеСервисаЗавершение);
	
	ДлительнаяОперацияЗавершение = Новый ОписаниеОповещения("ДлительнаяОперацияЗавершение",
		ЭтотОбъект, ПараметрыЗавершения);
	
	ДлительныеОперацииКлиент.ОжидатьЗавершение(ДлительнаяОперация,
		ДлительнаяОперацияЗавершение,
		ПараметрыОжидания);
		
КонецПроцедуры

Процедура ПодключитьТестовыйПериодЗавершение(Результат, ДополнительныеПараметры) Экспорт
	
	Если Результат = ПредопределенноеЗначение("Перечисление.СостоянияПодключенияСервисов.Подключен") Тогда
		Результат = Истина;
	ИначеЕсли Результат = ПредопределенноеЗначение("Перечисление.СостоянияПодключенияСервисов.Подключение") Тогда 
		Результат = Неопределено;
	Иначе
		Результат = Ложь;
	КонецЕсли;
		
	Если ТипЗнч(ДополнительныеПараметры) = Тип("Структура")
		И ДополнительныеПараметры.Свойство("ОбработчикЗавершения") 
		И ДополнительныеПараметры.ОбработчикЗавершения <> Неопределено Тогда
		
		ВыполнитьОбработкуОповещения(ДополнительныеПараметры.ОбработчикЗавершения, Результат);
		
	КонецЕсли;
	
КонецПроцедуры

Процедура ПодключитьТестовыйПериод(
		Владелец,
		ДополнительныеПараметрыОбработчика,
		ОбработчикПриЗакрытииФормы = Неопределено) Экспорт
	
	ДополнительныеПараметры = Новый Структура;
	ДополнительныеПараметры.Вставить("Владелец",                    Владелец);
	ДополнительныеПараметры.Вставить("ОбработчикПриЗакрытииФормы",  ОбработчикПриЗакрытииФормы);
	ДополнительныеПараметры.Вставить("ОбработчикЗавершения",
		ДополнительныеПараметрыОбработчика.ОбработчикЗавершения);
	
	ОповещениеПриЗавершенииПодключения = Новый ОписаниеОповещения(
		"ПодключитьТестовыйПериодЗавершение",
		ЭтотОбъект,
		ДополнительныеПараметры);
	
	ПодключениеСервисовСопровожденияКлиент.ПодключитьТестовыйПериод(
		РаботаСНоменклатуройСлужебныйКлиентСервер.ИдентификаторСервиса(),
		Владелец,
		ОповещениеПриЗавершенииПодключения);
	
КонецПроцедуры

#КонецОбласти

#Область ВспомогательныеМетоды

Процедура ЗаполнитьПараметрыЗакрытия(Форма)
	
	Если Форма.ОписаниеОповещенияОЗакрытии = Неопределено Тогда
		Возврат;
	КонецЕсли;
	
	ПараметрыЗакрытия = Новый Структура;
	
	ПараметрыЗакрытия.Вставить("НоменклатураСсылка",        Форма.РаботаСНоменклатурой_СсылкаНаОбъект);
	ПараметрыЗакрытия.Вставить("ИдентификаторНоменклатуры", Форма.РаботаСНоменклатурой_ИдентификаторОбъектаСервиса);
	
	Если ТипЗнч(Форма.ОписаниеОповещенияОЗакрытии.ДополнительныеПараметры) = Тип("Неопределено") Тогда
		Форма.ОписаниеОповещенияОЗакрытии.ДополнительныеПараметры = ПараметрыЗакрытия;
	ИначеЕсли ТипЗнч(Форма.ОписаниеОповещенияОЗакрытии.ДополнительныеПараметры) = Тип("Структура") Тогда	
		ОбщегоНазначенияКлиентСервер.ДополнитьСтруктуру(
			Форма.ОписаниеОповещенияОЗакрытии.ДополнительныеПараметры, ПараметрыЗакрытия, Истина);
	КонецЕсли;
	
КонецПроцедуры

Процедура ОбработкаВыбораНоменклатуры(ДанныеВыбора, 
			ДополнительныеПараметры, 
			ДанныеИнтерактивногоЗаполнения, 
			ОповещениеОЗакрытии)
	
	Форма = ДополнительныеПараметры.Форма;
	
	ИдентификаторыВыбранныхХарактеристик = Новый СписокЗначений;
		
	ВыбранныеОбъекты = ДанныеВыбора.ВыбранныеОбъекты[0];
	
	Если ЗначениеЗаполнено(ВыбранныеОбъекты.ИдентификаторХарактеристики) Тогда
		ИдентификаторыВыбранныхХарактеристик.Добавить(ВыбранныеОбъекты.ИдентификаторХарактеристики);
	КонецЕсли;
	
	ПараметрыФормы = Новый Структура;
	
	ПараметрыФормы.Вставить("ИдентификаторНоменклатуры", ВыбранныеОбъекты.ИдентификаторНоменклатуры);
	ПараметрыФормы.Вставить("Номенклатура",              Форма.РаботаСНоменклатурой_СсылкаНаОбъект);
	
	Если ЗначениеЗаполнено(Форма.РаботаСНоменклатурой_СсылкаНаОбъект)
		И РаботаСНоменклатуройСлужебныйВызовСервера.НоменклатураСопоставлена(
			Форма.РаботаСНоменклатурой_СсылкаНаОбъект, ВыбранныеОбъекты.ИдентификаторНоменклатуры) Тогда
		
		Оповещение = Новый ОписаниеОповещения("ПослеСопоставленияХарактеристик", 
			ЭтотОбъект, Новый Структура("Форма", Форма));		
				
		Если ЗначениеЗаполнено(ВыбранныеОбъекты.ИдентификаторХарактеристики) Тогда
			// Если выбрана характеристика привязанной номенклатуры - открывается форма привязки характеристики.
			
			ПараметрыФормы.Вставить("ИдентификаторХарактеристики", ВыбранныеОбъекты.ИдентификаторХарактеристики);
			ПараметрыФормы.Вставить("НаименованиеНоменклатуры",    ВыбранныеОбъекты.НаименованиеНоменклатуры);
			ПараметрыФормы.Вставить("НаименованиеХарактеристики",  ВыбранныеОбъекты.НаименованиеХарактеристики);
						
			ОткрытьФорму("Обработка.РаботаСНоменклатурой.Форма.ПривязкаХарактеристики", ПараметрыФормы, Форма,,,,Оповещение);	
			
		Иначе			
			// Если выбрана номенклатура у которой есть характеристики, при этом она уже сопоставлена с текущей 
			// - открывается форма сопоставления характеристик.			
			
			ПараметрыФормыСопоставления = ПараметрыФормыСопоставленияХарактеристик();
			
			ЗаполнитьЗначенияСвойств(ПараметрыФормыСопоставления, ПараметрыФормы);
			
			ПараметрыФормыСопоставления.НаименованиеНоменклатурыСервиса = ВыбранныеОбъекты.НаименованиеНоменклатуры;
			
			ОткрытьФормуСопоставленияХарактеристик(ПараметрыФормы, Форма, Оповещение);
			
		КонецЕсли;
	Иначе
		
		// В случае привязки к новой 1С:Номенклатуры - открывается окно заполнения номенклатуры
		
		ПараметрыФормы.Вставить("НоменклатураНаименование",             ВыбранныеОбъекты.НаименованиеНоменклатуры);
		ПараметрыФормы.Вставить("ДанныеИнтерактивногоЗаполнения",       ДанныеИнтерактивногоЗаполнения);
		ПараметрыФормы.Вставить("ИдентификаторыВыбранныхХарактеристик", ИдентификаторыВыбранныхХарактеристик);
		ПараметрыФормы.Вставить("ЭтоПривязка",                          Истина);
		
		ОткрытьФормуЗаполненияНоменклатуры(Форма, ПараметрыФормы, ОповещениеОЗакрытии);
		
	КонецЕсли;
	
КонецПроцедуры

Процедура ОбработкаВыбораКатегории(ДанныеВыбора, 
			ДополнительныеПараметры, 
			ДанныеИнтерактивногоЗаполнения, 
			ОповещениеОЗакрытии)
	
	Форма            = ДополнительныеПараметры.Форма;
	ВыбранныеОбъекты = ДанныеВыбора.ВыбранныеОбъекты;
	
	ИдентификаторыКатегорий = Новый СписокЗначений;
	
	Для каждого ЭлементКоллекции Из ВыбранныеОбъекты Цикл
		ИдентификаторыКатегорий.Добавить(ЭлементКоллекции.Идентификатор, ЭлементКоллекции.Наименование);
	КонецЦикла;
	
	ПараметрыФормы = ПараметрыФормыЗаполненияВидаНоменклатуры();
	
	ПараметрыФормы.ВидНоменклатуры                = Форма.РаботаСНоменклатурой_СсылкаНаОбъект;
	ПараметрыФормы.ИдентификаторыКатегорий        = ИдентификаторыКатегорий;
	ПараметрыФормы.ДанныеИнтерактивногоЗаполнения = ДанныеИнтерактивногоЗаполнения;
	ПараметрыФормы.РежимЗагрузкиХарактеристик     = Форма.РаботаСНоменклатурой_РежимЗагрузкиХарактеристик;
	ПараметрыФормы.ЭтоПривязка                    = Истина;	
	
	ОткрытьФормуЗаполненияВидаНоменклатуры(
		ПараметрыФормы, ДополнительныеПараметры.Форма, ОповещениеОЗакрытии);
			
КонецПроцедуры

Процедура ЗагрузитьНоменклатуруПродолжение(Знач Результат, ДополнительныеПараметры) Экспорт
	
	Если Результат = Неопределено Тогда // отменено пользователем
		Возврат;
	Иначе
		ВывестиСообщения(Результат);
		
		Если ЭтоАдресВременногоХранилища(Результат.АдресРезультата) Тогда
			РезультатВыполнения = ПолучитьИзВременногоХранилища(Результат.АдресРезультата);
		Иначе
			Возврат;	
		КонецЕсли;
		
	КонецЕсли;
			
	Если РезультатВыполнения = Неопределено Тогда
		Возврат;
	КонецЕсли;
	
	Если РезультатВыполнения.ЕстьОшибки Тогда // есть ошибки создания
		ПоказатьУведомлениеОбОшибке(РезультатВыполнения);	
		Возврат;		
	КонецЕсли;
	
	Если РезультатВыполнения.СозданиеИнтерактивно Тогда 
		СоздатьНоменклатуруИнтерактивно(РезультатВыполнения, ДополнительныеПараметры); // интерактивное создание номенклатуры	
	Иначе
		ЗагрузитьНоменклатуруЗавершение(РезультатВыполнения, ДополнительныеПараметры);	
	КонецЕсли;
	
КонецПроцедуры

Процедура ПоказатьУведомлениеОбОшибке(РезультатВыполнения)
	
	КартинкаОповещения = БиблиотекаКартинок.Ошибка32;
	ТекстОповещения = НСтр("ru = 'Создать не удалось'");
	ПоказатьОповещениеПользователя(НСтр("ru = 'Создание номенклатуры'"),,
		ТекстОповещения, КартинкаОповещения,
		СтатусОповещенияПользователя.Информация);
	
	СоздатьНоменклатуруОбработкаОшибки(РезультатВыполнения.ОписаниеОшибки);
	
КонецПроцедуры

Процедура ДлительнаяОперацияЗавершение(Результат, ДополнительныеПараметры) Экспорт 
	
	Отказ = Ложь;
	ТекстСообщения = "";
	ВыводитьОшибки = Истина;
	
	Если ДополнительныеПараметры.Свойство("ВыводитьОшибки") Тогда 
		ВыводитьОшибки = ДополнительныеПараметры.ВыводитьОшибки;
	КонецЕсли;
	
	Если Результат = Неопределено Тогда // Отменено пользователем.
		Отказ = Истина;
		ТекстСообщения = НСтр("ru = 'Фоновое задание отменено пользователем'");
		Возврат;
	КонецЕсли;
	
	Если Не Отказ И Результат.Статус = "Выполнено" Тогда
		
		Если ЗначениеЗаполнено(Результат.АдресРезультата)
			И ЭтоАдресВременногоХранилища(Результат.АдресРезультата) Тогда
			
			ВыполнитьОбработкуОповещения(ДополнительныеПараметры.ОповещениеОЗавершении, Результат);
			
		КонецЕсли;
		ИдентификаторЗадания = Неопределено;
		
	ИначеЕсли Результат.Статус = "Ошибка" Тогда
		Отказ = Истина;
		ТекстСообщения = Результат.КраткоеПредставлениеОшибки;
	КонецЕсли;
	
	Если Отказ Тогда
		Если Не ПустаяСтрока(ТекстСообщения) И ВыводитьОшибки Тогда
			ОбщегоНазначенияКлиентСервер.СообщитьПользователю(
				СтроковыеФункцииКлиентСервер.ПодставитьПараметрыВСтроку(НСтр("ru = '%1 %2'"),
					ОбщегоНазначенияКлиент.ДатаСеанса(), ТекстСообщения));
		КонецЕсли;
	КонецЕсли;

КонецПроцедуры

Функция ЭтоФормаНастройки(Форма)
	
	Возврат Форма.ИмяФормы = "Обработка.РаботаСНоменклатурой.Форма.НастройкаЗагрузкиНоменклатурыОдиночная" 
		ИЛИ Форма.ИмяФормы = "Обработка.РаботаСНоменклатурой.Форма.НастройкаЗагрузкиНоменклатурыМножественная";
		
КонецФункции

Процедура НажатиеОповещенияПользователя(ДополнительныеПараметры) Экспорт 
	
	Номенклатура = Новый Массив;
	
	Для каждого ЭлементКоллекции Из ДополнительныеПараметры.НовыеЭлементы Цикл
		Если Номенклатура.Найти(ЭлементКоллекции.Номенклатура) = Неопределено Тогда
			Номенклатура.Добавить(ЭлементКоллекции.Номенклатура);
		КонецЕсли;
	КонецЦикла;
	
	ПараметрыОткрытияФормыСписка = Новый Структура();
	ПараметрыОткрытияФормыСписка.Вставить("Отбор", Новый Структура("Ссылка", Номенклатура));
	
	ИмяФормыСпискаНоменклатуры = РаботаСНоменклатуройСлужебныйВызовСервера.ИмяФормыСпискаНоменклатуры();
	
	Если ЗначениеЗаполнено(ИмяФормыСпискаНоменклатуры) Тогда
		ОткрытьФорму(ИмяФормыСпискаНоменклатуры, ПараметрыОткрытияФормыСписка, ДополнительныеПараметры.Форма, ДополнительныеПараметры.Форма.УникальныйИдентификатор);
	КонецЕсли;
	
КонецПроцедуры

Процедура ВывестиСообщения(Результат)
	
	Если Результат.Свойство("Сообщения") И Результат.Сообщения <> Неопределено Тогда
		Для каждого Сообщение Из Результат.Сообщения Цикл
			Сообщение.Сообщить();
		КонецЦикла;
	КонецЕсли;
		
КонецПроцедуры

Процедура ЗагрузитьНоменклатуруЗавершение(РезультатСоздания, ДополнительныеПараметры)
		
	Ошибка = Ложь;
	ПроставитьПризнакЗагрузки = Ложь;
	
	ОповеститьПользователяОСоздании(РезультатСоздания, Ошибка, ПроставитьПризнакЗагрузки, ДополнительныеПараметры.Форма);
	
	Если Ошибка Тогда 
		Возврат;
	КонецЕсли;
	
	Если ЗначениеЗаполнено(РезультатСоздания.НовыеЭлементы) Тогда
		ВыполнитьОбработкуОповещения(ДополнительныеПараметры.ОповещениеОЗавершении, РезультатСоздания);		
	КонецЕсли;
		
	Если ЗначениеЗаполнено(РезультатСоздания.НоменклатураДляАнализа) 
		И Не ЭтоФормаНастройки(ДополнительныеПараметры.Форма) Тогда
		
		ОткрытьФормуНастройкиЗагрузкиНоменклатуры(РезультатСоздания, ДополнительныеПараметры);	
	КонецЕсли;
		
КонецПроцедуры	

Процедура ПослеСопоставленияХарактеристик(Результат, ДополнительныеПараметры) Экспорт
	
	Если Результат = Неопределено Тогда
		Возврат;
	КонецЕсли;
	
	Форма = ДополнительныеПараметры.Форма;
	
	Если Не Результат.Свойство("КоличествоСопоставленныхХарактеристик") Тогда
		Форма.Элементы.РаботаСНоменклатурой_Характеристики.Заголовок 
			= РаботаСНоменклатуройСлужебныйВызовСервера.ПредставлениеСопоставленныхХарактеристик(Форма.РаботаСНоменклатурой_СсылкаНаОбъект);
	Иначе
		Форма.Элементы.РаботаСНоменклатурой_Характеристики.Заголовок 
			= СтрШаблон(
				НСтр("ru = 'Сопоставлено характеристик: %1 из %2'"), 
					Формат(Результат.КоличествоСопоставленныхХарактеристик, "ЧЦ=15; ЧН="),
					Формат(Результат.КоличествоХарактеристикВсего, "ЧЦ=15; ЧН="));
	КонецЕсли;
				
	Форма.Прочитать();
		
КонецПроцедуры

Процедура ЗагрузитьХарактеристикиЗавершение(Результат, ДополнительныеПараметры) Экспорт
	
	Если Не ЭтоАдресВременногоХранилища(Результат.АдресРезультата) Тогда
		Возврат;
	КонецЕсли;
	
	Форма = ДополнительныеПараметры.Форма;
	
	Форма.РаботаСНоменклатурой_ИдентификаторыХарактеристик.Очистить();
	Форма.РаботаСНоменклатурой_РежимЗагрузкиХарактеристик = "Загружены";
	
	РезультатСоздания = ПолучитьИзВременногоХранилища(Результат.АдресРезультата);
	
	ПоказатьОповещениеПользователя(
		НСтр("ru = 'Создание характеристик'"), Неопределено, 
		СтрШаблон(НСтр("ru = 'Создано характеристик: %1'"), РезультатСоздания.КоличествоСозданныхОбъектов));
			
	Если Форма.РаботаСНоменклатурой_ЗакрытьФормуПослеСозданияОбъектов Тогда
		
		// Если была нажата кнопка "Записать и закрыть" - форма закрывается.
		
		Форма.РаботаСНоменклатурой_ЭтоЗаписьОбъекта = Ложь;
		Форма.Закрыть();
	Иначе
		Форма.Элементы.РаботаСНоменклатурой_Характеристики.Заголовок 	
			= РаботаСНоменклатуройСлужебныйВызовСервера.ПредставлениеСопоставленныхХарактеристик(Форма.РаботаСНоменклатурой_СсылкаНаОбъект);
			
		Если РезультатСоздания.КоличествоСозданныхОбъектов > 0 Тогда
			Форма.Элементы.РаботаСНоменклатурой_Характеристики.Видимость = Истина;
			Форма.Элементы.РаботаСНоменклатурой_Характеристики.Доступность = Истина;
		КонецЕсли;
		
		Форма.Прочитать();
		
	КонецЕсли;		
	
КонецПроцедуры

#КонецОбласти

#Область ДиалогПереключенияНаАвтообновление

Процедура ПоказатьВопросПриВключенииАвтообновленияНоменклатуры(Номенклатура, ИдентификаторНоменклатуры, Форма) Экспорт
	
	Оповещение = Новый ОписаниеОповещения("ПриОтветеНаВопросАвтоматическогоОбновления", 
		ЭтотОбъект, Новый Структура("ОбъектОбновления, Форма, Идентификатор", Номенклатура, Форма, ИдентификаторНоменклатуры));
	
	ТекстВопроса = 
		НСтр("ru = 'При включении автоматического режима обновления, произойдет заполнение текущей номенклатуры
			|на основании данных сервиса. Объект будет записан. Продолжить?'");
	
	ПоказатьВопрос(Оповещение, ТекстВопроса, РежимДиалогаВопрос.ДаНет);
		
КонецПроцедуры

Процедура ПоказатьВопросПриВключенииАвтообновленияВидаНоменклатуры(ВидНоменклатуры, 
			ИдентификаторыКатегорий, Форма) Экспорт
	
	Оповещение = Новый ОписаниеОповещения("ПриОтветеНаВопросАвтоматическогоОбновления", 
		ЭтотОбъект, Новый Структура("ОбъектОбновления, Форма, Идентификатор", ВидНоменклатуры, Форма, ИдентификаторыКатегорий));
	
	ТекстВопроса = 
		НСтр("ru = 'При включении автоматического режима обновления, произойдет заполнение текущего вида номенклатуры
			|на основании данных сервиса. Объект будет записан. Продолжить?'");
	
	ПоказатьВопрос(Оповещение, ТекстВопроса, РежимДиалогаВопрос.ДаНет);
	
КонецПроцедуры

Процедура ПриОтветеНаВопросАвтоматическогоОбновления(Ответ, ДополнительныеПараметры) Экспорт 
	
	Если Ответ = КодВозвратаДиалога.Нет Тогда
		Возврат;
	КонецЕсли;
	
	СлужебныеФормы = Новый Массив;
	
	СлужебныеФормы.Добавить("Обработка.РаботаСНоменклатурой.Форма.ЗаполнениеНоменклатуры");
	СлужебныеФормы.Добавить("Обработка.РаботаСНоменклатурой.Форма.ЗаполнениеВидаНоменклатуры");
	
	Форма = ДополнительныеПараметры.Форма;
	
	Если СлужебныеФормы.Найти(Форма.ИмяФормы) = Неопределено Тогда
		ФормаОбъекта = Форма;
	Иначе
		ФормаОбъекта = Форма.ВладелецФормы;
	КонецЕсли;
	
	Если ФормаОбъекта.Модифицированность Тогда
		ФормаОбъекта.РаботаСНоменклатурой_ИгнорироватьПроверкуЗаполнения = Истина;
		Если НЕ ФормаОбъекта.Записать() Тогда
			Возврат;
		КонецЕсли;
	КонецЕсли;
	
	ФормаОбъекта.РазблокироватьДанныеФормыДляРедактирования();
	
	ОбъектОбновления = Неопределено;
	
	Если ДополнительныеПараметры.Свойство("ОбъектОбновления")
		И ЗначениеЗаполнено(ДополнительныеПараметры.ОбъектОбновления) Тогда
		
		ОбъектОбновления = ДополнительныеПараметры.ОбъектОбновления;
	Иначе
		ОбъектОбновления = Форма.РаботаСНоменклатурой_СсылкаНаОбъект;	
	КонецЕсли;
	
	РаботаСНоменклатуройСлужебныйВызовСервера.ОбновитьОбъектИнформационнойБазы(
		ОбъектОбновления, ДополнительныеПараметры.Идентификатор);

	Если СлужебныеФормы.Найти(Форма.ИмяФормы) = Неопределено Тогда
		
		// Закрытие прикладных форм
		
		Если Форма.РаботаСНоменклатурой_РежимПредставленияОбъектаСервиса = "ПолеВвода" Тогда
			Форма.Элементы.РежимОбновления.Картинка 
				= БиблиотекаКартинок.АвтоматическоеОбновлениеРаботаСНоменклатурой;
		Иначе
			РаботаСНоменклатуройСлужебныйКлиентСервер.НастроитьВидимостьГиперссылок(Форма);
		КонецЕсли;		
		
		Форма.РаботаСНоменклатурой_ОбъектСервисаИзменен = Ложь;
		
		Форма.Прочитать();
	Иначе 
		
		// Закрытие форм заполнения
		
		Форма.Закрыть(Новый Структура("АвтоматическийРежимОбновления", Истина));		
		
	КонецЕсли; 
	
КонецПроцедуры
	
#КонецОбласти

#Область ОбновлениеДанных

Процедура ПолучитьОбновленияВидовНоменклатуры(ОповещениеОЗавершении, ОбновляемыеОбъекты, Форма = Неопределено, 
			ИдентификаторЗадания = Неопределено, ДекорацияДлительногоОжидания = Неопределено) Экспорт 
	
	ДлительнаяОперация = РаботаСНоменклатуройСлужебныйВызовСервера.ПолучитьОбновленияВидовНоменклатурыВФоне(
		ОбновляемыеОбъекты, Форма.УникальныйИдентификатор, ИдентификаторЗадания);
	
	ПараметрыОжидания = ДлительныеОперацииКлиент.ПараметрыОжидания(Форма);
	ПараметрыОжидания.ВыводитьПрогрессВыполнения = Ложь;
	ПараметрыОжидания.ВыводитьОкноОжидания = ДекорацияДлительногоОжидания = Неопределено;
	ПараметрыОжидания.ОповещениеПользователя.Показать = Ложь;
	ПараметрыОжидания.ВыводитьСообщения = Истина;
	
	ИдентификаторЗадания = ДлительнаяОперация.ИдентификаторЗадания;
	ОповещениеОЗавершении.ДополнительныеПараметры.Вставить("ИдентификаторЗадания", ИдентификаторЗадания);
	
	Если Не ДекорацияДлительногоОжидания = Неопределено
		И Не ДлительнаяОперация = Неопределено
		И ДлительнаяОперация.Статус = "Выполняется" Тогда
		ДекорацияДлительногоОжидания.Картинка = БиблиотекаКартинок.ДлительнаяОперация16;
	КонецЕсли;
	
	ПараметрыЗавершения = Новый Структура;
	ПараметрыЗавершения.Вставить("ОповещениеОЗавершении", ОповещениеОЗавершении);
	
	ДлительнаяОперацияЗавершение = Новый ОписаниеОповещения("ДлительнаяОперацияЗавершение",
		ЭтотОбъект, ПараметрыЗавершения);
	
	ДлительныеОперацииКлиент.ОжидатьЗавершение(ДлительнаяОперация,
		ДлительнаяОперацияЗавершение,
		ПараметрыОжидания);

	
КонецПроцедуры
	
Процедура ПолучитьОбновленияНоменклатуры(ОповещениеОЗавершении, ОбновляемыеОбъекты, Форма = Неопределено, 
			ИдентификаторЗадания = Неопределено, ДекорацияДлительногоОжидания = Неопределено) Экспорт 
	
	ДлительнаяОперация = РаботаСНоменклатуройСлужебныйВызовСервера.ПолучитьОбновленияНоменклатурыВФоне(
		ОбновляемыеОбъекты, Форма.УникальныйИдентификатор, ИдентификаторЗадания);
	
	ПараметрыОжидания = ДлительныеОперацииКлиент.ПараметрыОжидания(Форма);
	ПараметрыОжидания.ВыводитьПрогрессВыполнения = Ложь;
	ПараметрыОжидания.ВыводитьОкноОжидания = ДекорацияДлительногоОжидания = Неопределено;
	ПараметрыОжидания.ОповещениеПользователя.Показать = Ложь;
	ПараметрыОжидания.ВыводитьСообщения = Истина;
	
	ИдентификаторЗадания = ДлительнаяОперация.ИдентификаторЗадания;
	ОповещениеОЗавершении.ДополнительныеПараметры.Вставить("ИдентификаторЗадания", ИдентификаторЗадания);
	
	Если Не ДекорацияДлительногоОжидания = Неопределено
		И Не ДлительнаяОперация = Неопределено
		И ДлительнаяОперация.Статус = "Выполняется" Тогда
		ДекорацияДлительногоОжидания.Картинка = БиблиотекаКартинок.ДлительнаяОперация16;
	КонецЕсли;
	
	ПараметрыЗавершения = Новый Структура;
	ПараметрыЗавершения.Вставить("ОповещениеОЗавершении", ОповещениеОЗавершении);
	
	ДлительнаяОперацияЗавершение = Новый ОписаниеОповещения("ДлительнаяОперацияЗавершение",
		ЭтотОбъект, ПараметрыЗавершения);
	
	ДлительныеОперацииКлиент.ОжидатьЗавершение(ДлительнаяОперация,
		ДлительнаяОперацияЗавершение,
		ПараметрыОжидания);

	
КонецПроцедуры
	
#КонецОбласти

#КонецОбласти

