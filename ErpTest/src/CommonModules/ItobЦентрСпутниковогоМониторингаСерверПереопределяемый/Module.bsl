////////////////////////////////////////////////////////////////////////////////
// Обработка событий переопределяемых процедур с Центром спутникового мониторинга
// 
////////////////////////////////////////////////////////////////////////////////

#Область СлужебныеПроцедурыИФункции

#Область ПереопределяемыеПроцедуры
	
////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
// ПЕРЕОПРЕДЕЛЯЕМЫЕ ПРОЦЕДУРЫ
////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////

Процедура ЗаполнитьРегистрСвойстваТранспортныхСредствПереопределяемый(ЗаписьРегистра, Источник)

	// Здесь можно описать заполнение регистра "СвойстваТранспортныхСредств" по соответствующим полям документов.
	//	Рег.МодельТС           = Источник.Модель;
	//	Рег.Организация        = Источник.Организация;

КонецПроцедуры

#КонецОбласти 

#Область ПроцедурыЗаполненияВСоставеТиповыхОбъектовЦСМ

////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
// ПРОЦЕДУРЫ ЗАПОЛНЕНИЯ В СОСТАВЕ ТИПОВЫХ ОБЪЕКТОВ ЦСМ
////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////

// Дополнительная обработка записи транспортного средства
//
Процедура ЗаписьТранспортногоСредстваПриЗаписи(Источник, Отказ) Экспорт
	
	Если Источник.ОбменДанными.Загрузка Тогда 
		Возврат;
	КонецЕсли;
	
	УстановитьПривилегированныйРежим(Истина);
	
	Выборка = РегистрыСведений.ItobСвойстваТранспортныхСредств.Выбрать(Новый Структура("ТранспортноеСредство", Источник.Ссылка));
	Если ItobОбщегоНазначенияСервер.ВыборкаСледующий(Выборка) Тогда
		Рег = Выборка.ПолучитьМенеджерЗаписи();
	Иначе
		Рег = РегистрыСведений.ItobСвойстваТранспортныхСредств.СоздатьМенеджерЗаписи();
		Рег.ТранспортноеСредство = Источник.Ссылка;
	КонецЕсли;
	
	Если Источник.Метаданные().Имя = "ItobТранспортныеСредства" И Источник.Метаданные().Реквизиты.Найти("Марка")<> Неопределено Тогда
		Рег.МодельТС           = Источник.Марка;		
		Рег.Организация        = Источник.Организация;
	Иначе		
		ЗаполнитьРегистрСвойстваТранспортныхСредствПереопределяемый(Рег, Источник);	
	КонецЕсли;
	
	Рег.Записать(Истина);
	
	// Перенесено из модуля формы справочника ТС
	Если Источник.уатИспользуемаяСистемаGPS = Перечисления.уатСистемаGPS._1СЦСМ Тогда
		Выборка = РегистрыСведений.ItobНастройкиОтображенияОбъектов.Выбрать(Новый Структура("Объект", Источник.Ссылка));
		Пока Выборка.Следующий() Цикл
			Запись = Выборка.ПолучитьМенеджерЗаписи();
		КонецЦикла;
		Запись = ?(Запись = Неопределено, РегистрыСведений.ItobНастройкиОтображенияОбъектов.СоздатьМенеджерЗаписи(), Запись); 
		Запись.Объект	 		   = Источник.Ссылка;
		Запись.ЦветМаршрутаНаКарте = Источник.уатЦветМаршрутаНаКарте;
		Запись.ИконкаНаКарте 	   = Источник.уатИконкаНаКарте;
		Запись.Записать(Истина);
	КонецЕсли;
	
	УстановитьПривилегированныйРежим(Ложь);
	
КонецПроцедуры

#КонецОбласти 

#КонецОбласти
