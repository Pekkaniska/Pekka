
////////////////////////////////////////////////////////////////////////////////
// Процедуры и функции для работы со сформированными документами типовых конфигураций.
//  
////////////////////////////////////////////////////////////////////////////////

#Область ПрограммныйИнтерфейс

// Процедура обрабатывает нажатие кнопки "ТД" в формах списков документов,
//	на основании которых могут формироваться типовые документы
//
Процедура ВвестиТиповойДокумент(Знач Оповещение, ДокументУАТ) Экспорт
	
	ТипДок = Неопределено;
	ЕстьТипДок = уатТиповыеДокументы.НайтиТиповойДокументДляДокументаУАТ(ДокументУАТ, ТипДок);
	
	Если ЕстьТипДок ИЛИ (уатТиповыеДокументы.ЕстьПравоРедактированияРегистраТД()
		И (ТипЗнч(ДокументУАТ) = Тип("ДокументСсылка.уатПутевойЛист")
		ИЛИ ТипЗнч(ДокументУАТ) = Тип("ДокументСсылка.уатТТД")
		ИЛИ ТипЗнч(ДокументУАТ) = Тип("ДокументСсылка.уатСливГСМ")
		ИЛИ ТипЗнч(ДокументУАТ) = Тип("ДокументСсылка.уатЗаказГрузоотправителя"))) Тогда
		ОткрытьФорму("ОбщаяФорма.уатВводТиповогоДокумента", Новый Структура("ТД, ДокУАТ", ТипДок, ДокументУАТ),,,,,
			Новый ОписаниеОповещения("ВвестиТиповойДокументЗавершениеФорма", ЭтотОбъект,
			Новый Структура("ДокументУАТ, Оповещение", ДокументУАТ, Оповещение)), РежимОткрытияОкнаФормы.БлокироватьВесьИнтерфейс);
		Возврат;
	КонецЕсли;
	
	Рез = Новый Структура("ДопПараметры");
	ВвестиТиповойДокументФрагмент1(ДокументУАТ, Оповещение, Рез);
	
КонецПроцедуры

Процедура ВвестиТиповойДокументЗавершениеФорма(Результат, ДополнительныеПараметры) Экспорт
    
    ДокументУАТ = ДополнительныеПараметры.ДокументУАТ;
    Оповещение = ДополнительныеПараметры.Оповещение;
    
    
    Рез = Результат;
    Если ТипЗнч(Рез) = Тип("Структура") И Рез.Действие = "Сформировать" Тогда
        //далее формируем новый ТД
    Иначе
        ВыполнитьОбработкуОповещения(Оповещение);
        Возврат;
    КонецЕсли;
    
    ВвестиТиповойДокументФрагмент1(ДокументУАТ, Оповещение, Рез);

КонецПроцедуры

Процедура ВвестиТиповойДокументЗавершениеПометкаУдаления(ДополнительныеПараметры) Экспорт
    
    ДокументУАТ = ДополнительныеПараметры.ДокументУАТ;
    Оповещение = ДополнительныеПараметры.Оповещение;
    Рез = ДополнительныеПараметры.Рез;
    
    
    ВвестиТиповойДокументФрагмент(Оповещение);

КонецПроцедуры

Процедура ВвестиТиповойДокументЗавершение(ДополнительныеПараметры) Экспорт
    
    ДокументУАТ = ДополнительныеПараметры.ДокументУАТ;
    Оповещение = ДополнительныеПараметры.Оповещение;
    ПроведениеДокументаУАТразрешено = ДополнительныеПараметры.ПроведениеДокументаУАТразрешено;
    Рез = ДополнительныеПараметры.Рез;
    
    
    ВвестиТиповойДокументФрагмент(Оповещение);

КонецПроцедуры

#КонецОбласти

#Область СлужебныеПроцедурыИФункции

Процедура ВвестиТиповойДокументФрагмент1(Знач ДокументУАТ, Знач Оповещение, Знач Рез)
	
	ПроведениеДокументаУАТразрешено = уатТиповыеДокументы.ПроведениеДокументаУАТразрешено(ДокументУАТ);
	
	Если Не уатТиповыеДокументы.ЕстьПравоРедактированияРегистраТД() Тогда 
		ДанныеОповещения = Новый Структура();
		ДанныеОповещения.Вставить("ДокументУАТ",                     ДокументУАТ);
		ДанныеОповещения.Вставить("Оповещение",                      Оповещение);
		ДанныеОповещения.Вставить("ПроведениеДокументаУАТразрешено", ПроведениеДокументаУАТразрешено);
		ДанныеОповещения.Вставить("Рез",                             Рез);
		
		ОписаниеОповещения = Новый ОписаниеОповещения("ВвестиТиповойДокументЗавершение", ЭтотОбъект, ДанныеОповещения);
		
		ТекстПредупреждения = НСтр("ru = 'Недостаточно прав для формирования типовых документов.'");
		
		ПоказатьПредупреждение(ОписаниеОповещения, ТекстПредупреждения, 10);
		Возврат;
	КонецЕсли;
	
	Если ПроведениеДокументаУАТразрешено И (НЕ уатОбщегоНазначенияТиповые.ПолучитьЗначениеРеквизита(ДокументУАТ, "Проведен")) Тогда
		ПоказатьПредупреждение(Новый ОписаниеОповещения("ВвестиТиповойДокументЗавершение", ЭтотОбъект,
			Новый Структура("ДокументУАТ, Оповещение, ПроведениеДокументаУАТразрешено, Рез",
			ДокументУАТ, Оповещение, ПроведениеДокументаУАТразрешено, Рез)),
			"Формировать типовой документ можно только для проведенного документа!", 10);
		Возврат;
		
	ИначеЕсли (НЕ ПроведениеДокументаУАТразрешено) И уатОбщегоНазначенияТиповые.ПолучитьЗначениеРеквизита(ДокументУАТ, "ПометкаУдаления") Тогда
		ПоказатьПредупреждение(Новый ОписаниеОповещения("ВвестиТиповойДокументЗавершениеПометкаУдаления", ЭтотОбъект,
			Новый Структура("ДокументУАТ, Оповещение, Рез", ДокументУАТ, Оповещение, Рез)),
			"Формировать типовой документ можно только для не помеченного на удаление документа!", 10);
			
		Возврат;
	КонецЕсли;
	
	уатТиповыеДокументы.ВвестиТиповойДокументСервер(ДокументУАТ, Рез.ДопПараметры);
	ВыполнитьОбработкуОповещения(Оповещение);
	
КонецПроцедуры

Процедура ВвестиТиповойДокументФрагмент(Знач Оповещение)
    
    ВыполнитьОбработкуОповещения(Оповещение);
    
КонецПроцедуры

#КонецОбласти
