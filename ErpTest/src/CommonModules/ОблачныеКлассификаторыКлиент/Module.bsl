////////////////////////////////////////////////////////////////////////////////
// Подсистема "Облачные классификаторы".
// ОбщийМодуль.ОблачныеКлассификаторыКлиент.
////////////////////////////////////////////////////////////////////////////////

#Область ПрограммныйИнтерфейс

// Открытие формы подбора элементов классификатора ТН ВЭД из сервиса.
//
// Параметры:
//  НастройкиРежима	 - Структура - (необязательный) настройки режима открытия формы, ключи:
//                     АльтернативныйСпособПодбора  - ОписаниеОповещения - процедура открытия альтернативной
//                                                    формы подбора элементов классификатора (например,
//                                                    подбора из макета); в случае передачи параметра,
//                                                    будет выполнена проверка использования функциональной
//                                                    опции ИспользоватьСервисРаботаСНоменклатурой,
//                                                    входа в ИПП, а также доступности сервиса 1С:Номенклатура;
//                                                    при положительном результате проверки открыта форма подбора
//                                                    из сервиса, иначе - выполнена обработка оповещения;
//                     РежимВыбораЭлемента          - Булево - открытие формы в режиме выбора элемента
//                                                    вместо режима подбора и загрузки данных в базу;
//                     КодВыбранногоЭлемента        - Строка - код элемента классификатора, на котором
//                                                    необходимо спозиционироваться при открытии формы
//                                                    (только для РежимВыбораЭлемента = Истина);
//                     Владелец                     - УправляемаяФорма - владелец открываемой формы;
//                     ОбработчикЗавершения         - ОписаниеОповещения - описание оповещения, которое
//                                                    будет выполнено после интерактивного выбора элемента
//                                                    в форме (только для РежимВыбораЭлемента = Истина).
//                                                    В параметр Результат обработчика будет возвращена
//                                                    структура с данными выбранного элемента.
//                                                    Ключи структуры идентичны именам колонок таблицы значений,
//                                                    см. СоздатьОбновитьЭлементыТНВЭД() общего модуля
//                                                    ОблачныеКлассификаторыПереопределяемый.
//
Процедура ПодобратьИзСервисаЭлементыТНВЭД(НастройкиРежима = Неопределено) Экспорт
		
	Если НастройкиРежима = Неопределено Тогда
		НастройкиРежима = Новый Структура;
	КонецЕсли;
	
	Если Не НастройкиРежима.Свойство("АльтернативныйСпособПодбора") Тогда
		НастройкиРежима.Вставить("АльтернативныйСпособПодбора");
	КонецЕсли;
	
	Если Не НастройкиРежима.Свойство("РежимВыбораЭлемента") Тогда
		НастройкиРежима.Вставить("РежимВыбораЭлемента", Ложь);
	КонецЕсли;
	
	Если Не НастройкиРежима.Свойство("КодВыбранногоЭлемента") Тогда
		НастройкиРежима.Вставить("КодВыбранногоЭлемента", "");
	КонецЕсли;
	
	Если Не НастройкиРежима.Свойство("Владелец") Тогда
		НастройкиРежима.Вставить("Владелец");
	КонецЕсли;
	
	Если Не НастройкиРежима.Свойство("ОбработчикЗавершения") Тогда
		НастройкиРежима.Вставить("ОбработчикЗавершения");
	КонецЕсли;
	
	Если НастройкиРежима.АльтернативныйСпособПодбора = Неопределено Тогда
		НачатьПодборИзСервисаЭлементовТНВЭД(НастройкиРежима);
	Иначе
		
		Если ОблачныеКлассификаторыСлужебныйВызовСервера.ДоступенОнлайнПодборИзКлассификатораТНВЭД() Тогда
			НачатьПодборИзСервисаЭлементовТНВЭД(НастройкиРежима);
		Иначе
			ВыполнитьОбработкуОповещения(НастройкиРежима.АльтернативныйСпособПодбора);
		КонецЕсли;
		
	КонецЕсли;
	
КонецПроцедуры

#КонецОбласти

#Область СлужебныйПрограммныйИнтерфейс

Процедура ПолучитьРазделыТНВЭД(ОповещениеОЗавершении, Форма, ИдентификаторЗадания = Неопределено,
		КоличествоЗаданий = 0) Экспорт
	
	ДлительнаяОперация = ОблачныеКлассификаторыСлужебныйВызовСервера.ПолучитьРазделыТНВЭДВФоне(
		Форма.УникальныйИдентификатор, ИдентификаторЗадания);
	
	ПараметрыОжидания = ДлительныеОперацииКлиент.ПараметрыОжидания(Форма);
	ПараметрыОжидания.ВыводитьПрогрессВыполнения = Ложь;
	ПараметрыОжидания.ВыводитьОкноОжидания = Ложь;
	ПараметрыОжидания.ОповещениеПользователя.Показать = Ложь;
	ПараметрыОжидания.ВыводитьСообщения = Истина;
	
	ИдентификаторЗадания = ДлительнаяОперация.ИдентификаторЗадания;
	ОповещениеОЗавершении.ДополнительныеПараметры.Вставить("ИдентификаторЗадания", ИдентификаторЗадания);
	
	Если ДлительнаяОперация <> Неопределено
		И ДлительнаяОперация.Статус = "Выполняется" Тогда
		КоличествоЗаданий = КоличествоЗаданий + 1;
	КонецЕсли;
		
	ПараметрыЗавершения = Новый Структура;
	ПараметрыЗавершения.Вставить("ОповещениеОЗавершении", ОповещениеОЗавершении);
	
	ДлительнаяОперацияЗавершение = Новый ОписаниеОповещения("ДлительнаяОперацияЗавершение",
	РаботаСНоменклатуройКлиент, ПараметрыЗавершения);
	
	ДлительныеОперацииКлиент.ОжидатьЗавершение(ДлительнаяОперация,
	ДлительнаяОперацияЗавершение,
	ПараметрыОжидания);
	
КонецПроцедуры

Процедура ПолучитьПодчиненныеЭлементыТНВЭД(Код, ОповещениеОЗавершении, Форма, ИдентификаторЗадания = Неопределено,
		КоличествоЗаданий = 0) Экспорт
	
	ДлительнаяОперация = ОблачныеКлассификаторыСлужебныйВызовСервера.ПолучитьПодчиненныеЭлементыТНВЭДВФоне(Код,
		Форма.УникальныйИдентификатор, ИдентификаторЗадания);
	
	ПараметрыОжидания = ДлительныеОперацииКлиент.ПараметрыОжидания(Форма);
	ПараметрыОжидания.ВыводитьПрогрессВыполнения = Ложь;
	ПараметрыОжидания.ВыводитьОкноОжидания = Ложь;
	ПараметрыОжидания.ОповещениеПользователя.Показать = Ложь;
	ПараметрыОжидания.ВыводитьСообщения = Истина;
	
	ИдентификаторЗадания = ДлительнаяОперация.ИдентификаторЗадания;
	ОповещениеОЗавершении.ДополнительныеПараметры.Вставить("ИдентификаторЗадания", ИдентификаторЗадания);
	
	Если ДлительнаяОперация <> Неопределено
		И ДлительнаяОперация.Статус = "Выполняется" Тогда
		КоличествоЗаданий = КоличествоЗаданий + 1;
	КонецЕсли;
		
	ПараметрыЗавершения = Новый Структура;
	ПараметрыЗавершения.Вставить("ОповещениеОЗавершении", ОповещениеОЗавершении);
	
	ДлительнаяОперацияЗавершение = Новый ОписаниеОповещения("ДлительнаяОперацияЗавершение",
	РаботаСНоменклатуройКлиент, ПараметрыЗавершения);
	
	ДлительныеОперацииКлиент.ОжидатьЗавершение(ДлительнаяОперация,
	ДлительнаяОперацияЗавершение,
	ПараметрыОжидания);
	
КонецПроцедуры

Процедура ОбработатьПоисковыйЗапросТНВЭД(СтрокаПоиска, НомерСтраницы, ОповещениеОЗавершении, Форма,
		ИдентификаторЗадания = Неопределено, КоличествоЗаданий = 0) Экспорт
	
	ДлительнаяОперация = ОблачныеКлассификаторыСлужебныйВызовСервера.ОбработатьПоисковыйЗапросТНВЭДВФоне(СтрокаПоиска,
		НомерСтраницы, Форма.УникальныйИдентификатор, ИдентификаторЗадания);
	
	ПараметрыОжидания = ДлительныеОперацииКлиент.ПараметрыОжидания(Форма);
	ПараметрыОжидания.ВыводитьПрогрессВыполнения = Ложь;
	ПараметрыОжидания.ВыводитьОкноОжидания = Ложь;
	ПараметрыОжидания.ОповещениеПользователя.Показать = Ложь;
	ПараметрыОжидания.ВыводитьСообщения = Истина;
	
	ИдентификаторЗадания = ДлительнаяОперация.ИдентификаторЗадания;
	ОповещениеОЗавершении.ДополнительныеПараметры.Вставить("ИдентификаторЗадания", ИдентификаторЗадания);
	
	Если ДлительнаяОперация <> Неопределено
		И ДлительнаяОперация.Статус = "Выполняется" Тогда
		КоличествоЗаданий = КоличествоЗаданий + 1;
	КонецЕсли;
		
	ПараметрыЗавершения = Новый Структура;
	ПараметрыЗавершения.Вставить("ОповещениеОЗавершении", ОповещениеОЗавершении);
	
	ДлительнаяОперацияЗавершение = Новый ОписаниеОповещения("ДлительнаяОперацияЗавершение",
	РаботаСНоменклатуройКлиент, ПараметрыЗавершения);
	
	ДлительныеОперацииКлиент.ОжидатьЗавершение(ДлительнаяОперация,
	ДлительнаяОперацияЗавершение,
	ПараметрыОжидания);
	
КонецПроцедуры

Процедура ПолучитьВеткуТНВЭД(Код, АдресКэша, РежимВыбораЭлемента, ОповещениеОЗавершении, Форма,
		ИдентификаторЗадания = Неопределено, КоличествоЗаданий = 0) Экспорт
	
	ДлительнаяОперация = ОблачныеКлассификаторыСлужебныйВызовСервера.ПолучитьВеткуТНВЭДВФоне(Код, АдресКэша,
		РежимВыбораЭлемента, Форма.УникальныйИдентификатор, ИдентификаторЗадания);
		
	ПараметрыОжидания = ДлительныеОперацииКлиент.ПараметрыОжидания(Форма);
	ПараметрыОжидания.ВыводитьПрогрессВыполнения = Ложь;
	ПараметрыОжидания.ВыводитьОкноОжидания = Ложь;
	ПараметрыОжидания.ОповещениеПользователя.Показать = Ложь;
	ПараметрыОжидания.ВыводитьСообщения = Истина;
	
	ИдентификаторЗадания = ДлительнаяОперация.ИдентификаторЗадания;
	ОповещениеОЗавершении.ДополнительныеПараметры.Вставить("ИдентификаторЗадания", ИдентификаторЗадания);
	
	Если ДлительнаяОперация <> Неопределено
		И ДлительнаяОперация.Статус = "Выполняется" Тогда
		КоличествоЗаданий = КоличествоЗаданий + 1;
	КонецЕсли;
		
	ПараметрыЗавершения = Новый Структура;
	ПараметрыЗавершения.Вставить("ОповещениеОЗавершении", ОповещениеОЗавершении);
	
	ДлительнаяОперацияЗавершение = Новый ОписаниеОповещения("ДлительнаяОперацияЗавершение",
	РаботаСНоменклатуройКлиент, ПараметрыЗавершения);
	
	ДлительныеОперацииКлиент.ОжидатьЗавершение(ДлительнаяОперация,
	ДлительнаяОперацияЗавершение,
	ПараметрыОжидания);
	
КонецПроцедуры

Процедура ЗагрузитьВБазуДанныеТНВЭД(АдресКэша, ВыбранныеЭлементы, ОповещениеОЗавершении, Форма,
		ИдентификаторЗадания = Неопределено, ОбновитьКэш = Ложь) Экспорт
	
	ДлительнаяОперация = ОблачныеКлассификаторыСлужебныйВызовСервера.ЗагрузитьВБазуДанныеТНВЭДВФоне(АдресКэша,
		ВыбранныеЭлементы, Форма.УникальныйИдентификатор, ИдентификаторЗадания, ОбновитьКэш);
		
	ПараметрыОжидания = ДлительныеОперацииКлиент.ПараметрыОжидания(Форма);
	ПараметрыОжидания.ВыводитьПрогрессВыполнения = Ложь;
	ПараметрыОжидания.ВыводитьОкноОжидания = Истина;
	ПараметрыОжидания.ОповещениеПользователя.Показать = Ложь;
	ПараметрыОжидания.ВыводитьСообщения = Истина;
	
	ИдентификаторЗадания = ДлительнаяОперация.ИдентификаторЗадания;
	ОповещениеОЗавершении.ДополнительныеПараметры.Вставить("ИдентификаторЗадания", ИдентификаторЗадания);
		
	ПараметрыЗавершения = Новый Структура;
	ПараметрыЗавершения.Вставить("ОповещениеОЗавершении", ОповещениеОЗавершении);
	
	ДлительныеОперацииКлиент.ОжидатьЗавершение(ДлительнаяОперация,
	ОповещениеОЗавершении,
	ПараметрыОжидания);
	
КонецПроцедуры

#КонецОбласти

#Область СлужебныеПроцедурыИФункции

Процедура НачатьПодборИзСервисаЭлементовТНВЭД(НастройкиРежима)

	ОценкаПроизводительностиКлиент.НачатьЗамерВремени(Истина,
	"ОбщийМодуль.ОблачныеКлассификаторыКлиент.НачатьПодборИзСервисаЭлементовТНВЭД");
	
	ПараметрыОткрытия = Новый Структура("РежимВыбораЭлемента, КодВыбранногоЭлемента",
		НастройкиРежима.РежимВыбораЭлемента, НастройкиРежима.КодВыбранногоЭлемента);
	
	ОткрытьФорму("Обработка.РаботаСОблачнымиКлассификаторами.Форма.КлассификаторТНВЭД", ПараметрыОткрытия,
		НастройкиРежима.Владелец,,,, НастройкиРежима.ОбработчикЗавершения);

КонецПроцедуры

#КонецОбласти