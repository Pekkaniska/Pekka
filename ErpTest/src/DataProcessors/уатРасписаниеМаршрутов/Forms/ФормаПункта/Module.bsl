&НаКлиенте
Процедура ОсновныеДействияФормыОК(Команда)
	спрМаршрутСсылка = ОсновныеДействияФормыОК_Сервер();
	Закрыть(спрМаршрутСсылка);
КонецПроцедуры

&НаСервере
Функция ОсновныеДействияФормыОК_Сервер()
	спрМаршрут = Маршрут.ПолучитьОбъект();
	
	Если ЭтоНовый Тогда
		НоваяСтрока 					= спрМаршрут.Этапы.Добавить();
		НоваяСтрока.ПунктОтправления 	= Пункт;
		НоваяСтрока.УИД					= СформироватьУИД(спрМаршрут.Этапы);
	Иначе
		мСтрока = спрМаршрут.Этапы.Найти(УИДПункта, "УИД");
		Если мСтрока <> Неопределено Тогда
			мСтрока.ПунктОтправления	= Пункт;		
		КонецЕсли;
	КонецЕсли;
	
	спрМаршрут.Записать();
	
	Возврат спрМаршрут.Ссылка;
КонецФункции

// Функция возвращает новый УИД для таблицы этапов.
//Новый УИД = Количество этапов + 1.
//
//Возвращаемое значение:
//	Число - номер нового этапа маршрута.
//
&НаСервере
Функция СформироватьУИД(Этапы)
	
	мТаблица = Этапы.Выгрузить();
	мТаблица.Сортировать("УИД Возр");
	мКоличество = мТаблица.Количество();
	Если мКоличество > 0 Тогда
		мУИД = мТаблица[мКоличество-1].УИД + 1;
	Иначе
		мУИД = 1;
	КонецЕсли;
	
	Возврат мУИД;
	
КонецФункции //СформироватьУИД

&НаКлиенте
Процедура ОсновныеДействияФормыОтмена(Команда)
	Закрыть();
КонецПроцедуры


&НаСервере
Процедура ПриСозданииНаСервере(Отказ, СтандартнаяОбработка)
	Если Параметры.Свойство("Маршрут") Тогда
		Маршрут = Параметры.Маршрут;
	КонецЕсли;
	Если Параметры.Свойство("Пункт") Тогда
		Пункт = Параметры.Пункт;
	КонецЕсли;
	Если Параметры.Свойство("УИДПункта") Тогда
		УИДПункта = Параметры.УИДПункта;
	КонецЕсли;
	Если Параметры.Свойство("ЭтоНовый") Тогда
		ЭтоНовый = Параметры.ЭтоНовый;
	КонецЕсли;
	Заголовок = ?(ЭтоНовый, "Добавить пункт", "Изменить пункт");
КонецПроцедуры
