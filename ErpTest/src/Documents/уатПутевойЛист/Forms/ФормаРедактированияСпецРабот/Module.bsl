
#Область ОбработчикиСобытийФормы

&НаСервере
Процедура ПриСозданииНаСервере(Отказ, СтандартнаяОбработка)
	
	Параметры.Свойство("СпецРабота1", СпецРабота1);
	Параметры.Свойство("СпецРабота2", СпецРабота2);
	Параметры.Свойство("СпецРабота3", СпецРабота3);
	Параметры.Свойство("СпецРабота4", СпецРабота4);
	Параметры.Свойство("СпецРабота5", СпецРабота5);
	
	Если Параметры.Свойство("КоличествоСпецРаботы1") Тогда 
		Если СпецРабота1.Временный Тогда 
			КоличествоСпецРаботы1 = уатОбщегоНазначения.уатВремяВЧЧ_ММ(Параметры.КоличествоСпецРаботы1);
		Иначе 
			КоличествоСпецРаботы1 = Параметры.КоличествоСпецРаботы1;
		КонецЕсли;
	КонецЕсли;
	Если Параметры.Свойство("КоличествоСпецРаботы2") Тогда 
		Если СпецРабота2.Временный Тогда 
			КоличествоСпецРаботы2 = уатОбщегоНазначения.уатВремяВЧЧ_ММ(Параметры.КоличествоСпецРаботы2);
		Иначе 
			КоличествоСпецРаботы2 = Параметры.КоличествоСпецРаботы2;
		КонецЕсли;
	КонецЕсли;
	Если Параметры.Свойство("КоличествоСпецРаботы3") Тогда 
		Если СпецРабота3.Временный Тогда 
			КоличествоСпецРаботы3 = уатОбщегоНазначения.уатВремяВЧЧ_ММ(Параметры.КоличествоСпецРаботы3);
		Иначе 
			КоличествоСпецРаботы3 = Параметры.КоличествоСпецРаботы3;
		КонецЕсли;
	КонецЕсли;
	Если Параметры.Свойство("КоличествоСпецРаботы4") Тогда 
		Если СпецРабота4.Временный Тогда 
			КоличествоСпецРаботы4 = уатОбщегоНазначения.уатВремяВЧЧ_ММ(Параметры.КоличествоСпецРаботы4);
		Иначе 
			КоличествоСпецРаботы4 = Параметры.КоличествоСпецРаботы4;
		КонецЕсли;
	КонецЕсли;
	Если Параметры.Свойство("КоличествоСпецРаботы5") Тогда 
		Если СпецРабота5.Временный Тогда 
			КоличествоСпецРаботы5 = уатОбщегоНазначения.уатВремяВЧЧ_ММ(Параметры.КоличествоСпецРаботы5);
		Иначе 
			КоличествоСпецРаботы5 = Параметры.КоличествоСпецРаботы5;
		КонецЕсли;
	КонецЕсли;
	
	Если Параметры.Свойство("ТС") Тогда
		Если Параметры.ТС.уатМодель.НаличиеСпидометра Тогда
			НадписьПояснение = НСтр("ru = 'Значение общего пробега уменьшается на пробег спец. работ при расчете расхода ГСМ.'");
		Иначе
			НадписьПояснение = НСтр("ru = 'Значение времени в работе уменьшается на время спец. работ при расчете расхода ГСМ.'");
		КонецЕсли;
	Иначе
		Элементы.НадписьПояснение.Видимость = Ложь;
	КонецЕсли;
	
	УстановитьВидимостьДоступность();
	
	//По логике установка ТолькоПросмотр = Истина для формы должна блокировать все контролы.
	//Но нет, 1С считает по другому. Поэтому приходится писать этот костыль
	Если ТолькоПросмотр Тогда
		Элементы.ГруппаВерх.ТолькоПросмотр = Истина;
	КонецЕсли;
	
КонецПроцедуры

#КонецОбласти

#Область ОбработчикиСобытийЭлементовШапкиФормы

&НаКлиенте
Процедура СпецРабота1ПриИзменении(Элемент)
	
	УстановитьВидимостьДоступность();
	КоличествоСпецРаботы1 = Неопределено;
	
КонецПроцедуры

&НаКлиенте
Процедура СпецРабота2ПриИзменении(Элемент)
	
	УстановитьВидимостьДоступность();
	КоличествоСпецРаботы2 = Неопределено;
	
КонецПроцедуры

&НаКлиенте
Процедура СпецРабота3ПриИзменении(Элемент)
	
	УстановитьВидимостьДоступность();
	КоличествоСпецРаботы3 = Неопределено;
	
КонецПроцедуры

&НаКлиенте
Процедура СпецРабота4ПриИзменении(Элемент)
	
	УстановитьВидимостьДоступность();
	КоличествоСпецРаботы4 = Неопределено;
	
КонецПроцедуры

&НаКлиенте
Процедура СпецРабота5ПриИзменении(Элемент)
	
	УстановитьВидимостьДоступность();
	КоличествоСпецРаботы5 = Неопределено;
	
КонецПроцедуры

&НаКлиенте
Процедура КоличествоСпецРаботы1ПриИзменении(Элемент)
	
	Если ЭтоВременнаяСпецРабота(СпецРабота1) Тогда 
		уатЗащищенныеФункцииСервер.КонтрольВводаВремени(КоличествоСпецРаботы1);
	КонецЕсли;
	
КонецПроцедуры

&НаКлиенте
Процедура КоличествоСпецРаботы2ПриИзменении(Элемент)
	
	Если ЭтоВременнаяСпецРабота(СпецРабота2) Тогда 
		уатЗащищенныеФункцииСервер.КонтрольВводаВремени(КоличествоСпецРаботы2);
	КонецЕсли;
	
КонецПроцедуры

&НаКлиенте
Процедура КоличествоСпецРаботы3ПриИзменении(Элемент)
	
	Если ЭтоВременнаяСпецРабота(СпецРабота3) Тогда 
		уатЗащищенныеФункцииСервер.КонтрольВводаВремени(КоличествоСпецРаботы3);
	КонецЕсли;
	
КонецПроцедуры

&НаКлиенте
Процедура КоличествоСпецРаботы4ПриИзменении(Элемент)
	
	Если ЭтоВременнаяСпецРабота(СпецРабота4) Тогда 
		уатЗащищенныеФункцииСервер.КонтрольВводаВремени(КоличествоСпецРаботы4);
	КонецЕсли;
	
КонецПроцедуры

&НаКлиенте
Процедура КоличествоСпецРаботы5ПриИзменении(Элемент)
	
	Если ЭтоВременнаяСпецРабота(СпецРабота5) Тогда 
		уатЗащищенныеФункцииСервер.КонтрольВводаВремени(КоличествоСпецРаботы5);
	КонецЕсли;
	
КонецПроцедуры

#КонецОбласти

#Область ОбработчикиКомандФормы

&НаКлиенте
Процедура ЗаписатьДанные(Команда)
	
	Если Не ДанныеУказаныВерно() Тогда 
		Возврат;
	КонецЕсли;
	
	ПараметрыЗакрытия = Новый Структура();
	ПараметрыЗакрытия.Вставить("СпецРабота1", СпецРабота1);
	ПараметрыЗакрытия.Вставить("СпецРабота2", СпецРабота2);
	ПараметрыЗакрытия.Вставить("СпецРабота3", СпецРабота3);
	ПараметрыЗакрытия.Вставить("СпецРабота4", СпецРабота4);
	ПараметрыЗакрытия.Вставить("СпецРабота5", СпецРабота5);
	ПараметрыЗакрытия.Вставить("КоличествоСпецРаботы1", ?(ЭтоВременнаяСпецРабота(СпецРабота1), уатОбщегоНазначения.уатВремяВСекунды(КоличествоСпецРаботы1), КоличествоСпецРаботы1));
	ПараметрыЗакрытия.Вставить("КоличествоСпецРаботы2", ?(ЭтоВременнаяСпецРабота(СпецРабота2), уатОбщегоНазначения.уатВремяВСекунды(КоличествоСпецРаботы2), КоличествоСпецРаботы2));
	ПараметрыЗакрытия.Вставить("КоличествоСпецРаботы3", ?(ЭтоВременнаяСпецРабота(СпецРабота3), уатОбщегоНазначения.уатВремяВСекунды(КоличествоСпецРаботы3), КоличествоСпецРаботы3));
	ПараметрыЗакрытия.Вставить("КоличествоСпецРаботы4", ?(ЭтоВременнаяСпецРабота(СпецРабота4), уатОбщегоНазначения.уатВремяВСекунды(КоличествоСпецРаботы4), КоличествоСпецРаботы4));
	ПараметрыЗакрытия.Вставить("КоличествоСпецРаботы5", ?(ЭтоВременнаяСпецРабота(СпецРабота5), уатОбщегоНазначения.уатВремяВСекунды(КоличествоСпецРаботы5), КоличествоСпецРаботы5));
	
	Закрыть(ПараметрыЗакрытия);
	
КонецПроцедуры

#КонецОбласти

#Область СлужебныеПроцедурыИФункции

&НаСервере
Процедура УстановитьВидимостьДоступность()
	
	Для Сч = 1 По 5 Цикл 
		СпецРабота = ЭтотОбъект["СпецРабота" + Формат(Сч, "ЧГ=0")];
		Элементы["КоличествоСпецРаботы" + Формат(Сч, "ЧГ=0")].Заголовок = "Количество спец. работы" + " " + Формат(Сч, "ЧГ=0");
		
		Если СпецРабота.Временный Тогда 
			Элементы["КоличествоСпецРаботы" + Формат(Сч, "ЧГ=0")].ФорматРедактирования = "ЧДЦ=2; ЧРД=:; ЧГ=";
		Иначе 
			Элементы["КоличествоСпецРаботы" + Формат(Сч, "ЧГ=0")].ФорматРедактирования = "ЧЦ=7; ЧДЦ=1";
		КонецЕсли;
	КонецЦикла;
	
КонецПроцедуры

&НаСервереБезКонтекста
Функция ЭтоВременнаяСпецРабота(Знач СпецРабота)
	
	Возврат СпецРабота.Временный;
	
КонецФункции // ЭтоВременнаяСпецРабота()

&НаСервере
Функция ДанныеУказаныВерно()
	
	Отказ = Ложь;
	
	Для СчВнешний = 1 По 5 Цикл 
		Если ЗначениеЗаполнено(ЭтотОбъект["СпецРабота"+Формат(СчВнешний, "ЧГ=0")]) И Не ЗначениеЗаполнено(ЭтотОбъект["КоличествоСпецРаботы"+Формат(СчВнешний, "ЧГ=0")]) Тогда 
			ТекстОшибки = "Не указано количество специальной работы " + Формат(СчВнешний, "ЧГ=0");
			ОбщегоНазначенияКлиентСервер.СообщитьПользователю(ТекстОшибки,, "КоличествоСпецРаботы"+Формат(СчВнешний, "ЧГ=0"),, Отказ);
		КонецЕсли;
		Если Не ЗначениеЗаполнено(ЭтотОбъект["СпецРабота"+Формат(СчВнешний, "ЧГ=0")]) И ЗначениеЗаполнено(ЭтотОбъект["КоличествоСпецРаботы"+Формат(СчВнешний, "ЧГ=0")]) Тогда 
			ТекстОшибки = "Не указана специальная работа " + Формат(СчВнешний, "ЧГ=0");
			ОбщегоНазначенияКлиентСервер.СообщитьПользователю(ТекстОшибки,, "СпецРабота"+Формат(СчВнешний, "ЧГ=0"),, Отказ);
		КонецЕсли;
		
		Для СчВнутр = СчВнешний+1 По 5 Цикл 
			Если ЗначениеЗаполнено(ЭтотОбъект["СпецРабота"+Формат(СчВнешний, "ЧГ=0")]) И ЭтотОбъект["СпецРабота"+Формат(СчВнешний, "ЧГ=0")] = ЭтотОбъект["СпецРабота"+Формат(СчВнутр, "ЧГ=0")] Тогда 
				ТекстОшибки = "Данная специальная работа уже была указана ранее.";
				ОбщегоНазначенияКлиентСервер.СообщитьПользователю(ТекстОшибки,, "СпецРабота"+Формат(СчВнутр, "ЧГ=0"),, Отказ);
			КонецЕсли;
		КонецЦикла;
	КонецЦикла;
	
	Возврат Не Отказ;
	
КонецФункции

#КонецОбласти
