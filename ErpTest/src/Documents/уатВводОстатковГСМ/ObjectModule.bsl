
////////////////////////////////////////////////////////////////////////////////
// ОБРАБОТЧИКИ СОБЫТИЙ

Процедура ОбработкаПроведения(Отказ, Режим)
	// Инициализация дополнительных свойств для проведения документа.
    уатПроведение.ИнициализироватьДополнительныеСвойстваДляПроведения(Ссылка, ДополнительныеСвойства);
    
    // Инициализация данных документа.
    Документы.уатВводОстатковГСМ.ИнициализироватьДанныеДокумента(Ссылка, ДополнительныеСвойства);
    
    // Подготовка наборов записей.
    уатПроведение.ПодготовитьНаборыЗаписейКРегистрацииДвижений(ЭтотОбъект);
    
    // Отражение в разделах учета.
    уатПроведение.ОтразитьОстаткиГСМНаТС(ДополнительныеСвойства, Движения, Отказ);

    // Запись наборов записей.
    уатПроведение.ЗаписатьНаборыЗаписей(ЭтотОбъект);
    
    // Контроль возникновения отрицательного остатка.
    Документы.уатВводОстатковГСМ.ВыполнитьКонтроль(Ссылка, ДополнительныеСвойства, Отказ);
КонецПроцедуры

Процедура ОбработкаПроверкиЗаполнения(Отказ, ПроверяемыеРеквизиты)
	Если ОбменДанными.Загрузка Тогда
		Возврат;
	КонецЕсли;
	
	Если (НЕ Отказ) Тогда
		// Заголовок для сообщений об ошибках проведения.
		Заголовок = уатОбщегоНазначенияТиповые.уатПредставлениеДокументаПриПроведении(ЭтотОбъект);
		СтруктураПолей = Новый Структура("Организация");
		уатОбщегоНазначенияТиповые.уатПроверитьЗаполнениеШапкиДокумента(ЭтотОбъект, СтруктураПолей, Отказ, Заголовок);
		
		СтруктураПолей = Новый Структура("ТС, ГСМ, Количество");
		уатОбщегоНазначенияТиповые.уатПроверитьЗаполнениеТабличнойЧасти(ЭтотОбъект, "Топливо", СтруктураПолей, Отказ,
																		Заголовок);
		
		//проверка по наличию бака в ТС
		Если Не Отказ Тогда
			Для Каждого СтрокаТаблицы Из Топливо Цикл
				ТекМодельТС = СтрокаТаблицы.ТС.уатМодель;
				Если НЕ ТекМодельТС.НаличиеТопливногоБака Тогда
					уатОбщегоНазначенияТиповые.СообщитьОбОшибке("В строке номер """ + СтрокаТаблицы.НомерСтроки + """ табличной 
													|части ""Топливо"": указано ТС / Оборудование, у которого отсутствует топливный бак!", Отказ, Заголовок);
				КонецЕсли;
			КонецЦикла;
		КонецЕсли;
	КонецЕсли;
КонецПроцедуры

Процедура ОбработкаУдаленияПроведения(Отказ)
	// Инициализация дополнительных свойств для проведения документа
	уатПроведение.ИнициализироватьДополнительныеСвойстваДляПроведения(Ссылка, ДополнительныеСвойства);
	
	// Подготовка наборов записей
	уатПроведение.ПодготовитьНаборыЗаписейКРегистрацииДвижений(ЭтотОбъект);
	
	// Запись наборов записей
	уатПроведение.ЗаписатьНаборыЗаписей(ЭтотОбъект);

	// Контроль
	Документы.уатВводОстатковГСМ.ВыполнитьКонтроль(Ссылка, ДополнительныеСвойства, Отказ, Истина);
КонецПроцедуры

Процедура ОбработкаЗаполнения(ДанныеЗаполнения, СтандартнаяОбработка)
	
	Если ТипЗнч(ДанныеЗаполнения) = Тип("ДокументСсылка.уатИнвентаризацияГСМвТС") Тогда
		СтандартнаяОбработка = Ложь;
		
		уатОбщегоНазначенияТиповые.ЗаполнитьШапкуДокумента(ЭтотОбъект, ПользователиКлиентСервер.ТекущийПользователь());
		
		ДокументОснование = ДанныеЗаполнения;
		Организация       = ДанныеЗаполнения.Организация;
		Ответственный     = ДанныеЗаполнения.Ответственный;
		Дата              = ДанныеЗаполнения.Дата;
		
		Запрос = Новый Запрос;
		Запрос.УстановитьПараметр("ДокументСсылка",          Ссылка);
		Запрос.УстановитьПараметр("ДокументОснованиеСсылка", ДанныеЗаполнения);
		
		Запрос.Текст = 
		"ВЫБРАТЬ
		|	уатИнвентаризацияГСМвТСГСМвТС.ТС,
		|	уатИнвентаризацияГСМвТСГСМвТС.ГСМ,
		|	МАКСИМУМ(уатИнвентаризацияГСМвТСГСМвТС.Количество - уатИнвентаризацияГСМвТСГСМвТС.КоличествоУчет) КАК КоличествоОтклонениеИнвентаризации,
		|	уатИнвентаризацияГСМвТСГСМвТС.Цена,
		|	СУММА(ВЫБОР
		|			КОГДА уатВводОстатковГСМТопливо.Количество ЕСТЬ NULL 
		|				ТОГДА 0
		|			ИНАЧЕ уатВводОстатковГСМТопливо.Количество
		|		КОНЕЦ) КАК КоличествоОприходованное
		|ИЗ
		|	Документ.уатИнвентаризацияГСМвТС.ГСМвТС КАК уатИнвентаризацияГСМвТСГСМвТС
		|		ЛЕВОЕ СОЕДИНЕНИЕ Документ.уатВводОстатковГСМ.Топливо КАК уатВводОстатковГСМТопливо
		|		ПО уатИнвентаризацияГСМвТСГСМвТС.ГСМ = уатВводОстатковГСМТопливо.ГСМ
		|			И уатИнвентаризацияГСМвТСГСМвТС.ТС = уатВводОстатковГСМТопливо.ТС
		|			И (уатВводОстатковГСМТопливо.Ссылка.ДокументОснование = &ДокументОснованиеСсылка)
		|			И (уатВводОстатковГСМТопливо.Ссылка.Проведен)
		|			И (уатВводОстатковГСМТопливо.Ссылка <> &ДокументСсылка)
		|ГДЕ
		|	уатИнвентаризацияГСМвТСГСМвТС.Ссылка = &ДокументОснованиеСсылка
		|	И уатИнвентаризацияГСМвТСГСМвТС.Количество - уатИнвентаризацияГСМвТСГСМвТС.КоличествоУчет > 0
		|
		|СГРУППИРОВАТЬ ПО
		|	уатИнвентаризацияГСМвТСГСМвТС.НомерСтроки,
		|	уатИнвентаризацияГСМвТСГСМвТС.ТС,
		|	уатИнвентаризацияГСМвТСГСМвТС.ГСМ,
		|	уатИнвентаризацияГСМвТСГСМвТС.Цена
		|
		|УПОРЯДОЧИТЬ ПО
		|	уатИнвентаризацияГСМвТСГСМвТС.НомерСтроки";
		
		Выборка = Запрос.Выполнить().Выбрать();
		
		Пока Выборка.Следующий() Цикл 
			КоличествоОприходовать = Выборка.КоличествоОтклонениеИнвентаризации - Выборка.КоличествоОприходованное;
			
			Если КоличествоОприходовать <= 0 Тогда
				Продолжить;
			КонецЕсли; 
			
			НовСтрока = Топливо.Добавить();
			НовСтрока.ТС         = Выборка.ТС;
			НовСтрока.ГСМ        = Выборка.ГСМ;
			НовСтрока.Количество = КоличествоОприходовать;
			НовСтрока.Сумма      = Окр(Выборка.Цена * КоличествоОприходовать, 2, РежимОкругления.Окр15как20);
		КонецЦикла;
		
		Если Топливо.Количество() = 0 Тогда
			ТекстСообщения = СтроковыеФункцииКлиентСервер.ПодставитьПараметрыВСтроку(
					НСтр("ru = 'В документе ""%1 № %2"" отсутствуют ТС с ГСМ, фактическое количество которого превышает учетное.'"), 
					ДанныеЗаполнения.Метаданные().Представление(),
					ДанныеЗаполнения.Номер);
			ОбщегоНазначенияКлиентСервер.СообщитьПользователю(ТекстСообщения,,"Объект");
		КонецЕсли;
	КонецЕсли;
	
КонецПроцедуры
