Процедура СформироватьЗаписиПоДокументупкПретензия(Отказ, РежимПроведения, тИсточник)
	
	НаборЗаписей  = тИсточник.Движения.пкПретензииПоСчетам;
	НаборЗаписей.Записывать = Истина;
	Если ТипЗнч(тИсточник) = Тип("ДокументОбъект.пкПретензия") Тогда
		ТаблицаСчетов=тИсточник.Расшифровка.Выгрузить();
	Иначе
		ТаблицаСчетов=тИсточник.ПогашениеДолга.Выгрузить();
		ДатаПоследнегоСобытия=Дата(1,1,1);
		ПоследнееСобытие=Перечисления.пкСобытияСудебныхИсков.ПустаяСсылка();
		Если тИсточник.Расшифровка.Количество()>0 Тогда
			ТаблицаСобытий=тИсточник.Расшифровка.Выгрузить();
			ТаблицаСобытий.Сортировать("ДатаСобытия Убыв");
			ПоследнееСобытие=ТаблицаСобытий[0].Событие;	
			ДатаПоследнегоСобытия=ТаблицаСобытий[0].ДатаСобытия;
		КонецЕсли; 
	КонецЕсли; 
	ТаблицаСчетов.Свернуть("Счет");
	Для Каждого текСтрока Из ТаблицаСчетов Цикл
	
		НоваяЗапись = НаборЗаписей.Добавить();
		НоваяЗапись.Регистратор					= тИсточник.Ссылка;
		НоваяЗапись.Период						= тИсточник.Дата;
		
		НоваяЗапись.Счет					= текСтрока.Счет;
		Если ТипЗнч(тИсточник) = Тип("ДокументОбъект.пкПретензия") Тогда
			НоваяЗапись.Состояние				= Перечисления.пкСостоянияПретензийПоСчетам.Претензия;
		Иначе
			НоваяЗапись.Состояние				= Перечисления.пкСостоянияПретензийПоСчетам.СудебныйИск;
			НоваяЗапись.СтатусИска              = тИсточник.Статус;
			НоваяЗапись.ПоследнееСобытие        = ПоследнееСобытие;
			НоваяЗапись.ДатаПоследнегоСобытия   = ДатаПоследнегоСобытия;

		КонецЕсли;

	КонецЦикла;
	
	Попытка
		НаборЗаписей.Записать(Истина);
	Исключение
		Отказ = Истина;
		тСообщение = Новый СообщениеПользователю;
		тСообщение.Текст = ОписаниеОшибки();
		тСообщение.Сообщить();
	КонецПопытки;
	
КонецПроцедуры

Процедура СформироватьЗаписи(Отказ, РежимПроведения, тИсточник) Экспорт
	
	Если Отказ Тогда
		Возврат;
	КонецЕсли;
	
	МассивИсточников = Новый Массив;
	
	Если ТипЗнч(тИсточник) = Тип("Массив") Тогда
		МассивИсточников = тИсточник;
	Иначе
		МассивИсточников.Добавить(тИсточник);
	КонецЕсли;
	
	Для Каждого ЭлементИсточник из МассивИсточников Цикл
		
		//Если ТипЗнч(ЭлементИсточник) = Тип("ДокументОбъект.пкПретензия") или ТипЗнч(ЭлементИсточник) Тогда
			СформироватьЗаписиПоДокументупкПретензия(Отказ, РежимПроведения, ЭлементИсточник);
		//КонецЕсли;
		
	КонецЦикла;
		
КонецПроцедуры
