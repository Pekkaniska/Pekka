
Процедура СформироватьЗаписиПоДокументуЗаказКлиента(Источник, Отказ, РежимПроведения)
    
	Если Источник.Договор.пкВидДоговора <> Перечисления.пкВидыДоговоров.АрендаТехники Тогда
		Возврат;
	КонецЕсли;
	
    НаборЗаписей = Источник.Движения.пкОформлениеАрендыТехники;
    НаборЗаписей.Записывать = Истина;
    
	Для Каждого текСтрока Из Источник.Товары Цикл
		
		Если Не ЗначениеЗаполнено(текСтрока.пкТехника) Тогда
			Продолжить;
		КонецЕсли;
		
		Если Не ЗначениеЗаполнено(текСтрока.пкЗаявкаНаАрендуТехники) Тогда
			Продолжить;
		КонецЕсли;
		
		НоваяЗапись = НаборЗаписей.Добавить();
        НоваяЗапись.Период					= НачалоДня(текСтрока.пкДатаНачалаАренды); 
		НоваяЗапись.ТипДокумента			= Перечисления.пкТипыДокументовДляСроковАренды.ЗаказКлиента;
        НоваяЗапись.ЭтоОкончаниеАренды		= Ложь;
		НоваяЗапись.ЗаявкаНаАрендуТехники	= текСтрока.пкЗаявкаНаАрендуТехники;
		НоваяЗапись.Техника					= текСтрока.пкТехника;
		НоваяЗапись.ЗаказКлиента			= Источник.Ссылка;
                
		НоваяЗапись = НаборЗаписей.Добавить();
        НоваяЗапись.Период					= КонецДня(текСтрока.пкДатаОкончанияАренды); 
		НоваяЗапись.ТипДокумента			= Перечисления.пкТипыДокументовДляСроковАренды.ЗаказКлиента;
        НоваяЗапись.ЭтоОкончаниеАренды		= Истина;
		НоваяЗапись.ЗаявкаНаАрендуТехники	= текСтрока.пкЗаявкаНаАрендуТехники;
		НоваяЗапись.Техника					= текСтрока.пкТехника;
		НоваяЗапись.ЗаказКлиента			= Источник.Ссылка;
                
	КонецЦикла;    
        
    Попытка
        НаборЗаписей.Записать(Истина);
    Исключение
		Отказ = Истина;
		Сообщение = Новый СообщениеПользователю;
		Сообщение.Текст = ОписаниеОшибки();
		Сообщение.Сообщить();
    КонецПопытки;
    
КонецПроцедуры    

Процедура СформироватьЗаписиПоДокументуРеализацияТоваровУслуг(Источник, Отказ, РежимПроведения)
    
	Если Источник.Договор.пкВидДоговора <> Перечисления.пкВидыДоговоров.АрендаТехники Тогда
		Возврат;
	КонецЕсли;
	
    НаборЗаписей = Источник.Движения.пкОформлениеАрендыТехники;
    НаборЗаписей.Записывать = Истина;
    
	Для Каждого текСтрока Из Источник.Товары Цикл
		
		Если Не ЗначениеЗаполнено(текСтрока.пкТехника) Тогда
			Продолжить;
		КонецЕсли;
		
		Если Не ЗначениеЗаполнено(текСтрока.пкЗаявкаНаАрендуТехники) Тогда
			Продолжить;
		КонецЕсли;
		
		Если (Не ЗначениеЗаполнено(текСтрока.ЗаказКлиента)) И (Не ЗначениеЗаполнено(Источник.ЗаказКлиента)) Тогда
			Продолжить;
		КонецЕсли;
		
		НоваяЗапись = НаборЗаписей.Добавить();
        НоваяЗапись.Период					= НачалоДня(текСтрока.пкДатаНачалаАренды); 
		НоваяЗапись.ТипДокумента			= Перечисления.пкТипыДокументовДляСроковАренды.РеализацияТоваровУслуг;
        НоваяЗапись.ЭтоОкончаниеАренды		= Ложь;
		НоваяЗапись.ЗаявкаНаАрендуТехники	= текСтрока.пкЗаявкаНаАрендуТехники;
		НоваяЗапись.Техника					= текСтрока.пкТехника;
		НоваяЗапись.ЗаказКлиента			= ?(ЗначениеЗаполнено(текСтрока.ЗаказКлиента), текСтрока.ЗаказКлиента, Источник.ЗаказКлиента);
		НоваяЗапись.Реализация				= Источник.Ссылка;
                
		НоваяЗапись = НаборЗаписей.Добавить();
		НоваяЗапись.ТипДокумента			= Перечисления.пкТипыДокументовДляСроковАренды.РеализацияТоваровУслуг;
        НоваяЗапись.Период					= КонецДня(текСтрока.пкДатаОкончанияАренды); 
        НоваяЗапись.ЭтоОкончаниеАренды		= Истина;
		НоваяЗапись.ЗаявкаНаАрендуТехники	= текСтрока.пкЗаявкаНаАрендуТехники;
		НоваяЗапись.Техника					= текСтрока.пкТехника;
		НоваяЗапись.ЗаказКлиента			= ?(ЗначениеЗаполнено(текСтрока.ЗаказКлиента), текСтрока.ЗаказКлиента, Источник.ЗаказКлиента);
		НоваяЗапись.Реализация				= Источник.Ссылка;
                
	КонецЦикла;    
        
    Попытка
        НаборЗаписей.Записать(Истина);
    Исключение
		Отказ = Истина;
		Сообщение = Новый СообщениеПользователю;
		Сообщение.Текст = ОписаниеОшибки();
		Сообщение.Сообщить();
    КонецПопытки;
    
КонецПроцедуры    

Процедура СформироватьЗаписи(Источник, Отказ, РежимПроведения) Экспорт
	
	Если Отказ Тогда
		Возврат;
	КонецЕсли;
	
	МассивИсточников = Новый Массив;
	
	Если ТипЗнч(Источник) = Тип("Массив") Тогда
		МассивИсточников = Источник;
	Иначе
		МассивИсточников.Добавить(Источник);
	КонецЕсли;
	
	Для Каждого ЭлементИсточник из МассивИсточников Цикл
		Если ТипЗнч(ЭлементИсточник) = Тип("ДокументОбъект.ЗаказКлиента") Тогда
			СформироватьЗаписиПоДокументуЗаказКлиента(ЭлементИсточник, Отказ, РежимПроведения);
        ИначеЕсли ТипЗнч(ЭлементИсточник) = Тип("ДокументОбъект.РеализацияТоваровУслуг") Тогда
            СформироватьЗаписиПоДокументуРеализацияТоваровУслуг(ЭлементИсточник, Отказ, РежимПроведения);  
		КонецЕсли;
	КонецЦикла;
		
КонецПроцедуры
